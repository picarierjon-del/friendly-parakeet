<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>COMMANDER √âLITE V12 - TOTAL CONTROL</title>
  <style>
    :root {
      --bg: #020617; --surface: #0f172a; --surface-alt: #1e293b;
      --accent: #38bdf8; --text: #f8fafc; --text-dim: #94a3b8;
      --success: #22c55e; --danger: #ef4444; --border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 50px; }
    .app { max-width: 1400px; margin: 0 auto; padding: 1rem; display: grid; gap: 1rem; }
    @media (min-width: 1024px) { .app { grid-template-columns: 1fr 1.2fr; } }

    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .card-h { padding: 1rem; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-weight: 800; display: flex; justify-content: space-between; }
    
    textarea { width: 100%; min-height: 200px; background: #000; color: #10b981; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: monospace; outline: none; }
    
    .btn { padding: 0.7rem 1rem; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
    .btn-main { background: var(--accent); color: #000; }
    .btn-sec { background: var(--surface-alt); color: white; }
    .btn-danger { background: var(--danger); color: white; }

    /* Output per Stampante 80mm */
    .output-box { background: #fff; color: #000; padding: 10mm; font-family: 'Courier New', monospace; font-size: 14px; border: 1px solid #ddd; width: 80mm; margin: 0 auto; line-height: 1.2; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    
    /* Modal / Editor Styles */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; z-index: 1000; padding: 1rem; overflow-y: auto; }
    .modal.open { display: flex; justify-content: center; }
    .modal-sheet { background: var(--surface); width: 100%; max-width: 900px; height: fit-content; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin: 2rem 0; }

    .order-row { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .row-main { display: grid; grid-template-columns: 60px 1fr 100px 40px; gap: 10px; margin-bottom: 10px; }
    .row-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    
    select, input { background: #000; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; font-size: 13px; }
    label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; display: block; margin-bottom: 3px; }

    @media print { 
      .no-print { display: none !important; } 
      body { background: white; }
      .output-box { border: none; box-shadow: none; width: 80mm; margin: 0; padding: 5mm; }
      @page { size: 80mm auto; margin: 0; }
    }
  </style>
</head>
<body>

<div class="app">
  <header class="no-print">
    <div>
      <div style="font-weight: 900; font-size: 1.6rem; color: var(--accent);">COMMANDER √âLITE <span style="color:white; font-weight:300">V12</span></div>
      <div id="clock" style="font-size: 12px; color: var(--text-dim);">...</div>
    </div>
    <div style="display: flex; gap: 8px;">
      <button class="btn btn-sec" onclick="App.openSettings()">‚öôÔ∏è MENU</button>
      <button class="btn btn-danger" onclick="App.nightClosure()">üåô CHIUSURA SERALE</button>
    </div>
  </header>

  <div class="card no-print">
    <div class="card-h">üì• WHATSAPP INPUT</div>
    <div class="card-b">
      <textarea id="raw-input" placeholder="Incolla qui l'ordine..."></textarea>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1rem;">
        <button class="btn btn-main" onclick="App.process()">‚ö° ANALISI INTELLIGENTE</button>
        <button class="btn btn-sec" onclick="App.openEditor()">‚úèÔ∏è GESTIONALE AVANZATO</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-h no-print">
      <span>üñ®Ô∏è ANTEPRIMA 80mm</span>
      <button class="btn btn-main" onclick="window.print()">STAMPA IPHONE</button>
    </div>
    <div class="card-b" style="background: #111; overflow-x: auto;">
      <div id="output" class="output-box">In attesa...</div>
    </div>
  </div>
</div>

<div id="modal-editor" class="modal no-print">
  <div class="modal-sheet">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <h2 style="margin:0;">‚úèÔ∏è Gestionale Ordine</h2>
        <button class="btn btn-sec" onclick="App.closeModals()">Chiudi</button>
    </div>
    
    <div class="row-options" style="margin-bottom:20px; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
      <div><label>Cliente</label><input type="text" id="edt-customer" style="width:100%"></div>
      <div><label>Orario</label><input type="text" id="edt-time" style="width:100%"></div>
      <div><label>Indirizzo/Note</label><input type="text" id="edt-address" style="width:100%"></div>
    </div>

    <div id="edt-items-list"></div>
    
    <button class="btn btn-sec" style="width:100%; margin-top:10px;" onclick="App.addOrderItem()">‚ûï AGGIUNGI PIZZA</button>

    <div style="margin-top:20px; padding:20px; background:var(--surface-alt); border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:900; font-size:1.2rem;">TOTALE: <span id="edt-total" style="color:var(--success)">‚Ç¨ 0.00</span></div>
        <button class="btn btn-main" onclick="App.saveOrderEdits()">üöÄ CONFERMA E GENERA COMANDA</button>
    </div>
  </div>
</div>

<div id="modal-settings" class="modal no-print">
  <div class="modal-sheet">
    <h2>‚öôÔ∏è Configurazione Catalogo</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div>
        <h3>Pizze <button class="btn" style="padding:2px 8px; font-size:12px" onclick="App.addCatalogItem('pizzas')">+</button></h3>
        <div id="cfg-pizzas"></div>
      </div>
      <div>
        <h3>Impasti <button class="btn" style="padding:2px 8px; font-size:12px" onclick="App.addCatalogItem('variations')">+</button></h3>
        <div id="cfg-variations"></div>
        <h3>Extra <button class="btn" style="padding:2px 8px; font-size:12px" onclick="App.addCatalogItem('extras')">+</button></h3>
        <div id="cfg-extras"></div>
      </div>
    </div>
    <button class="btn btn-main" style="width:100%; margin-top:2rem;" onclick="App.saveSettings()">üíæ SALVA CONFIGURAZIONE</button>
  </div>
</div>

<script>
const App = {
  config: {
    pizzas: { "margherita": 6.5, "diavola": 8.0, "capricciosa": 9.5, "quattro stagioni": 9.5, "napoli": 7.5 },
    variations: { "normale": 0, "integrale": 1.5, "verace": 2.0, "senza glutine": 3.0, "mezzo metro": 15.0, "grande": 2.5 },
    extras: { "nessuno": 0, "bufala": 2.0, "speck": 1.5, "brie": 1.5, "crudo": 2.5, "porcini": 2.0, "cipolla": 0.5 },
    deliveryFee: 2.0,
    history: []
  },
  
  order: null,

  init() {
    const s = localStorage.getItem('commander_v12_cfg');
    if(s) this.config = JSON.parse(s);
    setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleString(), 1000);
  },

  process() {
    const raw = document.getElementById('raw-input').value;
    let o = { customer: "Cliente", time: "ASAP", address: "", items: [], total: 0, mode: "RITIRO" };
    const lines = raw.split('\n').map(l => l.trim().toLowerCase());
    
    lines.forEach(l => {
      if(l.match(/(\d{2}[:.]\d{2})/)) o.time = l.match(/(\d{2}[:.]\d{2})/)[0];
      if(l.includes("via") || l.includes("consegna")) { o.address = l; o.mode = "CONSEGNA"; }
      
      let qtyM = l.match(/^(\d+)/);
      if(qtyM) {
        let qty = parseInt(qtyM[1]);
        let text = l.replace(/^\d+/, "").trim();
        let baseName = "MARGHERITA";
        let basePrice = 6.5;

        for(let p in this.config.pizzas) {
          if(text.includes(p)) { baseName = p.toUpperCase(); basePrice = this.config.pizzas[p]; break; }
        }

        o.items.push({ 
          qty, 
          baseName, 
          price: basePrice, 
          impasto: "normale", 
          extra: "nessuno",
          note: text.includes("met√†") ? "DIVISA A MET√Ä" : "" 
        });
      }
    });

    this.order = o;
    this.render();
  },

  render() {
    if(!this.order) return;
    const o = this.order;
    let subtotal = 0;
    
    let h = `*** COMANDA PIZZERIA ***\n`;
    h += `--------------------------------\n`;
    h += `ORA: ${o.time} | ${o.mode}\n`;
    h += `CLI: ${o.customer.toUpperCase()}\n`;
    if(o.address) h += `IND: ${o.address.toUpperCase()}\n`;
    h += `--------------------------------\n`;

    o.items.forEach(it => {
      let rigaPrice = it.price + this.config.variations[it.impasto] + this.config.extras[it.extra];
      let rigaTotal = rigaPrice * it.qty;
      subtotal += rigaTotal;

      h += `${it.qty}x ${it.baseName}\n`;
      if(it.impasto !== "normale") h += `   [IMP: ${it.impasto.toUpperCase()}]\n`;
      if(it.extra !== "nessuno") h += `   [EXT: ${it.extra.toUpperCase()}]\n`;
      if(it.note) h += `   (${it.note})\n`;
      h += `               EUR ${rigaTotal.toFixed(2)}\n`;
    });

    h += `--------------------------------\n`;
    if(o.mode === "CONSEGNA") {
        subtotal += this.config.deliveryFee;
        h += `CONSEGNA:          EUR ${this.config.deliveryFee.toFixed(2)}\n`;
    }
    h += `TOTALE:            EUR ${subtotal.toFixed(2)}\n`;
    h += `--------------------------------\n\n\n\n`;

    this.order.total = subtotal;
    document.getElementById('output').textContent = h;
  },

  // --- EDITOR AVANZATO DI RIGA ---
  openEditor() {
    if(!this.order) return alert("Analizza prima un ordine!");
    const o = this.order;
    document.getElementById('edt-customer').value = o.customer;
    document.getElementById('edt-time').value = o.time;
    document.getElementById('edt-address').value = o.address;
    
    this.renderEditorItems();
    document.getElementById('modal-editor').classList.add('open');
  },

  renderEditorItems() {
    const container = document.getElementById('edt-items-list');
    container.innerHTML = this.order.items.map((it, idx) => `
      <div class="order-row">
        <div class="row-main">
          <div><label>Qt√†</label><input type="number" value="${it.qty}" onchange="App.order.items[${idx}].qty=parseInt(this.value); App.updateEditorTotal()"></div>
          <div><label>Pizza Base</label>
            <select onchange="App.order.items[${idx}].baseName=this.value; App.order.items[${idx}].price=App.config.pizzas[this.value.toLowerCase()]; App.updateEditorTotal()">
              ${Object.keys(this.config.pizzas).map(p => `<option value="${p.toUpperCase()}" ${it.baseName==p.toUpperCase()?'selected':''}>${p.toUpperCase()}</option>`).join('')}
            </select>
          </div>
          <div><label>Prezzo Base</label><input type="number" step="0.5" value="${it.price}" readonly></div>
          <button class="btn-danger" style="margin-top:15px; border-radius:5px;" onclick="App.removeOrderItem(${idx})">X</button>
        </div>
        <div class="row-options">
          <div><label>Impasto / Formato</label>
            <select onchange="App.order.items[${idx}].impasto=this.value; App.updateEditorTotal()">
              ${Object.keys(this.config.variations).map(v => `<option value="${v}" ${it.impasto==v?'selected':''}>${v.toUpperCase()} (+‚Ç¨${this.config.variations[v]})</option>`).join('')}
            </select>
          </div>
          <div><label>Aggiunta Extra</label>
            <select onchange="App.order.items[${idx}].extra=this.value; App.updateEditorTotal()">
              ${Object.keys(this.config.extras).map(e => `<option value="${e}" ${it.extra==e?'selected':''}>${e.toUpperCase()} (+‚Ç¨${this.config.extras[e]})</option>`).join('')}
            </select>
          </div>
          <div><label>Note / Met√†</label><input type="text" placeholder="es: met√† crudo" value="${it.note}" onchange="App.order.items[${idx}].note=this.value" style="width:100%"></div>
        </div>
      </div>
    `).join('');
    this.updateEditorTotal();
  },

  addOrderItem() {
    this.order.items.push({ qty: 1, baseName: "MARGHERITA", price: 6.5, impasto: "normale", extra: "nessuno", note: "" });
    this.renderEditorItems();
  },

  removeOrderItem(idx) {
    this.order.items.splice(idx, 1);
    this.renderEditorItems();
  },

  updateEditorTotal() {
    let sub = 0;
    this.order.items.forEach(it => {
        sub += (it.price + this.config.variations[it.impasto] + this.config.extras[it.extra]) * it.qty;
    });
    document.getElementById('edt-total').textContent = `‚Ç¨ ${sub.toFixed(2)}`;
  },

  saveOrderEdits() {
    this.order.customer = document.getElementById('edt-customer').value;
    this.order.time = document.getElementById('edt-time').value;
    this.order.address = document.getElementById('edt-address').value;
    this.closeModals();
    this.render();
  },

  // --- CATALOGO ---
  openSettings() {
    const list = (obj, id) => {
      document.getElementById(id).innerHTML = Object.entries(obj).map(([k,v]) => `
        <div style="display:flex; gap:5px; margin-bottom:5px;">
          <input type="text" value="${k}" readonly style="flex:1">
          <input type="number" value="${v}" onchange="App.config.${id.split('-')[1]}['${k}']=parseFloat(this.value)" style="width:60px">
          <button class="btn-danger" style="padding:0 8px" onclick="delete App.config.${id.split('-')[1]}['${k}']; App.openSettings()">X</button>
        </div>
      `).join('');
    };
    list(this.config.pizzas, 'cfg-pizzas');
    list(this.config.variations, 'cfg-variations');
    list(this.config.extras, 'cfg-extras');
    document.getElementById('modal-settings').classList.add('open');
  },

  addCatalogItem(type) {
    const n = prompt("Nome:");
    if(n) { this.config[type][n.toLowerCase()] = 0; this.openSettings(); }
  },

  saveSettings() {
    localStorage.setItem('commander_v12_cfg', JSON.stringify(this.config));
    this.closeModals();
  },

  nightClosure() {
    if(confirm("Eseguire chiusura e reset?")) {
        // Qui si potrebbe implementare il salvataggio in un archivio storico
        this.order = null;
        document.getElementById('raw-input').value = "";
        document.getElementById('output').textContent = "Pronto...";
        alert("Giornata chiusa con successo!");
    }
  },

  closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('open')); }
};

App.init();
</script>
</body>
</html>
