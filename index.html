<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>LEGEND GEST ‚Üí Comande V9</title>
  <style>
    :root {
      --bg: #070a13; --surface: #111827; --surface-alt: #1f2937;
      --accent: #8b5cf6; --accent-hover: #7c3aed;
      --text: #f9fafb; --text-dim: #9ca3af;
      --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --border: rgba(255,255,255,0.08); --radius: 14px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; font-family: 'Inter', system-ui, sans-serif; 
      background: var(--bg); color: var(--text); background-attachment: fixed;
    }
    .app { max-width: 1200px; margin: 0 auto; padding: 1rem; display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 1024px) { .app { grid-template-columns: 480px 1fr; } }

    /* UI Components */
    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; height: fit-content; }
    .card-h { padding: 1rem; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-weight: 800; display: flex; justify-content: space-between; }
    .card-b { padding: 1.25rem; }

    textarea { width: 100%; min-height: 250px; background: #000; color: #34d399; border: 1px solid var(--border); border-radius: 10px; padding: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 14px; outline: none; transition: 0.3s; }
    textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }

    .btn { padding: 0.8rem 1.2rem; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .btn-main { background: var(--accent); color: white; width: 100%; justify-content: center; }
    .btn-main:hover { background: var(--accent-hover); transform: translateY(-2px); }
    .btn-sec { background: var(--surface-alt); color: var(--text); border: 1px solid var(--border); }

    /* Output Styling */
    .output-box { background: #000; border-radius: 12px; padding: 1.5rem; font-family: 'Courier New', Courier, monospace; color: #fff; line-height: 1.3; overflow-x: auto; min-height: 450px; border: 1px solid var(--border); white-space: pre-wrap; }
    .tab-group { display: flex; gap: 5px; background: #000; padding: 4px; border-radius: 8px; margin-bottom: 1rem; }
    .tab-btn { flex: 1; padding: 8px; border: none; background: transparent; color: var(--text-dim); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; }
    .tab-btn.active { background: var(--surface-alt); color: var(--accent); }

    /* Badge & Info */
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; background: var(--surface-alt); }
    .price-tag { color: var(--success); font-weight: 800; }

    /* Editor Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; z-index: 1000; padding: 1rem; }
    .modal.open { display: flex; align-items: center; justify-content: center; }
    .modal-sheet { background: var(--surface); width: 100%; max-width: 800px; max-height: 90vh; border-radius: 20px; overflow-y: auto; padding: 1.5rem; border: 1px solid var(--border); }

    .edit-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 1rem; }
    label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; display: block; }
    input, select { width: 100%; background: var(--bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; }

    @media print { .no-print { display: none !important; } .output-box { border: none; padding: 0; color: #000; background: #fff; } body { background: #fff; } }
  </style>
</head>
<body>

  <div class="app">
    <header class="no-print">
      <div>
        <div style="font-weight: 900; font-size: 1.4rem; color: var(--accent);">LEGEND GEST <span style="font-weight: 300; opacity: 0.5;">V9</span></div>
        <div id="live-clock" style="font-size: 12px; color: var(--text-dim);">Luned√¨, 16 Febbraio 2026</div>
      </div>
      <button class="btn btn-sec" onclick="App.toggleSettings()">‚öôÔ∏è Catalogo</button>
    </header>

    <div class="card no-print">
      <div class="card-h">ü§ñ PARSER INTELLIGENTE</div>
      <div class="card-b">
        <textarea id="raw-input" placeholder="Incolla l'ordine WhatsApp qui... (es. 1 margherita verace, 1 integrale...)"></textarea>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1rem;">
          <button class="btn btn-main" onclick="App.process()">‚ö° ELABORA</button>
          <button class="btn btn-sec" onclick="App.openEditor()">‚úèÔ∏è MODIFICA</button>
        </div>
        <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(139, 92, 246, 0.1); border-radius: 10px;">
          <div style="display: flex; justify-content: space-between; font-weight: 800;">
            <span>TOTALONE:</span>
            <span id="grand-total" class="price-tag">‚Ç¨ 0.00</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h no-print">
        <div class="tab-group">
          <button class="tab-btn active" onclick="App.setTab('kitchen', this)">CUCINA</button>
          <button class="tab-btn" onclick="App.setTab('receipt', this)">RICEVUTA</button>
        </div>
        <button class="btn btn-sec" style="padding: 5px 10px;" onclick="window.print()">üñ®Ô∏è STAMPA</button>
      </div>
      <div class="card-b">
        <div id="output" class="output-box">In attesa di ordini...</div>
      </div>
    </div>
  </div>

  <div id="editor-modal" class="modal no-print">
    <div class="modal-sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
        <h2 style="margin:0;">Rifinitura Ordine</h2>
        <button class="btn btn-sec" onclick="App.closeEditor()">‚ùå</button>
      </div>
      
      <div class="edit-row">
        <div><label>Cliente</label><input type="text" id="edt-customer"></div>
        <div><label>Telefono</label><input type="text" id="edt-phone"></div>
      </div>
      <div class="edit-row">
        <div><label>Indirizzo</label><input type="text" id="edt-address"></div>
        <div><label>Orario</label><input type="text" id="edt-time"></div>
      </div>
      <div class="edit-row">
        <div><label>Modalit√†</label>
          <select id="edt-mode">
            <option value="CONSEGNA">CONSEGNA</option>
            <option value="RITIRO">RITIRO</option>
          </select>
        </div>
        <div><label>Note Generali</label><input type="text" id="edt-notes" placeholder="es. tagliate"></div>
      </div>

      <div id="edt-items-container" style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
        </div>

      <button class="btn btn-main" style="margin-top: 1.5rem;" onclick="App.saveEdits()">üöÄ CONFERMA E GENERA</button>
    </div>
  </div>

<script>
/** * LEGEND ENGINE V9 
 * Gestione dinamica degli ordini complessi
 */

const App = {
  state: {
    order: null,
    currentTab: 'kitchen',
    catalog: {
      pizzas: { "margherita": 6.5, "capricciosa": 9.0, "diavola": 8.0, "salame piccante": 8.0, "salsiccia porcini e grana": 10.5, "profumo di langa": 11.0, "quella della suocera": 10.0 },
      impasti: { "integrale": 1.5, "verace": 2.0, "senza glutine": 3.0 },
      formati: { "normale": 0, "mezzo metro": 15.0, "schiacciata": 1.0, "grande": 2.5 },
      extras: { "speck": 1.5, "brie": 1.5, "porcini": 2.0, "grana": 1.0, "panna": 1.0, "gorgonzola": 1.5, "crudo di parma": 2.5, "cipolle": 0.5, "verdure grigliate": 2.0, "mozzarella senza lattosio": 1.5 },
      deliveryFee: 2.0
    }
  },

  init() {
    setInterval(() => {
      document.getElementById('live-clock').textContent = new Date().toLocaleString('it-IT', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
    }, 1000);
  },

  // --- PARSER LEGENDA ---
  process() {
    const raw = document.getElementById('raw-input').value;
    if (!raw.trim()) return;

    const lines = raw.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    let order = {
      customer: "Cliente Legend",
      phone: "",
      address: "",
      time: "ASAP",
      mode: "RITIRO",
      notes: "",
      items: []
    };

    lines.forEach(line => {
      const l = line.toLowerCase();

      // 1. Metadati (Orario, Indirizzo, Cliente)
      if (l.match(/(\d{2}[:.]\d{2})/)) order.time = l.match(/(\d{2}[:.]\d{2})/)[0];
      if (l.includes("via") || l.includes("indirizzo")) {
          order.address = line.replace(/indirizzo:?/i, "").trim();
          order.mode = "CONSEGNA";
      }
      if (l.match(/\b\d{9,10}\b/)) order.phone = l.match(/\b\d{9,10}\b/)[0];
      if (l.includes("nome:") || l.match(/^[A-Z]{2,}\s[A-Z]{2,}/)) order.customer = line.replace(/nome:?/i, "").trim();
      if (l.includes("tagliate") || l.includes("tagliata")) order.notes = "TAGLIATE";

      // 2. Parsing Articoli (Pizze e Gusti)
      let qtyMatch = line.match(/^(\d+)/);
      if (qtyMatch) {
        let qty = parseInt(qtyMatch[1]);
        let content = l.replace(/^\d+/, "").trim();

        // Rilevamento Formato / Impasto
        let formato = "normale";
        if (content.includes("mezzo metro")) formato = "mezzo metro";
        else if (content.includes("schiacciata")) formato = "schiacciata";
        else if (content.includes("grande")) formato = "grande";

        let impasto = "standard";
        for (let imp in this.state.catalog.impasti) {
          if (content.includes(imp)) impasto = imp;
        }

        // Rilevamento Gusti (Multi-gusto)
        let gusti = [];
        if (content.includes("met√†") || content.includes("gusto") || content.includes("gusti")) {
            // Logica semplificata: estrae nomi pizze conosciuti
            for (let p in this.state.catalog.pizzas) {
                if (content.includes(p)) gusti.push(p);
            }
        } else {
            for (let p in this.state.catalog.pizzas) {
                if (content.includes(p)) { gusti.push(p); break; }
            }
        }

        if (gusti.length > 0) {
          order.items.push({
            id: Date.now() + Math.random(),
            qty,
            name: gusti.join(" / "),
            formato,
            impasto,
            note: content.includes("senza") || content.includes("pi√π") ? content : "",
            basePrice: this.calculateItemPrice(gusti, formato, impasto, content)
          });
        }
      }
    });

    this.state.order = order;
    this.render();
  },

  calculateItemPrice(gusti, formato, impasto, rawContent) {
    let p = 0;
    // Media prezzi dei gusti
    gusti.forEach(g => p += (this.state.catalog.pizzas[g] || 7.0));
    p = p / gusti.length;

    // Aggiunte
    if (formato !== "normale") p += this.state.catalog.formati[formato];
    if (impasto !== "standard") p += this.state.catalog.impasti[impasto];
    
    // Check extra manuale
    for(let ex in this.state.catalog.extras) {
        if (rawContent.includes(ex)) p += this.state.catalog.extras[ex];
    }
    
    return p;
  },

  // --- UI & RENDER ---
  setTab(tab, el) {
    this.state.currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    el.classList.add('active');
    this.render();
  },

  render() {
    if (!this.state.order) return;
    const o = this.state.order;
    const out = document.getElementById('output');
    let h = "";

    const sep = "--------------------------------\n";
    const total = o.items.reduce((a, b) => a + (b.basePrice * b.qty), 0) + (o.mode === "CONSEGNA" ? this.state.catalog.deliveryFee : 0);
    document.getElementById('grand-total').textContent = `‚Ç¨ ${total.toFixed(2)}`;

    if (this.state.currentTab === 'kitchen') {
      h += `üî• COMANDA CUCINA üî•\n`;
      h += `ORA: ${o.time} | ${o.mode}\n`;
      h += `CLIENTE: ${o.customer}\n`;
      if(o.address) h += `VIA: ${o.address}\n`;
      if(o.notes) h += `!! NOTE: ${o.notes.toUpperCase()} !!\n`;
      h += sep;
      o.items.forEach(it => {
        h += `${it.qty}x ${it.name.toUpperCase()}\n`;
        if(it.impasto !== 'standard') h += `   [IMP: ${it.impasto.toUpperCase()}]\n`;
        if(it.formato !== 'normale') h += `   [FORMATO: ${it.formato.toUpperCase()}]\n`;
        if(it.note) h += `   ( ${it.note} )\n`;
      });
      h += sep;
      h += `TOTALE PIZZE: ${o.items.reduce((a,b)=>a+b.qty,0)}\n`;
    } else {
      h += `üßæ RICEVUTA CLIENTE üßæ\n`;
      h += `Orario: ${o.time}\n`;
      h += `Cliente: ${o.customer}\n`;
      h += sep;
      o.items.forEach(it => {
        h += `${it.qty} x ${it.name}\n`;
        h += `    ‚Ç¨ ${it.basePrice.toFixed(2)} cad. -> ‚Ç¨ ${(it.basePrice * it.qty).toFixed(2)}\n`;
      });
      if(o.mode === "CONSEGNA") h += `Costo Consegna: ‚Ç¨ ${this.state.catalog.deliveryFee.toFixed(2)}\n`;
      h += sep;
      h += `TOTALE DA PAGARE: ‚Ç¨ ${total.toFixed(2)}\n`;
      h += sep;
      h += `Grazie e buon appetito!`;
    }

    out.textContent = h;
  },

  // --- EDITOR ---
  openEditor() {
    if (!this.state.order) return alert("Inserisci prima un ordine!");
    const o = this.state.order;
    document.getElementById('edt-customer').value = o.customer;
    document.getElementById('edt-phone').value = o.phone;
    document.getElementById('edt-address').value = o.address;
    document.getElementById('edt-time').value = o.time;
    document.getElementById('edt-mode').value = o.mode;
    document.getElementById('edt-notes').value = o.notes;

    const container = document.getElementById('edt-items-container');
    container.innerHTML = o.items.map((it, idx) => `
      <div style="background:var(--surface-alt); padding:10px; border-radius:10px; margin-bottom:10px; display:grid; grid-template-columns: 50px 1fr 100px; gap:10px; align-items:center;">
        <input type="number" value="${it.qty}" onchange="App.state.order.items[${idx}].qty = parseInt(this.value)">
        <input type="text" value="${it.name}" onchange="App.state.order.items[${idx}].name = this.value">
        <div class="price-tag">‚Ç¨ ${it.basePrice.toFixed(2)}</div>
      </div>
    `).join('');

    document.getElementById('editor-modal').classList.add('open');
  },

  saveEdits() {
    const o = this.state.order;
    o.customer = document.getElementById('edt-customer').value;
    o.phone = document.getElementById('edt-phone').value;
    o.address = document.getElementById('edt-address').value;
    o.time = document.getElementById('edt-time').value;
    o.mode = document.getElementById('edt-mode').value;
    o.notes = document.getElementById('edt-notes').value;

    this.closeEditor();
    this.render();
  },

  closeEditor() { document.getElementById('editor-modal').classList.remove('open'); },
  toggleSettings() { alert("Funzione Catalogo: Modifica il codice sorgente nella sezione 'state.catalog' per aggiornare prezzi e prodotti."); }
};

App.init();
</script>
</body>
</html>
