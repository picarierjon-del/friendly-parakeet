<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>COMMANDER √âLITE V11</title>
  <style>
    :root {
      --bg: #020617; --surface: #0f172a; --surface-alt: #1e293b;
      --accent: #38bdf8; --text: #f8fafc; --text-dim: #94a3b8;
      --success: #22c55e; --danger: #ef4444; --border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 50px; }
    .app { max-width: 1400px; margin: 0 auto; padding: 1rem; display: grid; gap: 1rem; }
    @media (min-width: 1024px) { .app { grid-template-columns: 1fr 1.2fr; } }

    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .card-h { padding: 1rem; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-weight: 800; display: flex; justify-content: space-between; }
    
    textarea { width: 100%; min-height: 250px; background: #000; color: #10b981; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: monospace; outline: none; }
    
    .btn { padding: 0.7rem 1rem; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
    .btn-main { background: var(--accent); color: #000; }
    .btn-wa { background: #25D366; color: white; }
    .btn-sec { background: var(--surface-alt); color: white; }
    .btn-add { background: var(--success); color: white; padding: 4px 10px; font-size: 12px; }

    .output-box { background: #fff; color: #000; padding: 1.5rem; font-family: 'Courier New', monospace; font-size: 14px; border: 1px solid #ddd; width: 100%; max-width: 80mm; margin: 0 auto; line-height: 1.2; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; z-index: 1000; padding: 1rem; overflow-y: auto; }
    .modal.open { display: flex; justify-content: center; }
    .modal-sheet { background: var(--surface); width: 100%; max-width: 800px; height: fit-content; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); }

    .item-row { display: grid; grid-template-columns: 50px 1fr 80px 40px; gap: 8px; margin-bottom: 8px; align-items: center; }
    input { background: #000; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; }

    @media print { 
      .no-print { display: none !important; } 
      body { background: white; padding: 0; margin: 0; }
      .output-box { border: none; box-shadow: none; width: 80mm; max-width: 80mm; margin: 0; padding: 5mm; font-size: 12px; }
      @page { size: 80mm auto; margin: 0; }
    }
  </style>
</head>
<body>

<div class="app">
  <header class="no-print">
    <div>
      <div style="font-weight: 900; font-size: 1.6rem; color: var(--accent);">COMMANDER √âLITE</div>
      <div id="clock" style="font-size: 12px; color: var(--text-dim);">...</div>
    </div>
    <div style="display: flex; gap: 8px;">
      <button class="btn btn-sec" onclick="App.openSettings()">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-main" style="background:var(--danger); color:white" onclick="App.nightClosure()">üåô RESET</button>
    </div>
  </header>

  <div class="card no-print">
    <div class="card-h">üì• RICEZIONE ORDINE WHATSAPP</div>
    <div class="card-b">
      <textarea id="raw-input" placeholder="Incolla il messaggio completo..."></textarea>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1rem;">
        <button class="btn btn-main" onclick="App.process()">‚ö° ANALISI INTELLIGENTE</button>
        <button class="btn btn-sec" onclick="App.openEditor()">‚úèÔ∏è GESTIONALE ORDINE</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-h no-print">
      <span>üñ®Ô∏è ANTEPRIMA STAMPA 80mm</span>
      <button class="btn btn-main" onclick="window.print()">STAMPA IPHONE</button>
    </div>
    <div class="card-b" style="background: #222;">
      <div id="output" class="output-box">Pronto per l'analisi...</div>
    </div>
  </div>
</div>

<div id="modal-settings" class="modal no-print">
  <div class="modal-sheet">
    <h2>üõ†Ô∏è Configurazione Catalogo</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div>
        <h3>Pizze <button class="btn-add" onclick="App.addCatalogItem('pizzas')">+</button></h3>
        <div id="cfg-pizzas"></div>
      </div>
      <div>
        <h3>Impasti/Formati <button class="btn-add" onclick="App.addCatalogItem('variations')">+</button></h3>
        <div id="cfg-variations"></div>
        <h3>Extra <button class="btn-add" onclick="App.addCatalogItem('extras')">+</button></h3>
        <div id="cfg-extras"></div>
      </div>
    </div>
    <button class="btn btn-main" style="width:100%; margin-top:2rem;" onclick="App.saveSettings()">üíæ SALVA E CHIUDI</button>
  </div>
</div>

<div id="modal-editor" class="modal no-print">
  <div class="modal-sheet">
    <h2>‚úèÔ∏è Gestione Avanzata Ordine</h2>
    <div id="edt-meta" class="item-row" style="grid-template-columns: 1fr 1fr 1fr;">
      <input type="text" id="edt-customer" placeholder="Cliente">
      <input type="text" id="edt-time" placeholder="Orario">
      <input type="text" id="edt-phone" placeholder="Telefono">
    </div>
    <hr style="opacity:0.1; margin:15px 0;">
    <div id="edt-items-list"></div>
    <button class="btn btn-sec" onclick="App.addOrderItem()">‚ûï AGGIUNGI RIGA</button>
    <div style="margin-top:2rem; padding:1rem; background:rgba(255,255,255,0.05); border-radius:8px;">
        <div style="display:flex; justify-content:space-between;">
            <span>TOTALE RICALCOLATO:</span>
            <span id="edt-total" style="color:var(--success); font-weight:900;">‚Ç¨ 0.00</span>
        </div>
    </div>
    <button class="btn btn-main" style="width:100%; margin-top:1rem;" onclick="App.saveOrderEdits()">üöÄ AGGIORNA E STAMPA</button>
  </div>
</div>

<script>
const App = {
  config: {
    pizzas: { "margherita": 6.5, "diavola": 8.0, "capricciosa": 9.0, "salame piccante": 8.0 },
    variations: { "integrale": 1.5, "verace": 2.0, "senza glutine": 3.0, "mezzo metro": 15.0, "grande": 2.5 },
    extras: { "bufala": 2.0, "speck": 1.5, "brie": 1.5, "crudo": 2.5 },
    deliveryFee: 2.0
  },
  
  order: null,

  init() {
    const s = localStorage.getItem('commander_cfg');
    if(s) this.config = JSON.parse(s);
    setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleTimeString(), 1000);
  },

  // --- PARSER SUPER MEGA INTELLIGENTE ---
  process() {
    const raw = document.getElementById('raw-input').value;
    let o = { customer: "Anonimo", time: "ASAP", address: "", phone: "", items: [], total: 0, mode: "RITIRO" };

    const lines = raw.split('\n').map(l => l.trim().toLowerCase());
    
    lines.forEach(l => {
      // Metadati
      if(l.match(/(\d{2}[:.]\d{2})/)) o.time = l.match(/(\d{2}[:.]\d{2})/)[0];
      if(l.includes("via")) { o.address = l; o.mode = "CONSEGNA"; }
      if(l.match(/\b\d{9,10}\b/)) o.phone = l.match(/\b\d{9,10}\b/)[0];
      if(l.includes("nome:") || l.match(/^[a-z]+\s[a-z]+$/)) o.customer = l.replace("nome:", "").trim();

      // Analisi Righe (Pizze)
      let qtyM = l.match(/^(\d+)/);
      if(qtyM) {
        let qty = parseInt(qtyM[1]);
        let name = l.replace(/^\d+/, "").trim();
        let price = 0;

        // Gestione Multi-Gusto (Met√† e Met√†)
        if(name.includes("met√†")) {
            let gusti = [];
            for(let p in this.config.pizzas) { if(name.includes(p)) gusti.push(this.config.pizzas[p]); }
            price = gusti.length > 0 ? (gusti.reduce((a,b)=>a+b,0) / gusti.length) : 7.0;
        } else {
            for(let p in this.config.pizzas) { if(name.includes(p)) price = this.config.pizzas[p]; }
        }

        // Aggiunte Impasti e Extra
        for(let v in this.config.variations) { if(name.includes(v)) price += this.config.variations[v]; }
        for(let e in this.config.extras) { if(name.includes(e)) price += this.config.extras[e]; }

        if(price > 0) o.items.push({ qty, name: name.toUpperCase(), price });
      }
    });

    this.order = o;
    this.render();
  },

  render() {
    if(!this.order) return;
    const o = this.order;
    const sub = o.items.reduce((a,b) => a + (b.price * b.qty), 0);
    o.total = sub + (o.mode === "CONSEGNA" ? this.config.deliveryFee : 0);

    let h = `*** PIZZERIA GESTIONALE ***\n`;
    h += `--------------------------------\n`;
    h += `ORDINE: ${o.time}\n`;
    h += `CLIENTE: ${o.customer.toUpperCase()}\n`;
    if(o.phone) h += `TEL: ${o.phone}\n`;
    if(o.address) h += `IND: ${o.address.toUpperCase()}\n`;
    h += `MODO: ${o.mode}\n`;
    h += `--------------------------------\n`;
    o.items.forEach(it => {
      h += `${it.qty}x ${it.name.padEnd(20)} ${ (it.price * it.qty).toFixed(2) }\n`;
    });
    h += `--------------------------------\n`;
    if(o.mode === "CONSEGNA") h += `CONSEGNA:          ${this.config.deliveryFee.toFixed(2)}\n`;
    h += `TOTALE:            EUR ${o.total.toFixed(2)}\n`;
    h += `--------------------------------\n`;
    h += `\n\n\n`; // Spazio per taglio carta

    document.getElementById('output').textContent = h;
  },

  // --- GESTIONALE ORDINE (MODIFICA) ---
  openEditor() {
    if(!this.order) return alert("Nessun ordine caricato");
    const o = this.order;
    document.getElementById('edt-customer').value = o.customer;
    document.getElementById('edt-time').value = o.time;
    document.getElementById('edt-phone').value = o.phone;
    
    this.renderEditorItems();
    document.getElementById('modal-editor').classList.add('open');
  },

  renderEditorItems() {
    const container = document.getElementById('edt-items-list');
    container.innerHTML = this.order.items.map((it, idx) => `
      <div class="item-row">
        <input type="number" value="${it.qty}" onchange="App.order.items[${idx}].qty=parseInt(this.value); App.updateEditorTotal()">
        <input type="text" value="${it.name}" onchange="App.order.items[${idx}].name=this.value.toUpperCase()">
        <input type="number" value="${it.price}" onchange="App.order.items[${idx}].price=parseFloat(this.value); App.updateEditorTotal()">
        <button class="btn" style="background:var(--danger)" onclick="App.removeOrderItem(${idx})">X</button>
      </div>
    `).join('');
    this.updateEditorTotal();
  },

  addOrderItem() {
    this.order.items.push({ qty: 1, name: "NUOVA PIZZA", price: 7.0 });
    this.renderEditorItems();
  },

  removeOrderItem(idx) {
    this.order.items.splice(idx, 1);
    this.renderEditorItems();
  },

  updateEditorTotal() {
    const sub = this.order.items.reduce((a,b) => a + (b.price * b.qty), 0);
    document.getElementById('edt-total').textContent = `‚Ç¨ ${sub.toFixed(2)}`;
  },

  saveOrderEdits() {
    this.order.customer = document.getElementById('edt-customer').value;
    this.order.time = document.getElementById('edt-time').value;
    this.order.phone = document.getElementById('edt-phone').value;
    document.getElementById('modal-editor').classList.remove('open');
    this.render();
  },

  // --- IMPOSTAZIONI AVANZATE ---
  openSettings() {
    const render = (obj, id) => {
      document.getElementById(id).innerHTML = Object.entries(obj).map(([k,v]) => `
        <div class="item-row" style="grid-template-columns: 1fr 60px 40px;">
          <input type="text" value="${k}" readonly>
          <input type="number" value="${v}" onchange="App.config.${id.split('-')[1]}['${k}']=parseFloat(this.value)">
          <button class="btn" style="background:var(--danger); padding:2px" onclick="App.deleteCatalogItem('${id.split('-')[1]}','${k}')">X</button>
        </div>
      `).join('');
    };
    render(this.config.pizzas, 'cfg-pizzas');
    render(this.config.variations, 'cfg-variations');
    render(this.config.extras, 'cfg-extras');
    document.getElementById('modal-settings').classList.add('open');
  },

  addCatalogItem(type) {
    const key = prompt("Nome nuovo elemento:");
    if(key) {
      this.config[type][key.toLowerCase()] = 0;
      this.openSettings();
    }
  },

  deleteCatalogItem(type, key) {
    delete this.config[type][key];
    this.openSettings();
  },

  saveSettings() {
    localStorage.setItem('commander_cfg', JSON.stringify(this.config));
    document.getElementById('modal-settings').classList.remove('open');
  },

  nightClosure() {
    if(confirm("RESET TOTALE?")) {
        this.order = null;
        document.getElementById('raw-input').value = "";
        document.getElementById('output').textContent = "Pronto...";
    }
  }
};

App.init();
</script>
</body>
</html>
