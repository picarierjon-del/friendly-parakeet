<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Gestionale WhatsApp → Comande (V7)</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.10);
      --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --danger:#fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:linear-gradient(180deg,#070b14,var(--bg));color:var(--text)}
    .app{max-width:1080px;margin:0 auto;padding:14px 14px 100px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;position:sticky;top:0;z-index:5;
      background:rgba(7,11,20,.75);backdrop-filter: blur(10px);padding:12px 10px;border-bottom:1px solid var(--border);
      border-radius:0 0 18px 18px;}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{font-size:16px;margin:0;font-weight:800}
    .title .sub{font-size:12px;color:var(--muted)}
    .iconbtn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:16px;line-height:1;cursor:pointer}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:4px 10px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--border);border-radius:var(--radius);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      box-shadow:0 8px 30px rgba(0,0,0,.25);overflow:hidden}
    .cardhead{padding:12px;background:rgba(255,255,255,.04);border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardhead h2{margin:0;font-size:14px}
    .cardbody{padding:12px}
    textarea{width:100%;min-height:240px;background:rgba(0,0,0,.25);color:var(--text);border:1px solid var(--border);
      border-radius:14px;padding:12px;font-size:15px;outline:none}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);border-radius:14px;padding:12px 14px;
      font-size:15px;cursor:pointer}
    .btn.primary{border-color:rgba(96,165,250,.6);background:rgba(96,165,250,.15)}
    .btn.danger{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.12)}
    .btn.ok{border-color:rgba(52,211,153,.6);background:rgba(52,211,153,.12)}
    .hint{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);border-radius:999px;padding:8px 12px;
      font-size:13px;cursor:pointer}
    .tab.active{border-color:rgba(96,165,250,.65);background:rgba(96,165,250,.16)}
    .out{font-family:var(--mono);white-space:pre-wrap;line-height:1.25;font-size:13px;background:rgba(0,0,0,.22);
      border:1px solid var(--border);border-radius:14px;padding:12px;min-height:240px}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--danger)}

    .bottombar{position:fixed;left:0;right:0;bottom:0;z-index:6;background:rgba(7,11,20,.85);backdrop-filter: blur(12px);
      border-top:1px solid var(--border);padding:10px 14px}
    .bottomwrap{max-width:1080px;margin:0 auto;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .bottomwrap .mini{font-size:12px;color:var(--muted)}

    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);z-index:10}
    .modal.open{display:flex}
    .sheet{width:min(1080px,100%);background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));
      border:1px solid var(--border);border-radius:20px 20px 0 0;padding:14px;max-height:86vh;overflow:auto}
    .sheethead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .sheethead h3{margin:0;font-size:15px}

    .section{border:1px solid var(--border);border-radius:16px;background:rgba(0,0,0,.18);padding:12px;margin:10px 0}
    .section h4{margin:0 0 10px;font-size:13px;color:var(--muted);font-weight:700}
    .formgrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){.formgrid{grid-template-columns:1fr 1fr}}
    label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    input, select{width:100%;background:rgba(0,0,0,.22);color:var(--text);border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;font-size:14px;outline:none}
    .jsonarea{min-height:280px;font-family:var(--mono);font-size:13px}

    /* Confirm editor */
    .confirmWrap{display:none}
    .confirmWrap.open{display:block}
    .metaGrid{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px}
    @media(min-width:860px){.metaGrid{grid-template-columns:1fr 1fr}}
    .metaCard{border:1px solid var(--border);border-radius:16px;background:rgba(0,0,0,.18);padding:12px}
    .metaCard .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .metaCard .row > *{flex:1}
    .metaCard .row .small{flex:.7}

    .itemCard{border:1px solid var(--border);border-radius:16px;background:rgba(0,0,0,.18);padding:12px;margin:10px 0}
    .itemTop{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:rgba(255,255,255,.05);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .dangerText{color:var(--danger)}
    .grid2{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:860px){.grid2{grid-template-columns:1fr 1fr}}
    .grid3{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:860px){.grid3{grid-template-columns:1fr 1fr 1fr}}
    .extrasBox{border:1px dashed var(--border);border-radius:14px;padding:10px}
    .extrasList{display:flex;flex-wrap:wrap;gap:8px}
    .chk{display:flex;gap:8px;align-items:center;border:1px solid var(--border);background:rgba(255,255,255,.04);
      padding:8px 10px;border-radius:999px;font-size:13px}
    .chk input{width:auto}

    @media print{
      .topbar,.bottombar,.no-print,.modal{display:none !important}
      body{background:#fff;color:#000}
      .app{padding:0;max-width:none}
      .card{border:none;box-shadow:none;background:none}
      .out{border:none;background:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <h1>Gestionale WhatsApp → Comande (V7)</h1>
        <div class="sub">Modalità Conferma: prima editi le righe, poi stampa. (iPhone friendly)</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="dayBadge" class="pill">—</span>
        <button id="openSettings" class="iconbtn" aria-label="Impostazioni">⚙️</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardhead">
          <h2>Input WhatsApp</h2>
          <span class="pill" id="extractBadge">Estrazione: auto</span>
        </div>
        <div class="cardbody">
          <textarea id="input" placeholder="Incolla qui l’ordine (anche tutta la chat)."></textarea>

          <div class="btnrow no-print">
            <button id="gen" class="btn primary">Genera</button>
            <button id="openConfirm" class="btn ok">Conferma / Modifica</button>
            <button id="copy" class="btn">Copia</button>
            <button id="print" class="btn">Stampa</button>
            <button id="closeDay" class="btn danger">Chiusura serale</button>
          </div>

          <div class="hint">
            ✅ Se il parser sbaglia qualcosa, apri <b>Conferma / Modifica</b> e sistemi con tap.<br/>
            ✅ “Ritiro/Consegna”, “impasto”, “formato”, “size” e “extra” diventano campi corretti.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardhead">
          <div class="tabs no-print">
            <div class="tab active" data-view="kitchen">Comanda cucina</div>
            <div class="tab" data-view="receipt">Ricevuta cliente</div>
            <div class="tab" data-view="debug">Debug</div>
          </div>
        </div>
        <div class="cardbody">
          <div id="outKitchen" class="out">—</div>
          <div id="outReceipt" class="out" style="display:none">—</div>
          <div id="outDebug" class="out" style="display:none">—</div>
          <div id="status" class="status no-print"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottombar no-print">
    <div class="bottomwrap">
      <div class="mini" id="printModeMini">Stampa: entrambe</div>
      <div class="mini" id="totalMini">Totale: —</div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="modalSettings" class="modal no-print" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheethead">
        <h3>Impostazioni</h3>
        <button id="closeSettings" class="iconbtn" aria-label="Chiudi">✕</button>
      </div>

      <div class="section">
        <h4>Stampa</h4>
        <div class="formgrid">
          <label>
            Modalità stampa
            <select id="printMode">
              <option value="both">Entrambe (cucina + ricevuta)</option>
              <option value="kitchen">Solo comanda cucina</option>
              <option value="receipt">Solo ricevuta cliente</option>
            </select>
          </label>
          <label>
            Costo consegna (se CONSEGNA)
            <input id="deliveryFee" inputmode="decimal" placeholder="0.00" />
          </label>
        </div>
      </div>

      <div class="section">
        <h4>Default</h4>
        <div class="formgrid">
          <label>
            Pizza base “custom” (se nome non trovato)
            <select id="fallbackBasePizza"></select>
          </label>
          <label>
            Default size
            <select id="fallbackSize"></select>
          </label>
        </div>
      </div>

      <div class="section">
        <h4>Catalogo (JSON)</h4>
        <div class="hint">Puoi aggiungere prezzi in <b>sizes</b> (grande/mezzo metro) e <b>formats</b> (schiacciata/verace).</div>
        <textarea id="catalog" class="jsonarea" spellcheck="false"></textarea>
        <div class="btnrow">
          <button id="saveCatalog" class="btn primary">Salva catalogo</button>
          <button id="resetCatalog" class="btn">Ripristina esempio</button>
          <button id="exportCatalog" class="btn">Export</button>
          <button id="importCatalog" class="btn">Import</button>
        </div>
        <div id="catStatus" class="status"></div>
      </div>
    </div>
  </div>

  <!-- CONFIRM EDITOR -->
  <div id="modalConfirm" class="modal no-print" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheethead">
        <h3>Conferma ordine</h3>
        <button id="closeConfirm" class="iconbtn" aria-label="Chiudi">✕</button>
      </div>

      <div id="confirmWrap" class="confirmWrap">
        <div class="metaGrid">
          <div class="metaCard">
            <div class="row">
              <label class="small">Tipo
                <select id="c_mode">
                  <option value="">—</option>
                  <option value="CONSEGNA">CONSEGNA</option>
                  <option value="RITIRO">RITIRO</option>
                  <option value="CONSEGNA/RITIRO">CONSEGNA/RITIRO</option>
                </select>
              </label>
              <label class="small">Orario
                <input id="c_time" placeholder="20:15" inputmode="numeric" />
              </label>
            </div>
            <div class="row" style="margin-top:10px">
              <label>Cliente
                <input id="c_name" placeholder="Nome cliente" />
              </label>
              <label>Tel
                <input id="c_phone" placeholder="320..." inputmode="tel" />
              </label>
            </div>
            <div class="row" style="margin-top:10px">
              <label>Indirizzo
                <input id="c_address" placeholder="Via..." />
              </label>
            </div>
            <div class="row" style="margin-top:10px">
              <label>Note ordine
                <input id="c_notes" placeholder="Scala / int. / tagliate / ecc." />
              </label>
            </div>
          </div>

          <div class="metaCard">
            <div class="row">
              <div class="chip">Totale: <b id="c_total">—</b></div>
              <div class="chip">Pizze: <b id="c_pizzas">—</b></div>
              <div class="chip">Righe: <b id="c_lines">—</b></div>
            </div>
            <div class="btnrow" style="margin-top:12px">
              <button id="c_addPizza" class="btn ok">+ Pizza</button>
              <button id="c_addDrink" class="btn ok">+ Bibita</button>
              <button id="c_apply" class="btn primary">Applica & Genera</button>
            </div>
            <div class="hint">Tip: se una riga è “strana”, qui la sistemi e non sbaglia più in stampa.</div>
          </div>
        </div>

        <div id="itemsHost"></div>
      </div>
    </div>
  </div>

<script>
/* ================= STORAGE ================= */
const LS = { catalog:"wa_gestionale_catalog_v7", settings:"wa_gestionale_settings_v7", lastDay:"wa_gestionale_lastday_v7" };

const SAMPLE_CATALOG = {
  currency:"€",
  pizzas:{ "margherita":6.00, "capricciosa":8.50, "salame piccante":7.50 },
  drinks:{ "coca cola 33":2.50, "acqua 0.5":1.50, "birra 33":3.50 },
  extras:{
    "speck":1.50, "brie":1.50, "porcini":2.00, "grana":1.00, "panna":1.20,
    "prosciutto cotto":1.80, "gorgonzola":1.80, "crudo di parma":2.50,
    "cipolle":0.80, "verdure grigliate":1.50, "mozzarella senza lattosio":1.50
  },
  doughs:{ "classico":0.00, "integrale":1.00, "senza glutine":3.00 },
  sizes:{ "normale":0.00, "grande":0.00, "mezzo metro":0.00 },
  formats:{ "tonda":0.00, "schiacciata":0.00, "verace":0.00 },
  aliases:{
    "marg":"margherita",
    "sg":"senza glutine","s.g.":"senza glutine","senza glutine":"senza glutine",
    "mezzo-metro":"mezzo metro","mezzometro":"mezzo metro"
  }
};

const DEFAULT_SETTINGS = {
  printMode:"both",
  deliveryFee:0.00,
  fallbackBasePizza:"margherita",
  fallbackSize:"normale"
};

function loadCatalog(){const s=localStorage.getItem(LS.catalog); if(s){try{return JSON.parse(s);}catch{}} return structuredClone(SAMPLE_CATALOG);}
function saveCatalog(obj){localStorage.setItem(LS.catalog, JSON.stringify(obj,null,2));}
function loadSettings(){const s=localStorage.getItem(LS.settings); if(s){try{return {...DEFAULT_SETTINGS, ...JSON.parse(s)};}catch{}} return structuredClone(DEFAULT_SETTINGS);}
function saveSettings(obj){localStorage.setItem(LS.settings, JSON.stringify(obj,null,2));}

/* ================= UTILS ================= */
function todayKey(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;}
function nowStr(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;}
function normalizeTime(t){const m=(t||"").match(/(\d{1,2})[.:](\d{2})/); if(!m) return ""; return `${String(Number(m[1])).padStart(2,'0')}:${m[2]}`;}
function stripChatNoise(line){return (line||"").replace(/\s+\d{1,2}:\d{2}\s*$/,'').trim();}
function safeLower(s){return (s||"").toLowerCase();}
function normSpaces(s){return (s||"").replace(/\s+/g,' ').trim();}
function money(n){return (Math.round((n+Number.EPSILON)*100)/100).toFixed(2);}
function setStatus(msg,type=""){const el=document.getElementById("status"); el.className="status no-print "+(type==="ok"?"ok":type==="warn"?"warn":type==="err"?"err":""); el.textContent=msg||"";}
function setCatStatus(msg,type=""){const el=document.getElementById("catStatus"); el.className="status "+(type==="ok"?"ok":type==="warn"?"warn":type==="err"?"err":""); el.textContent=msg||"";}
function ensureDaily(){
  const t=todayKey();
  document.getElementById("dayBadge").textContent=`Giorno: ${t}`;
  const last=localStorage.getItem(LS.lastDay);
  if(last!==t){localStorage.setItem(LS.lastDay,t); setStatus("Nuovo giorno: pronto.","ok");}
}

let CATALOG = loadCatalog();
let SETTINGS = loadSettings();

/* ================= PARSER (robusto + semplice) ================= */
function resolveAlias(cat,raw){
  const k=normSpaces(safeLower(raw));
  if(cat.aliases && cat.aliases[k]) return cat.aliases[k];
  return k;
}
function looksLikeAddressLine(line){
  const l=safeLower(line).trim();
  if(/^indirizzo\s*:/.test(l)) return true;
  if(/^in\s+(via|viale|piazza|corso|strada)\b/.test(l)) return true;
  return /^(via|viale|piazza|corso|strada|v\.|p\.|c\.so)\b/.test(l);
}
function cleanAddress(line){ return normSpaces(line.replace(/^indirizzo\s*:\s*/i,"").replace(/^in\s+/i,"")); }
function detectPickupDelivery(text){
  const t=safeLower(text);
  const hasPickup = /\b(ritiro|asporto|take away|takeaway|passo a prender|vengo a prender|passo a ritir|vengo a ritir)\b/.test(t);
  const hasDelivery = /\b(consegna|domicilio|a casa|delivery)\b/.test(t);
  if(hasPickup && !hasDelivery) return "RITIRO";
  if(hasDelivery && !hasPickup) return "CONSEGNA";
  if(hasDelivery && hasPickup) return "CONSEGNA/RITIRO";
  return "";
}
function detectPhone(line){
  const pm=(line||"").match(/(\+?\d[\d\s\-]{6,}\d)/);
  if(!pm) return "";
  return pm[1].replace(/[^\d+]/g,'');
}
function looksLikePersonName(line){
  const s=normSpaces(line);
  if(!s || s.length<3) return false;
  if(/\d/.test(s)) return false;
  if(looksLikeAddressLine(s)) return false;
  const words=s.split(" ");
  if(words.length<2 || words.length>4) return false;
  const cap = words.filter(w=>/^[A-ZÀÈÉÌÒÙ][a-zàèéìòù'’-]+$/.test(w)).length;
  return cap>=2;
}
function extractQtyAndText(line){
  let m=line.match(/^(\d+)\s+(.+)$/);
  if(m) return {qty:Number(m[1]), text:m[2].trim()};
  m=line.match(/^(.+?)\s*[x×]\s*(\d+)$/i);
  if(m) return {qty:Number(m[2]), text:m[1].trim()};
  return {qty:1, text:line.trim()};
}
function detectDough(cat, text){
  if(/\b(senza\s+glutine|sg|s\.g\.)\b/i.test(text)) return "senza glutine";
  const lower=safeLower(text);
  for(const d of Object.keys(cat.doughs||{})){
    if(d==="senza glutine") continue;
    if(lower.includes(safeLower(d))) return d;
  }
  return "classico";
}
function detectSize(cat, text, fallback){
  let lower=safeLower(text).replace(/mezzo[\s-]?metro/g,"mezzo metro");
  for(const s of Object.keys(cat.sizes||{})){
    if(s==="normale") continue;
    if(lower.includes(safeLower(s))) return s;
  }
  return fallback || "normale";
}
function detectFormat(cat, text){
  const lower=safeLower(text);
  for(const f of Object.keys(cat.formats||{})){
    if(f==="tonda") continue;
    if(lower.includes(safeLower(f))) return f;
  }
  return "tonda";
}
function findPizzaName(cat, text){
  let t=normSpaces(safeLower(text))
    .replace(/\b(senza\s+glutine|sg|s\.g\.)\b/g,'')
    .replace(/\b(impasto|formato|pizza|pizze)\b/g,'')
    .replace(/\b(mezzo\s*metro|grande|schiacciata|verace)\b/g,'')
    .replace(/\+.*$/g,'')
    .trim();

  const keys=Object.keys(cat.pizzas||{}).sort((a,b)=>b.length-a.length);
  for(const k of keys){ if(t.includes(safeLower(k))) return k; }

  const alias=resolveAlias(cat, t);
  if(cat.pizzas && cat.pizzas[alias] != null) return alias;

  return t || text.trim();
}
function parseExtras(cat, text){
  let t=text.replace(/\bsenza\s+glutine\b/ig," ").replace(/\bsg\b/ig," ").replace(/\bs\.g\.\b/ig," ");
  const lower=safeLower(t);

  const removals=[];
  const senza=[...t.matchAll(/\bsenza\s+([a-zàèéìòù0-9'\- ]{2,})/gi)].map(m=>normSpaces(m[1]));
  for(const s of senza){ removals.push(resolveAlias(cat,s)); }

  const extras=[];
  const plus=[...t.matchAll(/(?:^|\s)(?:\+|pi[ùu])\s*([a-zàèéìòù0-9'\- ]{2,})/gi)].map(m=>normSpaces(m[1]));
  for(const p of plus){ extras.push(resolveAlias(cat,p)); }

  for(const ex of Object.keys(cat.extras||{})){
    const exL=safeLower(ex);
    if(new RegExp(`\\b${exL.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\b`).test(lower)){
      if(removals.some(r=>safeLower(r)===exL)) continue;
      if(!extras.some(e=>safeLower(e)===exL)) extras.push(ex);
    }
  }
  return {extrasFull:[...new Set(extras)], removals:[...new Set(removals)]};
}
function parseGustiLine(line){
  const l=safeLower(line).replace(/mezzo[\s-]?metro/g,"mezzo metro");
  const m=l.match(/\b(\d+)\s*(?:gust[oi]|gusto|gusti)\b/);
  if(m) return Number(m[1]);
  if(/\bdue\s+gust/i.test(l)) return 2;
  if(/\btre\s+gust/i.test(l)) return 3;
  if(/\bun\s+gust/i.test(l)) return 1;
  return 0;
}

/* pricing */
function extrasSum(cat, extras){
  return (extras||[]).reduce((acc, ex)=>{
    const k=resolveAlias(cat, ex);
    const p=(cat.extras && cat.extras[k]!=null)?Number(cat.extras[k]):0;
    return acc+p;
  },0);
}
function pricePizza(cat, pizzaKey, doughKey, sizeKey, formatKey, extrasFull){
  const baseKnown=(cat.pizzas && cat.pizzas[pizzaKey]!=null);
  const base=baseKnown?Number(cat.pizzas[pizzaKey]):0;
  const dough=(cat.doughs && cat.doughs[doughKey]!=null)?Number(cat.doughs[doughKey]):0;
  const size=(cat.sizes && cat.sizes[sizeKey]!=null)?Number(cat.sizes[sizeKey]):0;
  const fmt =(cat.formats && cat.formats[formatKey]!=null)?Number(cat.formats[formatKey]):0;
  const ex  = extrasSum(cat, extrasFull);
  return { unit: base + dough + size + fmt + ex, known: baseKnown };
}

/* parse to a "draft" order (then confirm UI edits it) */
function parseDraft(cat, settings, rawText){
  const text = (rawText||"").replace(/\r/g,"").trim();
  document.getElementById("extractBadge").textContent = "Estrazione: testo";

  const lines = text.split("\n").map(x=>stripChatNoise(x).trim()).filter(Boolean);

  let mode = detectPickupDelivery(text);
  let desiredTime = "";
  let address = "";
  let phone = "";
  let name = "";
  let notes = "";

  // time
  for(const ln of lines){
    const tm=ln.match(/\b(?:alle|per\s*le|ore)\s*(\d{1,2}[.:]\d{2})\b/i) || ln.match(/\b(\d{1,2}[.:]\d{2})\b/);
    if(tm){ desiredTime=normalizeTime(tm[1]); break; }
  }
  // address
  for(const ln of lines){ if(looksLikeAddressLine(ln)){ address=cleanAddress(ln); break; } }
  // phone
  for(const ln of lines){ const ph=detectPhone(ln); if(ph) phone=ph; }
  // name (last plausible)
  for(let i=lines.length-1;i>=0;i--){ if(looksLikePersonName(lines[i])){ name=normSpaces(lines[i]); break; } }
  // notes (simple: tagliate etc.)
  if(/\b(tagliate|tagliata|spicchi)\b/i.test(text)) notes = "tagliate";

  let defaultSize = settings.fallbackSize || "normale";
  if(/\bmezzo[\s-]?metro\b/i.test(text)) defaultSize = "mezzo metro";

  const items=[];
  for(const ln0 of lines){
    const ln=ln0.trim();
    if(!ln) continue;
    if(looksLikeAddressLine(ln)) continue;
    if(name && safeLower(ln)===safeLower(name)) continue;
    if(phone && ln.replace(/\D/g,'') === phone.replace(/\D/g,'')) continue;

    // skip greetings/meta
    const l=safeLower(ln);
    if(/^(ciao|buonasera|buongiorno|salve)\b/.test(l)) continue;
    if(/\bvolevo ordinare\b/.test(l)) continue;
    if(/\bstasera\b/.test(l)) continue;

    const {qty, text:itemTextRaw} = extractQtyAndText(ln);
    if(!itemTextRaw) continue;

    const gustiN=parseGustiLine(itemTextRaw);
    const sizeKey=detectSize(cat, itemTextRaw, defaultSize);
    const formatKey=detectFormat(cat, itemTextRaw);
    const doughKey=detectDough(cat, itemTextRaw);

    // drinks (match by key/alias)
    const dt = resolveAlias(cat, itemTextRaw);
    const drinkKey = (cat.drinks && cat.drinks[dt]!=null) ? dt : "";
    if(drinkKey){
      const unit=Number(cat.drinks[drinkKey]);
      items.push({ kind:"drink", qty, label:drinkKey, unitPrice:unit, extrasFull:[], removals:[], doughKey:"", sizeKey:"", formatKey:"" });
      continue;
    }

    // pizza line
    let pizzaKeyCand=findPizzaName(cat, itemTextRaw);
    const known=(cat.pizzas && cat.pizzas[pizzaKeyCand]!=null);
    const pizzaKey = known ? pizzaKeyCand : (settings.fallbackBasePizza || pizzaKeyCand);
    const {extrasFull, removals}=parseExtras(cat, itemTextRaw);
    const pr=pricePizza(cat, pizzaKey, doughKey, sizeKey, formatKey, extrasFull);

    items.push({
      kind:"pizza", qty,
      pizzaKey,
      gusti: gustiN || 0,
      freeText: gustiN ? itemTextRaw : "",
      doughKey, sizeKey, formatKey,
      extrasFull, removals,
      unitPrice: pr.unit
    });
  }

  return {
    name, phone, address, notes,
    desiredTime, mode,
    items,
    currency: cat.currency || "€"
  };
}

/* ================= OUTPUT FORMATTERS ================= */
function fmtKitchen(cat, o){
  const sep="--------------------------------";
  const head=[
    "================================",
    "          COMANDA CUCINA        ",
    "================================",
    `Ora: ${nowStr()}`,
    o.desiredTime ? `Orario: ${o.desiredTime}` : "Orario: —",
    `Tipo: ${o.mode || "—"}`,
    o.name ? `Cliente: ${o.name}` : "Cliente: —",
    o.phone ? `Tel: ${o.phone}` : "",
    o.address ? `Indirizzo: ${o.address}` : "Indirizzo: —",
    o.notes ? `Note: ${o.notes}` : "",
    sep,
    "ARTICOLI:"
  ].filter(Boolean);

  const body=(o.items.length?o.items:[]).map(it=>{
    if(it.kind==="drink"){
      return `${String(it.qty).padStart(2,' ')}  BIBITA  ${it.label}`;
    }
    const gf = it.doughKey==="senza glutine" ? "  !!! SENZA GLUTINE !!!" : "";
    const size = (it.sizeKey && it.sizeKey!=="normale") ? ` (${it.sizeKey})` : "";
    const fmt  = (it.formatKey && it.formatKey!=="tonda") ? ` <${it.formatKey}>` : "";
    const dough= (it.doughKey && it.doughKey!=="classico") ? ` {${it.doughKey}}` : "";
    const exF = (it.extrasFull?.length) ? ` +${it.extrasFull.join(", ")}` : "";
    const rem = (it.removals?.length) ? ` -${it.removals.join(", ")}` : "";
    const gusti = it.gusti ? ` [${it.gusti} gusti]` : "";
    const extraLine = (it.gusti && it.freeText) ? `\n     → ${it.freeText}` : "";
    return `${String(it.qty).padStart(2,' ')}  ${it.pizzaKey}${gusti}${size}${fmt}${dough}${exF}${rem}${gf}${extraLine}`;
  }).join("\n");

  const pizzaCount=o.items.filter(i=>i.kind==="pizza").reduce((a,i)=>a+i.qty,0);
  const foot=[sep, `Totale pizze: ${pizzaCount}`, "================================"];
  return [...head, body||"—", ...foot].join("\n");
}

function fmtReceipt(cat, o, total){
  const cur=cat.currency||"€";
  const sep="--------------------------------";
  const lines=[];
  let missing=0;

  lines.push("================================");
  lines.push("         RICEVUTA CLIENTE       ");
  lines.push("================================");
  lines.push(`Ora: ${nowStr()}`);
  if(o.desiredTime) lines.push(`Orario: ${o.desiredTime}`);
  lines.push(`Tipo: ${o.mode || "—"}`);
  if(o.name) lines.push(`Cliente: ${o.name}`);
  if(o.phone) lines.push(`Tel: ${o.phone}`);
  if(o.address) lines.push(`Indirizzo: ${o.address}`);
  if(o.notes) lines.push(`Note: ${o.notes}`);
  lines.push(sep);

  for(const it of o.items){
    if(it.kind==="drink"){
      lines.push(`${it.qty} x ${it.label}`);
      const known=(cat.drinks && cat.drinks[it.label]!=null);
      if(!known){missing++; lines.push(`   ⚠️ PREZZO NON TROVATO`);}
      else{
        const unit=Number(cat.drinks[it.label]);
        lines.push(`   ${money(unit)}${cur} -> ${money(unit*it.qty)}${cur}`);
      }
      lines.push(sep);
      continue;
    }

    const size = (it.sizeKey && it.sizeKey!=="normale") ? ` (${it.sizeKey})` : "";
    const fmt  = (it.formatKey && it.formatKey!=="tonda") ? ` <${it.formatKey}>` : "";
    const dough= (it.doughKey && it.doughKey!=="classico") ? ` {${it.doughKey}}` : "";
    const exF = (it.extrasFull?.length) ? ` +${it.extrasFull.join(", ")}` : "";
    const rem = (it.removals?.length) ? ` -${it.removals.join(", ")}` : "";
    const gusti = it.gusti ? ` [${it.gusti} gusti]` : "";

    lines.push(`${it.qty} x ${it.pizzaKey}${gusti}${size}${fmt}${dough}${exF}${rem}`);

    const pr = pricePizza(cat, it.pizzaKey, it.doughKey||"classico", it.sizeKey||"normale", it.formatKey||"tonda", it.extrasFull||[]);
    if(!pr.known){missing++; lines.push(`   ⚠️ PREZZO NON TROVATO`);}
    else lines.push(`   ${money(pr.unit)}${cur} -> ${money(pr.unit*it.qty)}${cur}`);
    if(it.gusti && it.freeText) lines.push(`   → ${it.freeText}`);
    lines.push(sep);
  }

  if(o.mode==="CONSEGNA"){
    const fee=Number(SETTINGS.deliveryFee||0);
    if(fee>0){
      lines.push(`CONSEGNA`);
      lines.push(`   ${money(fee)}${cur}`);
      lines.push(sep);
    }
  }

  lines.push(`TOTALE: ${money(total)}${cur}`);
  if(missing>0) lines.push(`⚠️ ${missing} riga/e senza prezzo: aggiorna il catalogo.`);
  lines.push("================================");
  return lines.join("\n");
}

/* ================= CONFIRM MODEL ================= */
let DRAFT = null; // parsed draft
let CONF = null;  // editable order

function computeTotal(cat, conf){
  let tot=0;
  for(const it of conf.items){
    if(it.kind==="drink"){
      const key=it.label;
      const unit=(cat.drinks && cat.drinks[key]!=null)?Number(cat.drinks[key]):0;
      tot += unit * Number(it.qty||0);
      continue;
    }
    const pr = pricePizza(cat, it.pizzaKey, it.doughKey||"classico", it.sizeKey||"normale", it.formatKey||"tonda", it.extrasFull||[]);
    tot += pr.unit * Number(it.qty||0);
  }
  if(conf.mode==="CONSEGNA"){
    const fee=Number(SETTINGS.deliveryFee||0);
    if(fee>0) tot += fee;
  }
  return tot;
}

function normalizeConfFromDraft(draft){
  // ensure fields exist
  const items=(draft.items||[]).map(it=>{
    if(it.kind==="drink"){
      return { id: crypto.randomUUID(), kind:"drink", qty:it.qty||1, label:it.label||"", unitPrice:0 };
    }
    return {
      id: crypto.randomUUID(),
      kind:"pizza",
      qty: it.qty||1,
      pizzaKey: it.pizzaKey || SETTINGS.fallbackBasePizza || "margherita",
      doughKey: it.doughKey || "classico",
      sizeKey: it.sizeKey || SETTINGS.fallbackSize || "normale",
      formatKey: it.formatKey || "tonda",
      extrasFull: Array.isArray(it.extrasFull)?it.extrasFull:[],
      removals: Array.isArray(it.removals)?it.removals:[],
      gusti: it.gusti||0,
      freeText: it.freeText||""
    };
  });

  return {
    name: draft.name||"",
    phone: draft.phone||"",
    address: draft.address||"",
    notes: draft.notes||"",
    desiredTime: draft.desiredTime||"",
    mode: draft.mode||"",
    items
  };
}

/* ================= CONFIRM UI RENDER ================= */
function optionsFromKeys(keys, selected){
  return keys.map(k=>`<option value="${escapeHtml(k)}"${k===selected?' selected':''}>${escapeHtml(k)}</option>`).join("");
}
function escapeHtml(s){
  return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function renderConfirm(){
  const wrap=document.getElementById("confirmWrap");
  if(!CONF){ wrap.classList.remove("open"); return; }
  wrap.classList.add("open");

  // meta
  document.getElementById("c_mode").value = CONF.mode||"";
  document.getElementById("c_time").value = CONF.desiredTime||"";
  document.getElementById("c_name").value = CONF.name||"";
  document.getElementById("c_phone").value = CONF.phone||"";
  document.getElementById("c_address").value = CONF.address||"";
  document.getElementById("c_notes").value = CONF.notes||"";

  // items
  const host=document.getElementById("itemsHost");
  const pizzaKeys=Object.keys(CATALOG.pizzas||{}).sort();
  const drinkKeys=Object.keys(CATALOG.drinks||{}).sort();
  const doughKeys=Object.keys(CATALOG.doughs||{}).sort();
  const sizeKeys=Object.keys(CATALOG.sizes||{}).sort();
  const fmtKeys=Object.keys(CATALOG.formats||{}).sort();
  const extraKeys=Object.keys(CATALOG.extras||{}).sort();

  host.innerHTML = CONF.items.map((it, idx)=>{
    const isPizza = it.kind==="pizza";
    const header = isPizza
      ? `<span class="chip">PIZZA</span>`
      : `<span class="chip">BIBITA</span>`;
    const delBtn = `<button class="btn danger" data-act="del" data-id="${it.id}">Rimuovi</button>`;

    const qtySel = `<label>Q.tà
      <input data-act="qty" data-id="${it.id}" value="${escapeHtml(it.qty)}" inputmode="numeric" />
    </label>`;

    const mainSel = isPizza ? `
      <label>Pizza
        <select data-act="pizzaKey" data-id="${it.id}">
          ${optionsFromKeys(pizzaKeys, it.pizzaKey)}
        </select>
      </label>
    ` : `
      <label>Bibita
        <select data-act="label" data-id="${it.id}">
          ${optionsFromKeys(drinkKeys, it.label)}
        </select>
      </label>
    `;

    const doughSel = isPizza ? `
      <label>Impasto
        <select data-act="doughKey" data-id="${it.id}">
          ${optionsFromKeys(doughKeys, it.doughKey)}
        </select>
      </label>
    ` : "";

    const sizeSel = isPizza ? `
      <label>Size
        <select data-act="sizeKey" data-id="${it.id}">
          ${optionsFromKeys(sizeKeys, it.sizeKey)}
        </select>
      </label>
    ` : "";

    const fmtSel = isPizza ? `
      <label>Formato
        <select data-act="formatKey" data-id="${it.id}">
          ${optionsFromKeys(fmtKeys, it.formatKey)}
        </select>
      </label>
    ` : "";

    const noteSel = isPizza ? `
      <label>Nota (solo se serve)
        <input data-act="freeText" data-id="${it.id}" value="${escapeHtml(it.freeText||"")}" placeholder="es. 2 gusti, tagliata, ecc." />
      </label>
    ` : "";

    const extrasSel = isPizza ? `
      <div class="extrasBox">
        <div class="chip">Extra</div>
        <div class="extrasList" style="margin-top:10px">
          ${extraKeys.map(ex=>{
            const checked = (it.extrasFull||[]).some(x=>safeLower(x)===safeLower(ex));
            return `<label class="chk">
              <input type="checkbox" data-act="extra" data-id="${it.id}" data-val="${escapeHtml(ex)}" ${checked?'checked':''}/>
              ${escapeHtml(ex)}
            </label>`;
          }).join("")}
        </div>
      </div>
      <div class="extrasBox" style="margin-top:10px">
        <div class="chip">Togli (senza)</div>
        <div class="extrasList" style="margin-top:10px">
          ${extraKeys.map(ex=>{
            const checked = (it.removals||[]).some(x=>safeLower(x)===safeLower(ex));
            return `<label class="chk">
              <input type="checkbox" data-act="rem" data-id="${it.id}" data-val="${escapeHtml(ex)}" ${checked?'checked':''}/>
              ${escapeHtml(ex)}
            </label>`;
          }).join("")}
        </div>
      </div>
    ` : "";

    // price preview
    let pricePreview = "";
    if(isPizza){
      const pr = pricePizza(CATALOG, it.pizzaKey, it.doughKey, it.sizeKey, it.formatKey, it.extrasFull||[]);
      pricePreview = pr.known
        ? `<span class="chip">Unit: <b>${money(pr.unit)}${CATALOG.currency||"€"}</b></span>`
        : `<span class="chip dangerText">⚠️ pizza senza prezzo</span>`;
    } else {
      const known=(CATALOG.drinks && CATALOG.drinks[it.label]!=null);
      pricePreview = known
        ? `<span class="chip">Unit: <b>${money(Number(CATALOG.drinks[it.label]))}${CATALOG.currency||"€"}</b></span>`
        : `<span class="chip dangerText">⚠️ bibita senza prezzo</span>`;
    }

    return `
      <div class="itemCard">
        <div class="itemTop">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            ${header}
            ${pricePreview}
            <span class="chip">Riga #${idx+1}</span>
          </div>
          ${delBtn}
        </div>

        <div class="grid3">
          ${qtySel}
          ${mainSel}
          ${doughSel || `<div></div>`}
        </div>

        <div class="grid3">
          ${sizeSel || `<div></div>`}
          ${fmtSel || `<div></div>`}
          ${noteSel || `<div></div>`}
        </div>

        ${extrasSel || ""}

      </div>
    `;
  }).join("");

  updateConfirmStats();
}

function updateConfirmStats(){
  if(!CONF) return;
  const tot = computeTotal(CATALOG, CONF);
  const pizzas = CONF.items.filter(i=>i.kind==="pizza").reduce((a,i)=>a+Number(i.qty||0),0);
  document.getElementById("c_total").textContent = `${money(tot)}${CATALOG.currency||"€"}`;
  document.getElementById("c_pizzas").textContent = `${pizzas}`;
  document.getElementById("c_lines").textContent = `${CONF.items.length}`;

  // update bottom total too (live)
  document.getElementById("totalMini").textContent = `Totale: ${money(tot)}${CATALOG.currency||"€"}`;
}

function bindConfirmEvents(){
  const modal=document.getElementById("modalConfirm");

  // meta fields
  const metaMap = [
    ["c_mode","mode"],["c_time","desiredTime"],["c_name","name"],["c_phone","phone"],["c_address","address"],["c_notes","notes"]
  ];
  for(const [id,key] of metaMap){
    document.getElementById(id).addEventListener("input", ()=>{
      if(!CONF) return;
      CONF[key] = (key==="desiredTime") ? normalizeTime(document.getElementById(id).value) : document.getElementById(id).value;
      updateConfirmStats();
    });
    document.getElementById(id).addEventListener("change", ()=>{
      if(!CONF) return;
      CONF[key] = (key==="desiredTime") ? normalizeTime(document.getElementById(id).value) : document.getElementById(id).value;
      updateConfirmStats();
    });
  }

  // item events (delegation)
  modal.addEventListener("change", (e)=>{
    const el=e.target;
    if(!el || !el.dataset || !el.dataset.act) return;
    handleConfirmAction(el);
  });
  modal.addEventListener("input", (e)=>{
    const el=e.target;
    if(!el || !el.dataset || !el.dataset.act) return;
    handleConfirmAction(el);
  });
  modal.addEventListener("click", (e)=>{
    const el=e.target;
    if(!el || !el.dataset || !el.dataset.act) return;
    handleConfirmAction(el);
  });

  document.getElementById("c_addPizza").addEventListener("click", ()=>{
    if(!CONF) return;
    const firstPizza = Object.keys(CATALOG.pizzas||{})[0] || SETTINGS.fallbackBasePizza || "margherita";
    CONF.items.push({
      id: crypto.randomUUID(), kind:"pizza", qty:1,
      pizzaKey:firstPizza, doughKey:"classico",
      sizeKey: SETTINGS.fallbackSize || "normale",
      formatKey:"tonda", extrasFull:[], removals:[], gusti:0, freeText:""
    });
    renderConfirm();
  });

  document.getElementById("c_addDrink").addEventListener("click", ()=>{
    if(!CONF) return;
    const firstDrink = Object.keys(CATALOG.drinks||{})[0] || "coca cola 33";
    CONF.items.push({ id: crypto.randomUUID(), kind:"drink", qty:1, label:firstDrink });
    renderConfirm();
  });

  document.getElementById("c_apply").addEventListener("click", ()=>{
    if(!CONF) return;
    // apply to outputs
    renderOutputsFromConf();
    setStatus("Applicato: stampa pronta.","ok");
    document.getElementById("modalConfirm").classList.remove("open");
  });
}

function handleConfirmAction(el){
  if(!CONF) return;
  const act=el.dataset.act;
  const id=el.dataset.id;
  if(!act || !id) return;

  const idx = CONF.items.findIndex(x=>x.id===id);
  if(idx<0) return;
  const it = CONF.items[idx];

  if(act==="del"){
    CONF.items.splice(idx,1);
    renderConfirm();
    return;
  }
  if(act==="qty"){
    const v = Math.max(1, parseInt(el.value||"1",10) || 1);
    it.qty=v;
    updateConfirmStats();
    return;
  }
  if(act==="pizzaKey"){ it.pizzaKey=el.value; updateConfirmStats(); return; }
  if(act==="label"){ it.label=el.value; updateConfirmStats(); return; }
  if(act==="doughKey"){ it.doughKey=el.value; updateConfirmStats(); return; }
  if(act==="sizeKey"){ it.sizeKey=el.value; updateConfirmStats(); return; }
  if(act==="formatKey"){ it.formatKey=el.value; updateConfirmStats(); return; }
  if(act==="freeText"){ it.freeText=el.value; updateConfirmStats(); return; }

  if(act==="extra"){
    const ex=el.dataset.val;
    it.extrasFull ||= [];
    const exists = it.extrasFull.some(x=>safeLower(x)===safeLower(ex));
    if(el.checked && !exists) it.extrasFull.push(ex);
    if(!el.checked && exists) it.extrasFull = it.extrasFull.filter(x=>safeLower(x)!==safeLower(ex));
    updateConfirmStats();
    return;
  }
  if(act==="rem"){
    const ex=el.dataset.val;
    it.removals ||= [];
    const exists = it.removals.some(x=>safeLower(x)===safeLower(ex));
    if(el.checked && !exists) it.removals.push(ex);
    if(!el.checked && exists) it.removals = it.removals.filter(x=>safeLower(x)!==safeLower(ex));
    updateConfirmStats();
    return;
  }
}

/* ================= MAIN RENDER OUTPUTS ================= */
function renderOutputsFromConf(){
  if(!CONF){
    document.getElementById("outKitchen").textContent="—";
    document.getElementById("outReceipt").textContent="—";
    document.getElementById("outDebug").textContent="—";
    document.getElementById("totalMini").textContent="Totale: —";
    return;
  }
  const total = computeTotal(CATALOG, CONF);

  document.getElementById("outKitchen").textContent = fmtKitchen(CATALOG, CONF);
  document.getElementById("outReceipt").textContent = fmtReceipt(CATALOG, CONF, total);

  const dbg=[];
  dbg.push("=== DEBUG (Conferma) ===");
  dbg.push(`Nome: ${CONF.name||"—"}`);
  dbg.push(`Tel: ${CONF.phone||"—"}`);
  dbg.push(`Indirizzo: ${CONF.address||"—"}`);
  dbg.push(`Note: ${CONF.notes||"—"}`);
  dbg.push(`Orario: ${CONF.desiredTime||"—"}`);
  dbg.push(`Tipo: ${CONF.mode||"—"}`);
  dbg.push(`Righe: ${CONF.items.length}`);
  dbg.push(`Totale: ${money(total)}${CATALOG.currency||"€"}`);
  document.getElementById("outDebug").textContent = dbg.join("\n");

  document.getElementById("totalMini").textContent = `Totale: ${money(total)}${CATALOG.currency||"€"}`;
}

/* ================= UI ACTIONS ================= */
function setCatalogTextarea(){ document.getElementById("catalog").value = JSON.stringify(CATALOG,null,2); }

function refreshOptions(){
  const psel=document.getElementById("fallbackBasePizza");
  psel.innerHTML="";
  for(const k of Object.keys(CATALOG.pizzas||{}).sort()){
    const o=document.createElement("option"); o.value=k; o.textContent=k; psel.appendChild(o);
  }
  if(!SETTINGS.fallbackBasePizza || !(SETTINGS.fallbackBasePizza in (CATALOG.pizzas||{}))){
    SETTINGS.fallbackBasePizza = ("margherita" in (CATALOG.pizzas||{})) ? "margherita" : (Object.keys(CATALOG.pizzas||{})[0]||"margherita");
  }
  psel.value=SETTINGS.fallbackBasePizza;

  const ssel=document.getElementById("fallbackSize");
  ssel.innerHTML="";
  for(const k of Object.keys(CATALOG.sizes||{}).sort()){
    const o=document.createElement("option"); o.value=k; o.textContent=k; ssel.appendChild(o);
  }
  if(!SETTINGS.fallbackSize || !(SETTINGS.fallbackSize in (CATALOG.sizes||{}))){
    SETTINGS.fallbackSize = ("normale" in (CATALOG.sizes||{})) ? "normale" : (Object.keys(CATALOG.sizes||{})[0]||"normale");
  }
  ssel.value=SETTINGS.fallbackSize;

  document.getElementById("printMode").value=SETTINGS.printMode;
  document.getElementById("deliveryFee").value=money(Number(SETTINGS.deliveryFee||0));
  document.getElementById("printModeMini").textContent = `Stampa: ${SETTINGS.printMode==="both"?"entrambe":SETTINGS.printMode==="kitchen"?"solo cucina":"solo ricevuta"}`;
}

function applySettingsFromUI(){
  SETTINGS.printMode=document.getElementById("printMode").value;
  SETTINGS.deliveryFee=Number(String(document.getElementById("deliveryFee").value).replace(",",".")||0);
  SETTINGS.fallbackBasePizza=document.getElementById("fallbackBasePizza").value || SETTINGS.fallbackBasePizza;
  SETTINGS.fallbackSize=document.getElementById("fallbackSize").value || SETTINGS.fallbackSize;
  saveSettings(SETTINGS);
  refreshOptions();
  if(CONF) renderOutputsFromConf();
}

function generate(){
  ensureDaily();
  const raw=document.getElementById("input").value||"";
  if(!raw.trim()){
    DRAFT=null; CONF=null;
    renderOutputsFromConf();
    setStatus("");
    return;
  }
  DRAFT = parseDraft(CATALOG, SETTINGS, raw);
  CONF = normalizeConfFromDraft(DRAFT);
  renderOutputsFromConf();
  setStatus("Generato: apri Conferma per verificare/modificare.","ok");
}

async function copyOutput(){
  const k=document.getElementById("outKitchen").textContent||"";
  const r=document.getElementById("outReceipt").textContent||"";
  let out="";
  if(SETTINGS.printMode==="both") out=k+"\n\n"+r;
  else if(SETTINGS.printMode==="kitchen") out=k;
  else out=r;
  if(!out.trim()||out.trim()==="—") return;
  try{ await navigator.clipboard.writeText(out); setStatus("Copiato.","ok"); }catch{ setStatus("Copia non disponibile.","warn"); }
}

function printNow(){
  const kitchen=document.getElementById("outKitchen");
  const receipt=document.getElementById("outReceipt");
  const prevK=kitchen.style.display, prevR=receipt.style.display;

  if(SETTINGS.printMode==="kitchen"){ kitchen.style.display="block"; receipt.style.display="none"; }
  else if(SETTINGS.printMode==="receipt"){ kitchen.style.display="none"; receipt.style.display="block"; }
  else { kitchen.style.display="block"; receipt.style.display="block"; }

  window.print();
  kitchen.style.display=prevK; receipt.style.display=prevR;
}

function closeDay(){
  document.getElementById("input").value="";
  DRAFT=null; CONF=null;
  document.getElementById("outKitchen").textContent="—";
  document.getElementById("outReceipt").textContent="—";
  document.getElementById("outDebug").textContent="—";
  document.getElementById("totalMini").textContent="Totale: —";
  localStorage.setItem(LS.lastDay, todayKey());
  setStatus("Chiusura serale: pulito.","ok");
}

/* ================= MODALS ================= */
const modalSettings=document.getElementById("modalSettings");
document.getElementById("openSettings").addEventListener("click",()=>modalSettings.classList.add("open"));
document.getElementById("closeSettings").addEventListener("click",()=>modalSettings.classList.remove("open"));
modalSettings.addEventListener("click",(e)=>{ if(e.target===modalSettings) modalSettings.classList.remove("open"); });

const modalConfirm=document.getElementById("modalConfirm");
document.getElementById("openConfirm").addEventListener("click",()=>{
  if(!CONF){
    // if user didn’t press generate yet, do it now
    generate();
  }
  if(!CONF){
    setStatus("Incolla un messaggio e premi Genera.","warn");
    return;
  }
  renderConfirm();
  modalConfirm.classList.add("open");
});
document.getElementById("closeConfirm").addEventListener("click",()=>modalConfirm.classList.remove("open"));
modalConfirm.addEventListener("click",(e)=>{ if(e.target===modalConfirm) modalConfirm.classList.remove("open"); });

/* ================= CATALOG BUTTONS ================= */
document.getElementById("saveCatalog").addEventListener("click",()=>{
  try{
    const obj=JSON.parse(document.getElementById("catalog").value);
    obj.pizzas ||= {}; obj.drinks ||= {}; obj.extras ||= {}; obj.doughs ||= {}; obj.sizes ||= {}; obj.formats ||= {}; obj.aliases ||= {};
    CATALOG=obj; saveCatalog(CATALOG);
    setCatStatus("Catalogo salvato.","ok");
    refreshOptions();
    // re-render confirm checkboxes/options
    if(CONF) renderConfirm();
    if(CONF) renderOutputsFromConf();
  }catch{ setCatStatus("Errore JSON.","warn"); }
});
document.getElementById("resetCatalog").addEventListener("click",()=>{
  CATALOG=structuredClone(SAMPLE_CATALOG); saveCatalog(CATALOG);
  setCatalogTextarea();
  setCatStatus("Ripristinato esempio.","ok");
  refreshOptions();
  if(CONF) renderConfirm();
  if(CONF) renderOutputsFromConf();
});
document.getElementById("exportCatalog").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(JSON.stringify(CATALOG,null,2)); setCatStatus("Export copiato.","ok"); }
  catch{ setCatStatus("Export non riuscito.","warn"); }
});
document.getElementById("importCatalog").addEventListener("click",()=>{
  const pasted=prompt("Incolla JSON catalogo:");
  if(!pasted) return;
  try{
    CATALOG=JSON.parse(pasted); saveCatalog(CATALOG);
    setCatalogTextarea();
    setCatStatus("Import OK.","ok");
    refreshOptions();
    if(CONF) renderConfirm();
    if(CONF) renderOutputsFromConf();
  }catch{ setCatStatus("Import fallito.","warn"); }
});

/* ================= SETTINGS INPUTS ================= */
document.getElementById("printMode").addEventListener("change",applySettingsFromUI);
document.getElementById("deliveryFee").addEventListener("change",applySettingsFromUI);
document.getElementById("fallbackBasePizza").addEventListener("change",applySettingsFromUI);
document.getElementById("fallbackSize").addEventListener("change",applySettingsFromUI);

/* ================= TABS ================= */
for(const t of document.querySelectorAll(".tab")){
  t.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const view=t.getAttribute("data-view");
    document.getElementById("outKitchen").style.display=(view==="kitchen")?"block":"none";
    document.getElementById("outReceipt").style.display=(view==="receipt")?"block":"none";
    document.getElementById("outDebug").style.display=(view==="debug")?"block":"none";
  });
}

/* ================= BUTTONS ================= */
document.getElementById("gen").addEventListener("click",generate);
document.getElementById("copy").addEventListener("click",copyOutput);
document.getElementById("print").addEventListener("click",printNow);
document.getElementById("closeDay").addEventListener("click",closeDay);

/* ================= INIT ================= */
function init(){
  ensureDaily();
  setCatalogTextarea();
  refreshOptions();
  bindConfirmEvents();
  // render empty
  renderOutputsFromConf();
}
init();
</script>
</body>
</html>
