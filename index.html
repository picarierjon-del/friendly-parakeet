<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Gestionale WhatsApp | Pro Edition</title>
  <style>
    :root {
      --bg: #0b1220; --text: #e5e7eb; --muted: #9ca3af; --border: rgba(255,255,255,.10);
      --accent: #60a5fa; --ok: #34d399; --warn: #fbbf24; --danger: #fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; --radius: 16px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--sans); background: linear-gradient(180deg, #070b14, var(--bg)); color: var(--text); min-height: 100vh; }
    .app { max-width: 980px; margin: 0 auto; padding: 14px 14px 100px; }
    
    /* Topbar */
    .topbar { 
      display: flex; align-items: center; justify-content: space-between; gap: 10px; position: sticky; top: 0; z-index: 5;
      background: rgba(7, 11, 20, 0.75); backdrop-filter: blur(12px); padding: 12px 16px; border-bottom: 1px solid var(--border);
      border-radius: 0 0 18px 18px; margin-bottom: 16px;
    }
    .title h1 { font-size: 16px; margin: 0; font-weight: 800; background: linear-gradient(90deg, #fff, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .title .sub { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Layout */
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media(min-width: 860px) { .grid { grid-template-columns: 1.05fr 0.95fr; } }
    
    .card { border: 1px solid var(--border); border-radius: var(--radius); background: rgba(255,255,255,0.03); overflow: hidden; height: fit-content; }
    .cardhead { padding: 12px 16px; background: rgba(255,255,255,0.04); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .cardhead h2 { margin: 0; font-size: 13px; font-weight: 700; color: var(--accent); }
    .cardbody { padding: 16px; }

    textarea { width: 100%; min-height: 280px; background: rgba(0,0,0,0.3); color: var(--text); border: 1px solid var(--border); border-radius: 12px; padding: 14px; font-size: 14px; outline: none; transition: 0.2s; }
    textarea:focus { border-color: var(--accent); background: rgba(0,0,0,0.4); }
    
    .btnrow { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .btn { border: 1px solid var(--border); background: rgba(255,255,255,0.06); color: var(--text); border-radius: 12px; padding: 10px 16px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn.primary { background: var(--accent); color: #000; border: none; }
    .btn.danger { border-color: var(--danger); color: var(--danger); background: rgba(251, 113, 133, 0.05); }
    .btn:active { transform: scale(0.97); }

    .tabs { display: flex; gap: 4px; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 10px; }
    .tab { padding: 6px 12px; font-size: 12px; font-weight: 700; border-radius: 7px; cursor: pointer; color: var(--muted); border: none; background: none; }
    .tab.active { background: var(--accent); color: #000; }

    .out { font-family: var(--mono); white-space: pre-wrap; font-size: 13px; background: #000; border-radius: 12px; padding: 16px; min-height: 280px; border: 1px solid var(--border); color: #adbac7; }
    .pill { font-size: 10px; color: var(--muted); border: 1px solid var(--border); padding: 2px 8px; border-radius: 20px; font-weight: 700; }
    .iconbtn { background: none; border: 1px solid var(--border); color: var(--text); border-radius: 10px; padding: 8px; cursor: pointer; }

    /* Bottom Bar */
    .bottombar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(7, 11, 20, 0.9); backdrop-filter: blur(15px); border-top: 1px solid var(--border); padding: 12px 20px; z-index: 6; }
    .bottomwrap { max-width: 980px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .stat { font-size: 13px; font-weight: 800; }
    .stat span { color: var(--accent); }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: flex-end; justify-content: center; z-index: 100; }
    .modal.open { display: flex; }
    .sheet { width: min(980px, 100%); background: var(--bg); border: 1px solid var(--border); border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow: auto; }
    .section { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 16px; padding: 16px; margin-bottom: 16px; }
    .section h4 { margin: 0 0 12px; font-size: 12px; text-transform: uppercase; color: var(--accent); letter-spacing: 1px; }
    
    label { display: block; margin-bottom: 12px; font-size: 12px; color: var(--muted); }
    input, select { width: 100%; background: #000; color: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-top: 4px; }

    @media print {
      body { background: #fff; color: #000; }
      .topbar, .bottombar, .no-print, .modal, .btnrow { display: none !important; }
      .app { padding: 0; }
      .grid { display: block; }
      .card { border: none; }
      .out { border: none; background: none; color: #000; }
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="topbar">
      <div class="title">
        <h1>WA Order Manager</h1>
        <div class="sub" id="dayBadge">Inizializzazione...</div>
      </div>
      <button id="openSettings" class="iconbtn">⚙️</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardhead">
          <h2>Input Ordine</h2>
          <span class="pill" id="extractBadge">Auto-Detect</span>
        </div>
        <div class="cardbody">
          <textarea id="input" placeholder="Incolla l'ordine qui..."></textarea>
          <div class="btnrow no-print">
            <button id="gen" class="btn primary">Genera ✨</button>
            <button id="copy" class="btn">Copia</button>
            <button id="print" class="btn">Stampa</button>
            <button id="closeDay" class="btn danger">Nuovo Giorno</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardhead">
          <div class="tabs no-print">
            <button class="tab active" data-view="kitchen">Cucina</button>
            <button class="tab" data-view="receipt">Ricevuta</button>
            <button class="tab" data-view="debug">Debug</button>
          </div>
        </div>
        <div class="cardbody">
          <div id="outKitchen" class="out">In attesa...</div>
          <div id="outReceipt" class="out" style="display:none">In attesa...</div>
          <div id="outDebug" class="out" style="display:none">In attesa...</div>
          <div id="status" class="status no-print" style="margin-top:10px; font-size:11px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottombar no-print">
    <div class="bottomwrap">
      <div class="stat">Totale: <span id="totalMini">€ 0.00</span></div>
      <div class="stat">Articoli: <span id="qtyMini">0</span></div>
      <div class="stat" id="printModeMini" style="font-size:11px; color:var(--muted)">Stampa: Both</div>
    </div>
  </div>

  <div id="modal" class="modal no-print">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0">Configurazione</h3>
        <button id="closeSettings" class="iconbtn">✕</button>
      </div>

      <div class="section">
        <h4>Parametri Generali</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <label>Costo Consegna<input id="deliveryFee" type="number" step="0.5"></label>
          <label>Pizza Base Custom<select id="fallbackBasePizza"></select></label>
        </div>
        <label>Modalità Stampa
          <select id="printMode">
            <option value="both">Entrambe (Cucina + Ricevuta)</option>
            <option value="kitchen">Solo Cucina</option>
            <option value="receipt">Solo Ricevuta</option>
          </select>
        </label>
      </div>

      <div class="section">
        <h4>Catalogo JSON</h4>
        <textarea id="catalog" style="min-height:200px; font-family:var(--mono); font-size:12px;"></textarea>
        <div class="btnrow">
          <button id="saveCatalog" class="btn primary">Salva</button>
          <button id="resetCatalog" class="btn">Reset</button>
        </div>
      </div>
    </div>
  </div>

<script>
// --- LOGICA CORE ---
const LS = { catalog:"wa_cat_v5", settings:"wa_set_v5", lastDay:"wa_day_v5" };

const SAMPLE_CATALOG = {
  currency:"€",
  pizzas:{ "margherita":6.00, "diavola":7.50, "prosciutto":7.50, "salame piccante":7.50, "salsiccia porcini e grana":9.50 },
  drinks:{ "coca cola 33":2.50, "acqua 0.5":1.50, "birra 33":3.50 },
  extras:{ "speck":1.50, "brie":1.50, "porcini":2.00, "grana":1.00, "cipolla":0.80 },
  doughs:{ "classico":0.00, "integrale":1.00, "senza glutine":3.00 },
  sizes:{ "normale":0.00, "baby":-1.00, "maxi":2.00 },
  aliases:{ "marg":"margherita", "coca":"coca cola 33", "sg":"senza glutine", "s.g.":"senza glutine" }
};

const DEFAULT_SETTINGS = { printMode:"both", deliveryFee:0, halfHalfPricing:"max", halfHalfExtras:"full", fallbackBasePizza:"margherita" };

let CATALOG = JSON.parse(localStorage.getItem(LS.catalog)) || structuredClone(SAMPLE_CATALOG);
let SETTINGS = JSON.parse(localStorage.getItem(LS.settings)) || structuredClone(DEFAULT_SETTINGS);

// --- FUNZIONI DI SUPPORTO ---
function safeLower(s){ return (s||"").toLowerCase().trim(); }
function money(n){ return n.toFixed(2); }

function parseOrder(rawText) {
  // 1. Estrazione blocco utile (Logica Stop Phrases)
  const lines = rawText.split('\n').map(l => l.trim()).filter(Boolean);
  let o = { name:"", address:"", items:[], total:0, qty:0, mode:"RITIRO", time:"" };

  // 2. Metadati veloci
  const textAll = rawText.toLowerCase();
  if(/\b(consegna|via|viale|piazza)\b/.test(textAll)) o.mode = "CONSEGNA";
  const tm = rawText.match(/(\d{1,2})[.:](\d{2})/);
  if(tm) o.time = tm[0];

  lines.forEach(line => {
    const l = safeLower(line);
    
    // Esclusione nomi ALL CAPS (Clienti) dagli articoli
    const isAllCaps = line === line.toUpperCase() && /[A-Z]/.test(line) && line.length > 4;
    
    // Riconoscimento articoli (Qty + Testo)
    const m = line.match(/^(\d+)\s+(.+)$/);
    if(m && !isAllCaps) {
      const q = parseInt(m[1]);
      let txt = m[2].toLowerCase();
      
      // Risoluzione Alias & Prezzi
      let baseKey = CATALOG.aliases[txt] || txt;
      let price = 0;
      let found = false;

      // Cerca in Pizze
      for(let p in CATALOG.pizzas) {
        if(txt.includes(p)) { price = CATALOG.pizzas[p]; baseKey = p; found = true; break; }
      }
      // Se non trovata e c'è un impasto speciale, usa la fallback base
      if(!found && (txt.includes("senza glutine") || txt.includes("sg"))) {
         price = CATALOG.pizzas[SETTINGS.fallbackBasePizza] || 0;
         baseKey = SETTINGS.fallbackBasePizza;
         found = true;
      }

      // Extra
      if(txt.includes("senza glutine") || txt.includes("sg")) price += CATALOG.doughs["senza glutine"];
      
      // Calcolo finali
      o.items.push({ qty: q, label: line.replace(/^\d+\s+/, ""), price: price, sub: price * q });
      o.total += price * q;
      o.qty += q;
    } else {
      // Se non è articolo, prova a mappare indirizzo o nome
      if(/\b(via|viale|piazza)\b/.test(l)) o.address = line;
      else if(isAllCaps && !o.name) o.name = line;
    }
  });

  if(o.mode === "CONSEGNA") o.total += Number(SETTINGS.deliveryFee);
  return o;
}

// --- RENDERERS ---
function renderKitchen(o) {
  let res = `--- COMANDA CUCINA ---\nORA: ${o.time || '--:--'} | ${o.mode}\nCLIENTE: ${o.name || 'N.D.'}\nIND: ${o.address || 'ASPORTO'}\n----------------------\n`;
  o.items.forEach(i => res += `${i.qty}x ${i.label.toUpperCase()}\n`);
  res += `----------------------\nTOTALE PIZZE: ${o.qty}`;
  return res;
}

function renderReceipt(o) {
  let res = `--- RICEVUTA CLIENTE ---\n`;
  o.items.forEach(i => res += `${i.qty} x ${i.label} -> €${money(i.sub)}\n`);
  if(o.mode === "CONSEGNA") res += `Consegna: €${money(Number(SETTINGS.deliveryFee))}\n`;
  res += `----------------------\nTOTALE: €${money(o.total)}`;
  return res;
}

// --- UI HANDLERS ---
function init() {
  const d = new Date();
  document.getElementById("dayBadge").textContent = d.toLocaleDateString('it-IT', { weekday: 'long', day: 'numeric', month: 'long' });
  document.getElementById("catalog").value = JSON.stringify(CATALOG, null, 2);
  document.getElementById("deliveryFee").value = SETTINGS.deliveryFee;
  
  // Popola select fallback
  const sel = document.getElementById("fallbackBasePizza");
  Object.keys(CATALOG.pizzas).forEach(p => {
    let opt = new Option(p, p);
    if(p === SETTINGS.fallbackBasePizza) opt.selected = true;
    sel.add(opt);
  });
}

document.getElementById("gen").onclick = () => {
  const order = parseOrder(document.getElementById("input").value);
  document.getElementById("outKitchen").textContent = renderKitchen(order);
  document.getElementById("outReceipt").textContent = renderReceipt(order);
  document.getElementById("totalMini").textContent = `€ ${money(order.total)}`;
  document.getElementById("qtyMini").textContent = order.qty;
  
  // Debug info
  document.getElementById("outDebug").textContent = JSON.stringify(order, null, 2);
};

document.getElementById("openSettings").onclick = () => document.getElementById("modal").classList.add("open");
document.getElementById("closeSettings").onclick = () => document.getElementById("modal").classList.remove("open");

document.getElementById("saveCatalog").onclick = () => {
  try {
    CATALOG = JSON.parse(document.getElementById("catalog").value);
    SETTINGS.deliveryFee = document.getElementById("deliveryFee").value;
    SETTINGS.fallbackBasePizza = document.getElementById("fallbackBasePizza").value;
    SETTINGS.printMode = document.getElementById("printMode").value;
    
    localStorage.setItem(LS.catalog, JSON.stringify(CATALOG));
    localStorage.setItem(LS.settings, JSON.stringify(SETTINGS));
    alert("Salvato correttamente!");
    location.reload();
  } catch(e) { alert("Errore nel JSON!"); }
};

document.getElementById("copy").onclick = () => {
  const activeTab = document.querySelector(".tab.active").getAttribute("data-view");
  const text = activeTab === "kitchen" ? document.getElementById("outKitchen").textContent : document.getElementById("outReceipt").textContent;
  navigator.clipboard.writeText(text);
  document.getElementById("status").textContent = "Copiato!";
};

document.getElementById("print").onclick = () => window.print();

document.querySelectorAll(".tab").forEach(t => {
  t.onclick = () => {
    document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    const v = t.getAttribute("data-view");
    document.getElementById("outKitchen").style.display = (v === "kitchen" ? "block" : "none");
    document.getElementById("outReceipt").style.display = (v === "receipt" ? "block" : "none");
    document.getElementById("outDebug").style.display = (v === "debug" ? "block" : "none");
  };
});

init();
</script>
</body>
</html>
