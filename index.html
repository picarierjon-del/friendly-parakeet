<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>COMMANDER √âLITE V12 - TOTAL CONTROL</title>
  <style>
    :root {
      --bg: #020617; --surface: #0f172a; --surface-alt: #1e293b;
      --accent: #38bdf8; --text: #f8fafc; --text-dim: #94a3b8;
      --success: #22c55e; --danger: #ef4444; --border: rgba(255,255,255,0.1);
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 50px; }
    .app { max-width: 1400px; margin: 0 auto; padding: 1rem; display: grid; gap: 1rem; }
    @media (min-width: 1024px) { .app { grid-template-columns: 1fr 1.2fr; } }

    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .card-h { padding: 1rem; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-weight: 800; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .card-b { padding: 1rem; }

    textarea { width: 100%; min-height: 200px; background: #000; color: #10b981; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; outline: none; }

    .btn { padding: 0.7rem 1rem; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; user-select: none; }
    .btn:active { transform: translateY(1px); }
    .btn-main { background: var(--accent); color: #000; }
    .btn-sec { background: var(--surface-alt); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warn { background: var(--warn); color: #000; }

    /* Output per Stampante 80mm */
    .output-wrap { background: #111; overflow-x: auto; padding: 1rem; }
    .output-box { background: #fff; color: #000; padding: 10mm; font-family: 'Courier New', ui-monospace, monospace; font-size: 14px; border: 1px solid #ddd; width: 80mm; margin: 0 auto; line-height: 1.2; box-shadow: 0 0 20px rgba(0,0,0,0.5); white-space: pre; }

    /* Modal / Editor Styles */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; z-index: 1000; padding: 1rem; overflow-y: auto; }
    .modal.open { display: flex; justify-content: center; }
    .modal-sheet { background: var(--surface); width: 100%; max-width: 900px; height: fit-content; border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin: 2rem 0; }

    .order-row { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
    .row-main { display: grid; grid-template-columns: 70px 1fr 120px 44px; gap: 10px; margin-bottom: 10px; align-items: end; }
    .row-options { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    select, input { background: #000; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; font-size: 13px; width: 100%; }
    label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; display: block; margin-bottom: 3px; letter-spacing: .04em; }

    .hint { color: var(--text-dim); font-size: 12px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 12px; color: var(--text-dim); background: rgba(255,255,255,0.03); }
    .pill strong { color: var(--text); font-weight: 800; }

    @media print {
      .no-print { display: none !important; }
      body { background: white; padding-bottom: 0; }
      .output-wrap { padding: 0; background: white; }
      .output-box { border: none; box-shadow: none; width: 80mm; margin: 0; padding: 5mm; }
      @page { size: 80mm auto; margin: 0; }
    }
  </style>
</head>
<body>

<div class="app">
  <header class="no-print">
    <div>
      <div style="font-weight: 900; font-size: 1.6rem; color: var(--accent);">COMMANDER √âLITE <span style="color:white; font-weight:300">V12</span></div>
      <div id="clock" style="font-size: 12px; color: var(--text-dim);">...</div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill">Modalit√†: <strong id="pill-mode">‚Äî</strong></span>
        <span class="pill">Totale: <strong id="pill-total">‚Ç¨ 0,00</strong></span>
        <span class="pill">Righe: <strong id="pill-rows">0</strong></span>
      </div>
    </div>
    <div style="display: flex; gap: 8px; align-items:center; flex-wrap:wrap;">
      <button class="btn btn-sec" onclick="App.openSettings()">‚öôÔ∏è MENU</button>
      <button class="btn btn-warn" onclick="App.exportHistory()">‚¨áÔ∏è ESPORTA STORICO</button>
      <button class="btn btn-danger" onclick="App.nightClosure()">üåô CHIUSURA SERALE</button>
    </div>
  </header>

  <div class="card no-print">
    <div class="card-h">
      <span>üì• WHATSAPP INPUT</span>
      <span class="hint">Suggerimento: ‚Äú2 margherita bufala‚Äù, ‚Äú1 diavola grande‚Äù, ‚Äúore 19:30‚Äù, ‚Äúvia roma 10‚Äù</span>
    </div>
    <div class="card-b">
      <textarea id="raw-input" placeholder="Incolla qui l'ordine..."></textarea>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1rem;">
        <button class="btn btn-main" onclick="App.process()">‚ö° ANALISI INTELLIGENTE</button>
        <button class="btn btn-sec" onclick="App.openEditor()">‚úèÔ∏è GESTIONALE AVANZATO</button>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button class="btn btn-sec" onclick="App.demoFill()">üß™ ESEMPIO</button>
        <button class="btn btn-sec" onclick="App.clearInput()">üßπ PULISCI</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-h no-print">
      <span>üñ®Ô∏è ANTEPRIMA 80mm</span>
      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn btn-sec" onclick="App.copyTicket()">üìã COPIA</button>
        <button class="btn btn-main" onclick="window.print()">STAMPA IPHONE</button>
      </div>
    </div>
    <div class="output-wrap">
      <div id="output" class="output-box">In attesa...</div>
    </div>
  </div>
</div>

<div id="modal-editor" class="modal no-print" onclick="App.backdropClose(event)">
  <div class="modal-sheet">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:12px;">
      <h2 style="margin:0;">‚úèÔ∏è Gestionale Ordine</h2>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-sec" onclick="App.closeModals()">Chiudi</button>
      </div>
    </div>

    <div class="row-options" style="margin-bottom:20px; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
      <div><label>Cliente</label><input type="text" id="edt-customer"></div>
      <div><label>Orario</label><input type="text" id="edt-time"></div>
      <div><label>Indirizzo/Note</label><input type="text" id="edt-address"></div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
      <span class="pill">Rilevato: <strong id="edt-detected">‚Äî</strong></span>
      <span class="pill">Consegna: <strong id="edt-fee">‚Ç¨ 0,00</strong></span>
    </div>

    <div id="edt-items-list"></div>

    <button class="btn btn-sec" style="width:100%; margin-top:10px;" onclick="App.addOrderItem()">‚ûï AGGIUNGI PIZZA</button>

    <div style="margin-top:20px; padding:20px; background:var(--surface-alt); border-radius:12px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
      <div style="font-weight:900; font-size:1.2rem;">TOTALE: <span id="edt-total" style="color:var(--success)">‚Ç¨ 0.00</span></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-sec" onclick="App.closeModals()">Annulla</button>
        <button class="btn btn-main" onclick="App.saveOrderEdits()">üöÄ CONFERMA E GENERA COMANDA</button>
      </div>
    </div>
  </div>
</div>

<div id="modal-settings" class="modal no-print" onclick="App.backdropClose(event)">
  <div class="modal-sheet">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <h2 style="margin:0;">‚öôÔ∏è Configurazione Catalogo</h2>
      <button class="btn btn-sec" onclick="App.closeModals()">Chiudi</button>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 18px;">
      <span class="pill">Consegna: <strong id="cfg-fee-pill">‚Ç¨ 0,00</strong></span>
      <button class="btn btn-sec" onclick="App.resetConfig()">‚ôªÔ∏è RESET DEFAULT</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div>
        <h3 style="display:flex; justify-content:space-between; align-items:center;">
          <span>Pizze</span>
          <button class="btn btn-sec" style="padding:2px 8px; font-size:12px" onclick="App.addCatalogItem('pizzas')">+</button>
        </h3>
        <div id="cfg-pizzas"></div>
      </div>
      <div>
        <h3 style="display:flex; justify-content:space-between; align-items:center;">
          <span>Impasti / Formati</span>
          <button class="btn btn-sec" style="padding:2px 8px; font-size:12px" onclick="App.addCatalogItem('variations')">+</button>
        </h3>
        <div id="cfg-variations"></div>

        <h3 style="display:flex; justify-content:space-between; align-items:center; margin-top:16px;">
          <span>Extra</span>
          <button class="btn btn-sec" style="padding:2px 8px; font-size:12px" onclick="App.addCatalogItem('extras')">+</button>
        </h3>
        <div id="cfg-extras"></div>

        <h3 style="display:flex; justify-content:space-between; align-items:center; margin-top:16px;">
          <span>Consegna</span>
        </h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="number" step="0.5" id="cfg-delivery-fee" style="max-width:140px;">
          <span class="hint">‚Ç¨</span>
        </div>
      </div>
    </div>

    <button class="btn btn-main" style="width:100%; margin-top:2rem;" onclick="App.saveSettings()">üíæ SALVA CONFIGURAZIONE</button>
  </div>
</div>

<script>
/**
 * Commander √âlite V12 - refactor
 * Obiettivi:
 * - Lettura ordine pi√π robusta (normalizzazione, sinonimi, parsing quantit√†, impasto/formato, extra, note)
 * - Gestione pi√π sicura (sanitizzazione HTML, no inline onchange con stringhe)
 * - Totali coerenti (calcolo centralizzato)
 * - Storico semplice + export JSON
 */

const App = {
  // ---------- DEFAULT CONFIG ----------
  defaultConfig() {
    return {
      pizzas: { "margherita": 6.5, "diavola": 8.0, "capricciosa": 9.5, "quattro stagioni": 9.5, "napoli": 7.5 },
      variations: { "normale": 0, "integrale": 1.5, "verace": 2.0, "senza glutine": 3.0, "mezzo metro": 15.0, "grande": 2.5 },
      extras: { "nessuno": 0, "bufala": 2.0, "speck": 1.5, "brie": 1.5, "crudo": 2.5, "porcini": 2.0, "cipolla": 0.5 },
      deliveryFee: 2.0,
      history: []
    };
  },

  config: null,
  order: null,

  // ---------- UTILS ----------
  $: (sel) => document.querySelector(sel),
  $$: (sel) => Array.from(document.querySelectorAll(sel)),

  money(v) {
    const n = Number(v || 0);
    return n.toFixed(2);
  },

  moneyIt(v) {
    // format semplice IT (virgola) senza Intl per evitare sorprese su vecchi iOS
    const s = this.money(v).replace('.', ',');
    return `‚Ç¨ ${s}`;
  },

  safeText(s) {
    // converte in stringa e rimuove controlli strani
    return String(s ?? '').replace(/[\u0000-\u001F\u007F]/g, '').trim();
  },

  escHtml(s) {
    return this.safeText(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  },

  normalize(s) {
    // normalizzazione forte: minuscole, spazi puliti, accenti base
    let t = this.safeText(s).toLowerCase();
    t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // rimuovi diacritici
    t = t.replace(/[‚Ä¢¬∑\t]/g, ' ');
    t = t.replace(/\s+/g, ' ').trim();
    return t;
  },

  // match "19:30", "19.30", "ore 19:30", "h 19.30"
  parseTimeFromLine(line) {
    const m = line.match(/(?:ore|h)?\s*(\d{1,2})[:.](\d{2})/i);
    if(!m) return null;
    let hh = parseInt(m[1], 10);
    let mm = parseInt(m[2], 10);
    if(Number.isNaN(hh) || Number.isNaN(mm)) return null;
    if(hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
    return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
  },

  isDeliveryLine(line) {
    // euristiche: presenza indirizzo o parole chiave consegna/domicilio
    const hasStreet = /(via|v\.|viale|piazza|p\.zza|corso|c\.so|largo|vicolo|strada|st\.|localita|loc\.|km)\b/.test(line);
    const deliveryKw = /(consegna|a domicilio|domicilio|delivery)\b/.test(line);
    return hasStreet || deliveryKw;
  },

  // quantit√†: "2 margherite", "x2 margherita", "2x margherita", "n.2 margherita"
  parseQtyAndText(line) {
    let l = line.trim();

    // x2 / 2x / n.2
    let m = l.match(/^(?:n\.?\s*)?(\d{1,2})\s*(?:x)?\s+(.*)$/i);
    if(!m) m = l.match(/^x\s*(\d{1,2})\s+(.*)$/i);
    if(!m) m = l.match(/^(\d{1,2})x\s*(.*)$/i);

    if(m) {
      const qty = Math.max(1, parseInt(m[1], 10));
      const text = (m[2] || '').trim();
      return { qty, text };
    }
    return null;
  },

  // ---------- "SMART" DICTIONARIES ----------
  getSynonyms() {
    return {
      pizzas: {
        // alias -> chiave config
        "margherita": "margherita",
        "margherite": "margherita",
        "marghe": "margherita",
        "margerita": "margherita",

        "diavola": "diavola",
        "diavolo": "diavola",

        "capricciosa": "capricciosa",
        "capricci": "capricciosa",

        "4 stagioni": "quattro stagioni",
        "quattro stagioni": "quattro stagioni",
        "4stagioni": "quattro stagioni",

        "napoli": "napoli"
      },
      variations: {
        "normale": "normale",
        "integrale": "integrale",
        "verace": "verace",
        "sg": "senza glutine",
        "senza glutine": "senza glutine",
        "gluten free": "senza glutine",
        "gf": "senza glutine",

        "mezzo metro": "mezzo metro",
        "1/2 metro": "mezzo metro",
        "mezzo": "mezzo metro",

        "grande": "grande",
        "maxi": "grande"
      },
      extras: {
        "nessuno": "nessuno",
        "bufala": "bufala",
        "mozzarella di bufala": "bufala",
        "speck": "speck",
        "brie": "brie",
        "crudo": "crudo",
        "prosciutto crudo": "crudo",
        "porcini": "porcini",
        "cipolla": "cipolla"
      }
    };
  },

  // trova una chiave config in base al testo (usa sinonimi + contains su chiavi config)
  detectFromText(text, type) {
    const t = this.normalize(text);
    const syn = this.getSynonyms()[type] || {};
    const keys = Object.keys(this.config[type] || {});

    // 1) prova match sinonimi pi√π lunghi prima
    const synEntries = Object.entries(syn).sort((a,b) => b[0].length - a[0].length);
    for(const [alias, key] of synEntries) {
      if(t.includes(alias)) return key;
    }

    // 2) fallback: match su chiavi config (pi√π lunghe prima)
    const sortedKeys = keys.slice().sort((a,b) => b.length - a.length);
    for(const k of sortedKeys) {
      if(t.includes(k)) return k;
    }

    return null;
  },

  detectNote(text) {
    const t = this.normalize(text);
    const notes = [];

    if(/\bmeta\b|\bmet[a√†]\b|\bmezza\b/.test(t)) notes.push("DIVISA A MET√Ä");
    if(/\bsenza\b.*\b(cipolla|aglio|piccante|origano)\b/.test(t)) notes.push("SENZA (vedi testo)");
    if(/\bbene cotta\b/.test(t)) notes.push("BENE COTTA");
    if(/\bpoco cotta\b/.test(t)) notes.push("POCO COTTA");

    // se c'√® testo residuo utile, lo metto come nota libera (max 40 char)
    const raw = this.safeText(text);
    const compact = raw.length > 40 ? raw.slice(0, 40) + "‚Ä¶" : raw;
    if(compact && notes.length === 0) {
      // non invadere: aggiungi solo se c'√® una keyword "nota"
      if(/\bnota\b|\bnote\b|\bper favore\b|\bpf\b/i.test(raw)) notes.push(compact);
    }

    return notes.join(" | ");
  },

  computeLine(it) {
    const base = Number(it.price || 0);
    const vAdd = Number(this.config.variations[it.impasto] ?? 0);
    const eAdd = Number(this.config.extras[it.extra] ?? 0);
    const qty = Math.max(1, parseInt(it.qty || 1, 10));
    const unit = base + vAdd + eAdd;
    const total = unit * qty;
    return { unit, total };
  },

  computeOrder(o) {
    let subtotal = 0;
    for(const it of o.items) {
      subtotal += this.computeLine(it).total;
    }
    let fee = 0;
    if(o.mode === "CONSEGNA") fee = Number(this.config.deliveryFee || 0);
    const total = subtotal + fee;
    return { subtotal, fee, total };
  },

  // ---------- INIT ----------
  init() {
    const saved = localStorage.getItem('commander_v12_cfg');
    this.config = saved ? this.safeJsonParse(saved, this.defaultConfig()) : this.defaultConfig();

    // clock
    setInterval(() => {
      const el = document.getElementById('clock');
      if(el) el.textContent = new Date().toLocaleString();
    }, 1000);

    // shortcut: CTRL/CMD+Enter per analizzare
    document.addEventListener('keydown', (e) => {
      const ta = document.getElementById('raw-input');
      if(!ta) return;
      const isCmdEnter = (e.key === 'Enter' && (e.ctrlKey || e.metaKey));
      if(isCmdEnter && document.activeElement === ta) this.process();
      if(e.key === 'Escape') this.closeModals();
    });

    this.updatePills();
  },

  safeJsonParse(str, fallback) {
    try { return JSON.parse(str); } catch { return fallback; }
  },

  updatePills() {
    const modeEl = document.getElementById('pill-mode');
    const totalEl = document.getElementById('pill-total');
    const rowsEl = document.getElementById('pill-rows');
    if(!modeEl || !totalEl || !rowsEl) return;

    if(!this.order) {
      modeEl.textContent = "‚Äî";
      totalEl.textContent = this.moneyIt(0);
      rowsEl.textContent = "0";
      return;
    }
    const sums = this.computeOrder(this.order);
    modeEl.textContent = this.order.mode;
    totalEl.textContent = this.moneyIt(sums.total);
    rowsEl.textContent = String(this.order.items.length);
  },

  clearInput() {
    document.getElementById('raw-input').value = "";
    document.getElementById('output').textContent = "Pronto...";
    this.order = null;
    this.updatePills();
  },

  demoFill() {
    document.getElementById('raw-input').value =
`Mario
ore 19:30
via Roma 10
2 margherita bufala
1 diavola grande
1 capricciosa integrale
`;
  },

  // ---------- SMART PARSER ----------
  process() {
    const raw = document.getElementById('raw-input').value;
    const normalized = this.normalize(raw);

    const o = {
      customer: "Cliente",
      time: "ASAP",
      address: "",
      items: [],
      total: 0,
      mode: "RITIRO",
      raw: raw
    };

    const lines = raw.split('\n')
      .map(l => this.safeText(l))
      .filter(l => l.length > 0);

    // 1) prima pass: time + address/mode
    for(const line of lines) {
      const t = this.parseTimeFromLine(line);
      if(t) o.time = t;

      const ln = this.normalize(line);
      if(this.isDeliveryLine(ln)) {
        o.address = line;
        o.mode = "CONSEGNA";
      }
    }

    // 2) cliente (euristica): prima riga che non sembra item, n√© time, n√© indirizzo
    for(const line of lines) {
      const ln = this.normalize(line);
      if(this.parseTimeFromLine(ln)) continue;
      if(this.isDeliveryLine(ln)) continue;
      if(this.parseQtyAndText(ln)) continue;
      // se √® una riga "nome" corta, la prendo
      if(ln.length <= 30) { o.customer = line; break; }
    }

    // 3) items: righe con quantit√†
    for(const line of lines) {
      const ln = this.normalize(line);
      const qt = this.parseQtyAndText(ln);
      if(!qt) continue;

      const { qty, text } = qt;
      const pizzaKey = this.detectFromText(text, 'pizzas') || 'margherita';
      const basePrice = Number(this.config.pizzas[pizzaKey] ?? this.config.pizzas['margherita'] ?? 0);
      const variationKey = this.detectFromText(text, 'variations') || 'normale';
      const extraKey = this.detectFromText(text, 'extras') || 'nessuno';

      // nome base in UI: da chiave config
      const baseName = String(pizzaKey).toUpperCase();

      const note = this.detectNote(text);

      o.items.push({
        qty,
        baseName,
        price: basePrice,
        impasto: variationKey,
        extra: extraKey,
        note
      });
    }

    // se non ho items ma ho testo, prova fallback: riga singola "margherita" senza quantit√† => qty 1
    if(o.items.length === 0 && normalized.length > 0) {
      const pizzaKey = this.detectFromText(normalized, 'pizzas');
      if(pizzaKey) {
        o.items.push({
          qty: 1,
          baseName: String(pizzaKey).toUpperCase(),
          price: Number(this.config.pizzas[pizzaKey] ?? 0),
          impasto: this.detectFromText(normalized, 'variations') || 'normale',
          extra: this.detectFromText(normalized, 'extras') || 'nessuno',
          note: this.detectNote(normalized)
        });
      }
    }

    this.order = o;
    this.render();
  },

  // ---------- TICKET RENDER ----------
  render() {
    if(!this.order) return;
    const o = this.order;

    const sums = this.computeOrder(o);
    this.order.total = sums.total;

    let h = `*** COMANDA PIZZERIA ***\n`;
    h += `--------------------------------\n`;
    h += `ORA: ${o.time} | ${o.mode}\n`;
    h += `CLI: ${this.safeText(o.customer).toUpperCase()}\n`;
    if(o.address) h += `IND: ${this.safeText(o.address).toUpperCase()}\n`;
    h += `--------------------------------\n`;

    o.items.forEach(it => {
      const calc = this.computeLine(it);
      h += `${it.qty}x ${this.safeText(it.baseName)}\n`;
      if(it.impasto && it.impasto !== "normale") h += `   [IMP: ${String(it.impasto).toUpperCase()}]\n`;
      if(it.extra && it.extra !== "nessuno") h += `   [EXT: ${String(it.extra).toUpperCase()}]\n`;
      if(it.note) h += `   (${this.safeText(it.note)})\n`;
      h += `               EUR ${this.money(calc.total)}\n`;
    });

    h += `--------------------------------\n`;
    if(o.mode === "CONSEGNA") {
      h += `CONSEGNA:          EUR ${this.money(sums.fee)}\n`;
    }
    h += `TOTALE:            EUR ${this.money(sums.total)}\n`;
    h += `--------------------------------\n\n\n\n`;

    document.getElementById('output').textContent = h;
    this.updatePills();
  },

  // ---------- COPY ----------
  async copyTicket() {
    const text = document.getElementById('output').textContent || '';
    try {
      await navigator.clipboard.writeText(text);
      alert("Comanda copiata!");
    } catch {
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      alert("Comanda copiata!");
    }
  },

  // ---------- EDITOR ----------
  openEditor() {
    if(!this.order) return alert("Analizza prima un ordine!");
    const o = this.order;
    document.getElementById('edt-customer').value = o.customer;
    document.getElementById('edt-time').value = o.time;
    document.getElementById('edt-address').value = o.address;

    document.getElementById('edt-detected').textContent = `${o.mode} @ ${o.time}`;
    document.getElementById('edt-fee').textContent = this.moneyIt(o.mode === "CONSEGNA" ? this.config.deliveryFee : 0);

    this.renderEditorItems();
    document.getElementById('modal-editor').classList.add('open');
  },

  renderEditorItems() {
    const container = document.getElementById('edt-items-list');
    container.innerHTML = "";

    this.order.items.forEach((it, idx) => {
      const row = document.createElement('div');
      row.className = "order-row";

      row.innerHTML = `
        <div class="row-main">
          <div>
            <label>Qt√†</label>
            <input type="number" min="1" value="${this.escHtml(it.qty)}" data-k="qty">
          </div>
          <div>
            <label>Pizza Base</label>
            <select data-k="baseName">
              ${Object.keys(this.config.pizzas).map(p => {
                const up = p.toUpperCase();
                const sel = (it.baseName === up) ? 'selected' : '';
                return `<option value="${this.escHtml(up)}" ${sel}>${this.escHtml(up)}</option>`;
              }).join('')}
            </select>
          </div>
          <div>
            <label>Prezzo Base</label>
            <input type="number" step="0.5" value="${this.escHtml(it.price)}" data-k="price" readonly>
          </div>
          <button class="btn btn-danger" style="margin-top:15px; border-radius:6px;" data-act="remove">X</button>
        </div>

        <div class="row-options">
          <div>
            <label>Impasto / Formato</label>
            <select data-k="impasto">
              ${Object.keys(this.config.variations).map(v => {
                const sel = (it.impasto === v) ? 'selected' : '';
                return `<option value="${this.escHtml(v)}" ${sel}>${this.escHtml(v.toUpperCase())} (+‚Ç¨${this.money(this.config.variations[v])})</option>`;
              }).join('')}
            </select>
          </div>

          <div>
            <label>Aggiunta Extra</label>
            <select data-k="extra">
              ${Object.keys(this.config.extras).map(e => {
                const sel = (it.extra === e) ? 'selected' : '';
                return `<option value="${this.escHtml(e)}" ${sel}>${this.escHtml(e.toUpperCase())} (+‚Ç¨${this.money(this.config.extras[e])})</option>`;
              }).join('')}
            </select>
          </div>

          <div>
            <label>Note</label>
            <input type="text" placeholder="es: met√† crudo" value="${this.escHtml(it.note)}" data-k="note">
          </div>
        </div>
      `;

      // bindings
      row.querySelector('[data-k="qty"]').addEventListener('input', (e) => {
        const v = parseInt(e.target.value, 10);
        this.order.items[idx].qty = Number.isFinite(v) && v > 0 ? v : 1;
        this.updateEditorTotal();
      });

      row.querySelector('[data-k="baseName"]').addEventListener('change', (e) => {
        const baseName = e.target.value;
        const key = this.normalize(baseName); // torna su chiave pizzas
        const foundKey = Object.keys(this.config.pizzas).find(k => this.normalize(k) === key) || key;
        this.order.items[idx].baseName = baseName;
        this.order.items[idx].price = Number(this.config.pizzas[foundKey] ?? this.order.items[idx].price ?? 0);
        // aggiorna campo prezzo visualizzato
        row.querySelector('[data-k="price"]').value = this.order.items[idx].price;
        this.updateEditorTotal();
      });

      row.querySelector('[data-k="impasto"]').addEventListener('change', (e) => {
        this.order.items[idx].impasto = e.target.value;
        this.updateEditorTotal();
      });

      row.querySelector('[data-k="extra"]').addEventListener('change', (e) => {
        this.order.items[idx].extra = e.target.value;
        this.updateEditorTotal();
      });

      row.querySelector('[data-k="note"]').addEventListener('input', (e) => {
        this.order.items[idx].note = e.target.value;
      });

      row.querySelector('[data-act="remove"]').addEventListener('click', () => {
        this.removeOrderItem(idx);
      });

      container.appendChild(row);
    });

    this.updateEditorTotal();
  },

  addOrderItem() {
    if(!this.order) return;
    this.order.items.push({ qty: 1, baseName: "MARGHERITA", price: Number(this.config.pizzas["margherita"] ?? 0), impasto: "normale", extra: "nessuno", note: "" });
    this.renderEditorItems();
  },

  removeOrderItem(idx) {
    if(!this.order) return;
    this.order.items.splice(idx, 1);
    this.renderEditorItems();
  },

  updateEditorTotal() {
    if(!this.order) return;
    const sums = this.computeOrder(this.order);
    document.getElementById('edt-total').textContent = this.moneyIt(sums.total);
    document.getElementById('edt-fee').textContent = this.moneyIt(this.order.mode === "CONSEGNA" ? sums.fee : 0);
  },

  saveOrderEdits() {
    if(!this.order) return;
    this.order.customer = document.getElementById('edt-customer').value;
    this.order.time = document.getElementById('edt-time').value;
    this.order.address = document.getElementById('edt-address').value;

    // aggiorna mode in base a indirizzo
    const addrNorm = this.normalize(this.order.address);
    this.order.mode = (addrNorm && this.isDeliveryLine(addrNorm)) ? "CONSEGNA" : "RITIRO";

    this.pushHistory(this.order);
    this.closeModals();
    this.render();
  },

  // chiudi cliccando sul backdrop
  backdropClose(e) {
    if(e.target.classList.contains('modal')) this.closeModals();
  },

  // ---------- SETTINGS ----------
  openSettings() {
    const list = (obj, mountId, keyName) => {
      const mount = document.getElementById(mountId);
      mount.innerHTML = "";

      Object.entries(obj).forEach(([k,v]) => {
        const row = document.createElement('div');
        row.style.display = "flex";
        row.style.gap = "5px";
        row.style.marginBottom = "5px";

        row.innerHTML = `
          <input type="text" value="${this.escHtml(k)}" readonly style="flex:1">
          <input type="number" step="0.5" value="${this.escHtml(v)}" style="width:80px">
          <button class="btn btn-danger" style="padding:0 8px">X</button>
        `;

        const valInput = row.querySelector('input[type="number"]');
        valInput.addEventListener('change', () => {
          const n = parseFloat(valInput.value);
          this.config[keyName][k] = Number.isFinite(n) ? n : 0;
        });

        row.querySelector('button').addEventListener('click', () => {
          delete this.config[keyName][k];
          this.openSettings();
        });

        mount.appendChild(row);
      });
    };

    list(this.config.pizzas, 'cfg-pizzas', 'pizzas');
    list(this.config.variations, 'cfg-variations', 'variations');
    list(this.config.extras, 'cfg-extras', 'extras');

    document.getElementById('cfg-delivery-fee').value = Number(this.config.deliveryFee ?? 0);
    document.getElementById('cfg-fee-pill').textContent = this.moneyIt(this.config.deliveryFee ?? 0);

    document.getElementById('modal-settings').classList.add('open');
  },

  addCatalogItem(type) {
    const n = prompt("Nome:");
    if(!n) return;
    const key = this.normalize(n);
    if(!key) return;
    if(!this.config[type]) this.config[type] = {};
    if(this.config[type][key] != null) return alert("Esiste gi√†!");

    this.config[type][key] = 0;
    this.openSettings();
  },

  saveSettings() {
    const fee = parseFloat(document.getElementById('cfg-delivery-fee').value);
    this.config.deliveryFee = Number.isFinite(fee) ? fee : 0;

    localStorage.setItem('commander_v12_cfg', JSON.stringify(this.config));
    this.closeModals();

    // ricalcolo se c'√® un ordine aperto
    if(this.order) this.render();
  },

  resetConfig() {
    if(!confirm("Ripristinare la configurazione di default?")) return;
    this.config = this.defaultConfig();
    localStorage.setItem('commander_v12_cfg', JSON.stringify(this.config));
    this.openSettings();
    if(this.order) this.render();
  },

  // ---------- HISTORY ----------
  pushHistory(order) {
    try {
      const snap = JSON.parse(JSON.stringify(order));
      snap._savedAt = new Date().toISOString();
      this.config.history = Array.isArray(this.config.history) ? this.config.history : [];
      this.config.history.unshift(snap);
      // limite storico
      this.config.history = this.config.history.slice(0, 200);
      localStorage.setItem('commander_v12_cfg', JSON.stringify(this.config));
    } catch { /* no-op */ }
  },

  exportHistory() {
    const hist = Array.isArray(this.config.history) ? this.config.history : [];
    const blob = new Blob([JSON.stringify(hist, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `commander_v12_history_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  },

  // ---------- NIGHT CLOSURE ----------
  nightClosure() {
    if(!confirm("Eseguire chiusura e reset?")) return;

    // salva in storico se presente
    if(this.order) this.pushHistory(this.order);

    this.order = null;
    document.getElementById('raw-input').value = "";
    document.getElementById('output').textContent = "Pronto...";
    this.updatePills();
    alert("Giornata chiusa con successo!");
  },

  closeModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('open'));
  }
};

App.init();
</script>
</body>
</html>
