<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>OLIMPO GEST ‚ö° V10</title>
  <style>
    :root {
      --bg: #05070a; --surface: #0f172a; --surface-alt: #1e293b;
      --accent: #0ea5e9; --accent-hover: #0284c7;
      --text: #f8fafc; --text-dim: #94a3b8;
      --success: #22c55e; --danger: #ef4444; --warning: #f59e0b;
      --border: rgba(255,255,255,0.1); --radius: 16px;
    }
    * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 50px; }
    .app { max-width: 1300px; margin: 0 auto; padding: 1rem; display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    @media (min-width: 1024px) { .app { grid-template-columns: 1fr 1.2fr; } }

    header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 1.2rem; background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; height: fit-content; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .card-h { padding: 1rem 1.5rem; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-weight: 800; display: flex; justify-content: space-between; align-items: center; }
    .card-b { padding: 1.5rem; }

    textarea { width: 100%; min-height: 220px; background: #000; color: #10b981; border: 1px solid var(--border); border-radius: 12px; padding: 1rem; font-family: 'Consolas', monospace; font-size: 14px; outline: none; resize: vertical; }
    
    .btn { padding: 0.8rem 1.2rem; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
    .btn-main { background: var(--accent); color: white; }
    .btn-wa { background: #25D366; color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-sec { background: var(--surface-alt); color: var(--text); border: 1px solid var(--border); }
    .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }

    .output-box { background: #000; border-radius: 12px; padding: 1.5rem; font-family: 'Courier New', Courier, monospace; color: #fff; line-height: 1.4; border: 1px solid var(--border); white-space: pre-wrap; min-height: 400px; }
    
    .tab-group { display: flex; gap: 4px; background: #000; padding: 4px; border-radius: 10px; }
    .tab-btn { padding: 6px 15px; border: none; background: transparent; color: var(--text-dim); border-radius: 7px; cursor: pointer; font-weight: 600; font-size: 12px; }
    .tab-btn.active { background: var(--surface-alt); color: var(--accent); }

    /* Modal Styles */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); display: none; z-index: 1000; padding: 1rem; overflow-y: auto; }
    .modal.open { display: flex; justify-content: center; }
    .modal-sheet { background: var(--surface); width: 100%; max-width: 700px; height: fit-content; margin: 2rem 0; border-radius: 20px; border: 1px solid var(--border); padding: 2rem; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 1rem; }
    input, select { width: 100%; background: #000; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 10px; font-size: 14px; }
    
    .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border); }
    .cat-item input { width: 80px; text-align: right; margin-left: 10px; }

    @media print { .no-print { display: none !important; } .output-box { border: none; color: #000; background: #fff; } body { background: #fff; } }
  </style>
</head>
<body>

<div class="app">
  <header class="no-print">
    <div>
      <div style="font-weight: 900; font-size: 1.5rem; letter-spacing: -1px; color: var(--accent);">OLIMPO GEST <span style="font-weight: 300; color: #fff;">V10</span></div>
      <div id="clock" style="font-size: 12px; color: var(--text-dim);">Caricamento...</div>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="btn btn-danger" onclick="App.nightClosure()">üåô CHIUSURA SERALE</button>
      <button class="btn btn-sec" onclick="App.openSettings()">‚öôÔ∏è IMPOSTAZIONI</button>
    </div>
  </header>

  <div class="card no-print">
    <div class="card-h">üì• INPUT ORDINE</div>
    <div class="card-b">
      <textarea id="raw-input" placeholder="Incolla l'ordine qui..."></textarea>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1rem;">
        <button class="btn btn-main" onclick="App.process()">‚ö° ELABORA</button>
        <button class="btn btn-sec" onclick="App.openEditor()">‚úèÔ∏è MODIFICA</button>
      </div>

      <div id="actions-bar" style="display: none; margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">
        <button class="btn btn-wa" style="width: 100%; margin-bottom: 10px;" onclick="App.sendWhatsApp()">üí¨ INVIA CONFERMA WHATSAPP</button>
        <div style="display: flex; justify-content: space-between; padding: 1rem; background: rgba(34, 197, 94, 0.1); border-radius: 12px;">
          <span style="font-weight: 800;">TOTALE ORDINE:</span>
          <span id="grand-total" style="color: var(--success); font-weight: 900; font-size: 1.2rem;">‚Ç¨ 0.00</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-h no-print">
      <div class="tab-group">
        <button class="tab-btn active" id="tab-kitchen" onclick="App.setTab('kitchen')">CUCINA</button>
        <button class="tab-btn" id="tab-receipt" onclick="App.setTab('receipt')">RICEVUTA</button>
      </div>
      <button class="btn btn-sec" style="padding: 5px 12px;" onclick="window.print()">üñ®Ô∏è STAMPA</button>
    </div>
    <div class="card-b">
      <div id="output" class="output-box">In attesa di ordini...</div>
    </div>
  </div>
</div>

<div id="modal-settings" class="modal no-print">
  <div class="modal-sheet">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
      <h2 style="margin:0;">‚öôÔ∏è Gestione Catalogo</h2>
      <button class="btn btn-sec" onclick="App.closeModals()">Chiudi</button>
    </div>
    
    <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
      <h3>üçï Prezzi Pizze</h3>
      <div id="cat-pizzas"></div>
      
      <h3>üß™ Impasti & Formati</h3>
      <div id="cat-variations"></div>

      <h3>‚ûï Extra & Supplementi</h3>
      <div id="cat-extras"></div>
      
      <div class="grid-2" style="margin-top:20px;">
        <div><label>Costo Consegna (‚Ç¨)</label><input type="number" id="cfg-delivery" step="0.5"></div>
        <div><label>Nome Pizzeria</label><input type="text" id="cfg-name"></div>
      </div>
    </div>
    
    <button class="btn btn-main" style="width:100%; margin-top:2rem;" onclick="App.saveSettings()">üíæ SALVA IMPOSTAZIONI</button>
  </div>
</div>

<div id="modal-editor" class="modal no-print">
  <div class="modal-sheet">
    <h2 style="margin-bottom:1.5rem;">‚úèÔ∏è Rifinitura Ordine</h2>
    <div class="grid-2">
      <div><label>Cliente</label><input type="text" id="edt-customer"></div>
      <div><label>Orario</label><input type="text" id="edt-time"></div>
    </div>
    <div class="grid-2">
      <div><label>Indirizzo</label><input type="text" id="edt-address"></div>
      <div><label>Telefono</label><input type="text" id="edt-phone"></div>
    </div>
    <div id="edt-items" style="margin: 1.5rem 0; border-top: 1px solid var(--border); padding-top: 1rem;"></div>
    <button class="btn btn-main" style="width:100%;" onclick="App.saveOrderEdits()">üöÄ AGGIORNA ORDINE</button>
  </div>
</div>

<script>
const App = {
  // --- CONFIGURAZIONE INIZIALE ---
  config: {
    name: "La Tua Pizzeria",
    deliveryFee: 2.0,
    pizzas: { "margherita": 6.5, "capricciosa": 9.0, "diavola": 8.0, "salame piccante": 8.0, "salsiccia porcini e grana": 10.5, "profumo di langa": 11.0, "quella della suocera": 10.0 },
    variations: { "integrale": 1.5, "verace": 2.0, "senza glutine": 3.0, "mezzo metro": 15.0, "grande": 2.5, "schiacciata": 1.0 },
    extras: { "speck": 1.5, "brie": 1.5, "porcini": 2.0, "panna": 1.0, "gorgonzola": 1.5, "crudo di parma": 2.5, "cipolle": 0.5, "verdure grigliate": 2.0 }
  },
  
  state: { order: null, tab: 'kitchen' },

  init() {
    // Carica impostazioni salvate
    const saved = localStorage.getItem('olimpo_config');
    if (saved) this.config = JSON.parse(saved);
    
    setInterval(() => {
      document.getElementById('clock').textContent = new Date().toLocaleString('it-IT', { weekday: 'long', hour: '2-digit', minute: '2-digit' });
    }, 1000);
  },

  // --- LOGICA PARSER ---
  process() {
    const raw = document.getElementById('raw-input').value;
    if (!raw.trim()) return;

    let order = {
      customer: "Cliente", phone: "", address: "", time: "Subito", items: [], mode: "RITIRO", total: 0
    };

    const lines = raw.split('\n');
    lines.forEach(line => {
      const l = line.toLowerCase();
      
      // Estrazione Dati Cliente
      if (l.match(/(\d{2}[:.]\d{2})/)) order.time = l.match(/(\d{2}[:.]\d{2})/)[0];
      if (l.includes("via") || l.includes("consegna")) { order.address = line.trim(); order.mode = "CONSEGNA"; }
      if (l.match(/\b\d{9,10}\b/)) order.phone = l.match(/\b\d{9,10}\b/)[0];
      if (l.includes("nome:") || l.includes("stabile") || l.includes("tura") || l.includes("erjon")) order.customer = line.split(':').pop().trim();

      // Estrazione Pizze
      let qtyMatch = line.match(/^(\d+)/);
      if (qtyMatch) {
        let qty = parseInt(qtyMatch[1]);
        let text = l.replace(/^\d+/, "").trim();
        
        let foundGusti = [];
        for (let p in this.config.pizzas) { if (text.includes(p)) foundGusti.push(p); }
        
        if (foundGusti.length > 0) {
          let base = foundGusti.reduce((a, b) => a + this.config.pizzas[b], 0) / foundGusti.length;
          
          // Aggiunte Prezzi
          for(let v in this.config.variations) { if(text.includes(v)) base += this.config.variations[v]; }
          for(let e in this.config.extras) { if(text.includes(e)) base += this.config.extras[e]; }

          order.items.push({ qty, name: text.toUpperCase(), price: base });
        }
      }
    });

    order.total = order.items.reduce((a, b) => a + (b.price * b.qty), 0);
    if (order.mode === "CONSEGNA") order.total += this.config.deliveryFee;

    this.state.order = order;
    document.getElementById('actions-bar').style.display = 'block';
    this.render();
  },

  render() {
    if (!this.state.order) return;
    const o = this.state.order;
    const box = document.getElementById('output');
    document.getElementById('grand-total').textContent = `‚Ç¨ ${o.total.toFixed(2)}`;
    
    let h = "";
    if (this.state.tab === 'kitchen') {
      h += `üî• ${this.config.name.toUpperCase()} üî•\n`;
      h += `--------------------------------\n`;
      h += `ORA: ${o.time} | ${o.mode}\n`;
      h += `CLIENTE: ${o.customer}\n`;
      if(o.address) h += `VIA: ${o.address}\n`;
      h += `--------------------------------\n`;
      o.items.forEach(it => { h += `${it.qty}x ${it.name}\n`; });
    } else {
      h += `üßæ RICEVUTA CLIENTE üßæ\n`;
      h += `--------------------------------\n`;
      o.items.forEach(it => {
        h += `${it.qty} x ${it.name}\n`;
        h += `   ‚Ç¨ ${it.price.toFixed(2)} cad. -> ‚Ç¨ ${(it.price * it.qty).toFixed(2)}\n`;
      });
      if(o.mode === "CONSEGNA") h += `Consegna: ‚Ç¨ ${this.config.deliveryFee.toFixed(2)}\n`;
      h += `--------------------------------\n`;
      h += `TOTALE: ‚Ç¨ ${o.total.toFixed(2)}\n`;
      h += `--------------------------------\n`;
      h += `Grazie e buon appetito!`;
    }
    box.textContent = h;
  },

  setTab(tab) {
    this.state.tab = tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    this.render();
  },

  // --- WHATSAPP BRIDGE ---
  sendWhatsApp() {
    const o = this.state.order;
    if (!o || !o.phone) return alert("Manca il numero di telefono!");
    
    let msg = `*${this.config.name}* üçï\n\nCiao ${o.customer}, ordine confermato!\n`;
    o.items.forEach(it => { msg += `- ${it.qty}x ${it.name}\n`; });
    msg += `\n‚è∞ *Orario:* ${o.time}\nüí∞ *Totale:* ‚Ç¨ ${o.total.toFixed(2)}\nüìç *Destinazione:* ${o.address || 'Ritiro in sede'}\n\nA tra poco!`;
    
    const url = `https://wa.me/39${o.phone}?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
  },

  // --- GESTIONE IMPOSTAZIONI ---
  openSettings() {
    const renderList = (obj, targetId) => {
      let html = "";
      for (let key in obj) {
        html += `<div class="cat-item"><span>${key}</span> <input type="number" step="0.5" data-key="${key}" value="${obj[key]}"></div>`;
      }
      document.getElementById(targetId).innerHTML = html;
    };

    renderList(this.config.pizzas, 'cat-pizzas');
    renderList(this.config.variations, 'cat-variations');
    renderList(this.config.extras, 'cat-extras');
    document.getElementById('cfg-delivery').value = this.config.deliveryFee;
    document.getElementById('cfg-name').value = this.config.name;
    document.getElementById('modal-settings').classList.add('open');
  },

  saveSettings() {
    const updateObj = (targetId, originalObj) => {
      document.querySelectorAll(`#${targetId} input`).forEach(input => {
        originalObj[input.dataset.key] = parseFloat(input.value);
      });
    };

    updateObj('cat-pizzas', this.config.pizzas);
    updateObj('cat-variations', this.config.variations);
    updateObj('cat-extras', this.config.extras);
    this.config.deliveryFee = parseFloat(document.getElementById('cfg-delivery').value);
    this.config.name = document.getElementById('cfg-name').value;

    localStorage.setItem('olimpo_config', JSON.stringify(this.config));
    alert("Impostazioni salvate con successo!");
    this.closeModals();
  },

  // --- CHIUSURA SERALE ---
  nightClosure() {
    if (confirm("Vuoi eseguire la chiusura serale? Tutti i dati degli ordini attuali verranno cancellati.")) {
      this.state.order = null;
      document.getElementById('raw-input').value = "";
      document.getElementById('output').textContent = "In attesa di ordini...";
      document.getElementById('actions-bar').style.display = 'none';
      // Manteniamo le impostazioni del catalogo ma puliamo lo stato
      alert("Chiusura completata. Buona serata!");
    }
  },

  // --- EDITOR ORDINE ---
  openEditor() {
    if (!this.state.order) return;
    const o = this.state.order;
    document.getElementById('edt-customer').value = o.customer;
    document.getElementById('edt-time').value = o.time;
    document.getElementById('edt-address').value = o.address;
    document.getElementById('edt-phone').value = o.phone;
    
    document.getElementById('edt-items').innerHTML = o.items.map((it, idx) => `
      <div style="display:flex; gap:10px; margin-bottom:5px;">
        <input type="number" style="width:60px" id="qty-${idx}" value="${it.qty}">
        <input type="text" id="name-${idx}" value="${it.name}">
      </div>
    `).join('');
    
    document.getElementById('modal-editor').classList.add('open');
  },

  saveOrderEdits() {
    const o = this.state.order;
    o.customer = document.getElementById('edt-customer').value;
    o.time = document.getElementById('edt-time').value;
    o.address = document.getElementById('edt-address').value;
    o.phone = document.getElementById('edt-phone').value;
    
    o.items.forEach((it, idx) => {
      it.qty = parseInt(document.getElementById(`qty-${idx}`).value);
      it.name = document.getElementById(`name-${idx}`).value.toUpperCase();
    });

    o.total = o.items.reduce((a, b) => a + (b.price * b.qty), 0) + (o.mode === "CONSEGNA" ? this.config.deliveryFee : 0);
    this.closeModals();
    this.render();
  },

  closeModals() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('open'));
  }
};

App.init();
</script>
</body>
</html>
