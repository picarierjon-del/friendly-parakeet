<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>WA Order Pro V9 ‚Äî Professional Full</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #030712;
      --card: rgba(17, 24, 39, 0.85);
      --card-border: rgba(255, 255, 255, 0.08);
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.35);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --radius-lg: 18px;
      --radius-md: 12px;
      --font-sans: 'Inter', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg);
      background-image: radial-gradient(circle at top right, #1e1b4b, transparent),
                        radial-gradient(circle at bottom left, #0f172a, transparent);
      background-attachment: fixed;
      color: var(--text-main);
      line-height: 1.5;
    }

    .app-container { max-width: 1100px; margin: 0 auto; padding: 10px 15px 120px; }

    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 0; position: sticky; top: 0; z-index: 100;
      background: rgba(3,7,18,0.7); backdrop-filter: blur(12px);
    }

    .brand h1 {
      font-size: 1.3rem; font-weight: 800; margin: 0;
      background: linear-gradient(to right, #fff, var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 900px) { .dashboard-grid { grid-template-columns: 1.1fr 0.9fr; } }

    .glass-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      overflow: hidden;
    }
    .card-header {
      padding: 12px 20px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--card-border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .card-content { padding: 15px; }

    textarea {
      width: 100%; min-height: 250px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-md);
      color: var(--text-main);
      padding: 15px; font-family: var(--font-sans);
      font-size: 0.95rem; resize: vertical; transition: 0.2s;
    }
    textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

    .output-area {
      font-family: var(--font-mono); font-size: 0.85rem; line-height: 1.4;
      background: #000; padding: 15px; border-radius: var(--radius-md);
      min-height: 350px; white-space: pre-wrap; color: #adbac7;
      border: 1px solid var(--card-border);
    }

    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
    .btn {
      padding: 10px 16px; border-radius: var(--radius-md); font-weight: 600;
      font-size: 0.85rem; cursor: pointer; transition: 0.2s;
      border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-whatsapp { background: #25d366; color: white; }
    .btn-outline { background: transparent; border-color: var(--card-border); color: var(--text-main); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--error); border-color: rgba(239, 68, 68, 0.2); }

    .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 20px; font-weight: 700; }
    .badge-auto { background: rgba(59, 130, 246, 0.2); color: var(--accent); }

    .stats-bar {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 1100px;
      background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(15px);
      border: 1px solid var(--card-border); padding: 12px 25px;
      border-radius: 50px; display: flex; justify-content: space-between; align-items: center;
      z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }

    /* Modals */
    .sheet-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.75);
      display: none; z-index: 300; align-items: flex-end; justify-content: center;
    }
    .sheet-backdrop.open { display: flex; }
    .sheet {
      width: 100%; max-width: 800px; background: #111827;
      border-radius: 20px 20px 0 0; max-height: 85vh; overflow-y: auto;
      animation: slideUp 0.3s cubic-bezier(0, 0, 0.2, 1);
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .item-edit {
      border: 1px solid var(--card-border); padding: 12px;
      border-radius: 12px; background: rgba(255,255,255,0.02);
      margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
    }
    .item-edit.warning { border-left: 4px solid var(--warning); background: rgba(245, 158, 11, 0.05); }

    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      padding: 10px 20px; border-radius: 50px; color: white;
      font-weight: 600; opacity: 0; transition: 0.3s; z-index: 1000; pointer-events: none;
    }
    #toast.show { opacity: 1; top: 40px; }

    .tabs-nav { display: flex; gap: 4px; background: #000; padding: 4px; border-radius: 10px; }
    .tab-btn {
      background: transparent; border: none; color: var(--text-muted);
      padding: 6px 14px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-radius: 7px;
    }
    .tab-btn.active { background: var(--accent); color: white; }

    @media print {
        .btn-group, header, .stats-bar, .tabs-nav, .badge { display: none !important; }
        .dashboard-grid { display: block; }
        .glass-card { border: none; box-shadow: none; background: white; }
        .output-area { border: none; color: black; background: white; font-size: 10pt; }
    }
  </style>
</head>
<body>

  <div id="toast"></div>

  <div class="app-container">
    <header>
      <div class="brand">
        <h1>WA Order Pro <span style="font-size: 0.8rem; opacity: 0.5;">V9 Full</span></h1>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="btnConfirm" class="btn btn-outline">‚úÖ Revisione</button>
        <button id="btnWA" class="btn btn-whatsapp">üì≤ WhatsApp</button>
      </div>
    </header>

    <div class="dashboard-grid">
      <section class="glass-card">
        <div class="card-header">
          <span class="badge badge-auto">Chat WhatsApp</span>
          <span id="statusIndicator" style="font-size: 0.7rem; opacity: 0.7;">Pronto</span>
        </div>
        <div class="card-content">
          <textarea id="mainInput" placeholder="Incolla qui la conversazione... Es:
2 margherita
1 diavola senza olive
alle 20:30
Nome: Marco"></textarea>
          <div class="btn-group">
            <button id="btnAnalyze" class="btn btn-primary">üß† Analizza</button>
            <button id="btnGen" class="btn btn-primary">‚ú® Genera Comanda</button>
            <button id="btnCopy" class="btn btn-outline">üìã Copia</button>
            <button id="btnPrint" class="btn btn-outline">üñ®Ô∏è Stampa</button>
            <button id="btnClear" class="btn btn-danger">üóëÔ∏è Clear</button>
          </div>
        </div>
      </section>

      <section class="glass-card">
        <div class="card-header">
          <div class="tabs-nav">
            <button class="tab-btn active" data-view="kitchen">CUCINA</button>
            <button class="tab-btn" data-view="receipt">RICEVUTA</button>
          </div>
          <span id="timeBadge" style="font-weight: 800; color: var(--warning); font-size: 0.8rem;">--:--</span>
        </div>
        <div class="card-content">
          <div id="outputContainer" class="output-area">In attesa di dati...</div>
        </div>
      </section>
    </div>
  </div>

  <div class="stats-bar">
    <div>
      <div style="font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase;">Totale Pizze</div>
      <div id="countPizze" style="font-weight: 800; color: var(--accent); font-size: 1.2rem;">0</div>
    </div>
    <div style="text-align: right;">
      <div style="font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase;">Totale Conto</div>
      <div id="totalValue" style="font-weight: 800; color: var(--success); font-size: 1.2rem;">‚Ç¨ 0.00</div>
    </div>
  </div>

  <div id="confirmBackdrop" class="sheet-backdrop">
    <div class="sheet">
      <div style="padding: 20px; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between; align-items: center;">
        <strong style="font-size: 1.1rem;">Revisione Ordine</strong>
        <button id="closeConfirm" style="background:none; border:none; color:white; font-size: 1.5rem; cursor:pointer;">‚úï</button>
      </div>
      <div style="padding: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size: 0.7rem; color: var(--text-muted);">Nome</label>
                <input id="fName" style="padding:10px; background:#000; border:1px solid #333; color:white; border-radius:8px;">
            </div>
            <div style="display:flex; flex-direction:column; gap:4px;">
                <label style="font-size: 0.7rem; color: var(--text-muted);">Orario</label>
                <input id="fTime" style="padding:10px; background:#000; border:1px solid #333; color:white; border-radius:8px;">
            </div>
            <div style="display:flex; flex-direction:column; gap:4px; grid-column: span 2;">
                <label style="font-size: 0.7rem; color: var(--text-muted);">Indirizzo / Note</label>
                <input id="fAddress" style="padding:10px; background:#000; border:1px solid #333; color:white; border-radius:8px;">
            </div>
        </div>
        
        <div id="itemsEditor" style="margin-bottom: 20px;"></div>
        
        <button id="btnApplyConfirm" class="btn btn-primary" style="width:100%; justify-content:center; padding: 14px;">‚úÖ Conferma Modifiche</button>
      </div>
    </div>
  </div>

<script>
/* ===================== CONFIGURAZIONE & CATALOGO ===================== */
const CATALOG = {
    pizzas: {
        "margherita": 6.50,
        "diavola": 8.00,
        "capricciosa": 9.00,
        "bufala": 8.50,
        "marinara": 5.00,
        "quattro formaggi": 8.50,
        "ortolana": 8.00,
        "salamino": 7.50
    },
    currency: "‚Ç¨"
};

let DRAFT = { name: "", time: "", address: "", items: [], mode: "RITIRO" };
let ACTIVE_VIEW = "kitchen";

/* ===================== UTILS ===================== */
function showToast(msg, color = "var(--accent)") {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.background = color;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

function money(n) { return n.toFixed(2) + CATALOG.currency; }

/* ===================== PARSER CORE ===================== */
function parseWhatsApp(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const result = { name: "", time: "", address: "", items: [] };

    lines.forEach(line => {
        const lowerLine = line.toLowerCase();

        // 1. Estrazione Orario (HH:MM o HH.MM)
        const timeMatch = line.match(/(\d{1,2}[:.]\d{2})/);
        if (timeMatch && !result.time) result.time = timeMatch[1].replace('.', ':');

        // 2. Estrazione Nome (Nome: Marco o sono Marco)
        if (lowerLine.includes("nome:") || lowerLine.startsWith("sono ")) {
            result.name = line.replace(/nome:|sono /i, "").trim();
        }

        // 3. Estrazione Articoli (es: 2 margherita)
        const itemMatch = line.match(/^(\d+)\s+(.+)/);
        if (itemMatch) {
            const qty = parseInt(itemMatch[1]);
            const itemName = itemMatch[2].toLowerCase().trim();
            const price = CATALOG.pizzas[itemName] || 0;
            result.items.push({ qty, name: itemName, price });
        }
    });

    return result;
}

/* ===================== LOGICA UI ===================== */
function performAnalysis() {
    const input = document.getElementById('mainInput').value;
    if (!input) return showToast("Incolla del testo!", "var(--error)");

    const parsed = parseWhatsApp(input);
    DRAFT = parsed;

    // Sincronizza UI
    document.getElementById('timeBadge').textContent = DRAFT.time || "--:--";
    updateStats();
    showToast("Analisi completata ‚ú®");
}

function updateStats() {
    const total = DRAFT.items.reduce((sum, it) => sum + (it.price * it.qty), 0);
    const count = DRAFT.items.reduce((sum, it) => sum + it.qty, 0);
    document.getElementById('totalValue').textContent = money(total);
    document.getElementById('countPizze').textContent = count;
}

function renderOutput() {
    const container = document.getElementById('outputContainer');
    if (DRAFT.items.length === 0) {
        container.textContent = "Nessun dato analizzato.";
        return;
    }

    let text = "";
    const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

    if (ACTIVE_VIEW === "kitchen") {
        text += `=== COMANDA CUCINA ===\n`;
        text += `ORA ORDINE: ${DRAFT.time || 'N/D'}\n`;
        text += `CLIENTE: ${DRAFT.name || 'N/D'}\n`;
        text += `----------------------\n`;
        DRAFT.items.forEach(it => {
            text += `${it.qty}x ${it.name.toUpperCase()}\n`;
        });
        text += `----------------------\n`;
        text += `Stampato alle: ${now}`;
    } else {
        text += `=== RICEVUTA CLIENTE ===\n`;
        text += `Cliente: ${DRAFT.name || 'N/D'}\n`;
        text += `Orario: ${DRAFT.time || 'N/D'}\n`;
        text += `----------------------\n`;
        let tot = 0;
        DRAFT.items.forEach(it => {
            const riga = it.price * it.qty;
            tot += riga;
            text += `${it.qty}x ${it.name} (${money(it.price)}) = ${money(riga)}\n`;
        });
        text += `----------------------\n`;
        text += `TOTALE: ${money(tot)}\n`;
        text += `Grazie e buon appetito!`;
    }
    container.textContent = text;
}

/* ===================== WHATSAPP & AZIONI ===================== */
function sendWhatsApp() {
    if (DRAFT.items.length === 0) return showToast("Analizza prima l'ordine", "var(--warning)");
    
    let msg = `*CONFERMA ORDINE üçï*\n\n`;
    msg += `üë§ *Nome:* ${DRAFT.name || 'N/D'}\n`;
    msg += `‚è∞ *Orario:* ${DRAFT.time || 'N/D'}\n\n`;
    
    let total = 0;
    DRAFT.items.forEach(it => {
        msg += `‚Ä¢ ${it.qty}x ${it.name} (${money(it.price)})\n`;
        total += it.price * it.qty;
    });
    
    msg += `\nüí∞ *Totale: ${money(total)}*`;
    
    const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(url, '_blank');
}

function renderEditor() {
    const area = document.getElementById('itemsEditor');
    document.getElementById('fName').value = DRAFT.name;
    document.getElementById('fTime').value = DRAFT.time;
    document.getElementById('fAddress').value = DRAFT.address;

    area.innerHTML = '';
    DRAFT.items.forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = `item-edit ${it.price === 0 ? 'warning' : ''}`;
        div.innerHTML = `
            <div>
                <strong>${it.qty}x</strong> ${it.name} 
                <span style="font-size:0.7rem; opacity:0.6; margin-left:10px;">${it.price > 0 ? money(it.price) : 'PREZZO MANCANTE'}</span>
            </div>
            <button onclick="removeItem(${idx})" style="background:none; border:none; color:var(--error); cursor:pointer; font-size:1.2rem;">üóëÔ∏è</button>
        `;
        area.appendChild(div);
    });
}

window.removeItem = function(idx) {
    DRAFT.items.splice(idx, 1);
    renderEditor();
    updateStats();
};

/* ===================== EVENT LISTENERS ===================== */
document.getElementById('btnAnalyze').onclick = performAnalysis;
document.getElementById('btnGen').onclick = renderOutput;
document.getElementById('btnWA').onclick = sendWhatsApp;

document.getElementById('btnConfirm').onclick = () => {
    document.getElementById('confirmBackdrop').classList.add('open');
    renderEditor();
};

document.getElementById('closeConfirm').onclick = () => {
    document.getElementById('confirmBackdrop').classList.remove('open');
};

document.getElementById('btnApplyConfirm').onclick = () => {
    DRAFT.name = document.getElementById('fName').value;
    DRAFT.time = document.getElementById('fTime').value;
    DRAFT.address = document.getElementById('fAddress').value;
    document.getElementById('timeBadge').textContent = DRAFT.time || "--:--";
    document.getElementById('confirmBackdrop').classList.remove('open');
    showToast("Dati aggiornati!");
    updateStats();
    renderOutput();
};

document.getElementById('btnCopy').onclick = async () => {
    const text = document.getElementById('outputContainer').textContent;
    await navigator.clipboard.writeText(text);
    showToast("Copiato negli appunti! üìã");
};

document.getElementById('btnPrint').onclick = () => window.print();

document.getElementById('btnClear').onclick = () => {
    document.getElementById('mainInput').value = '';
    DRAFT = { name: "", time: "", address: "", items: [] };
    document.getElementById('outputContainer').textContent = "In attesa di dati...";
    updateStats();
    showToast("Tabula rasa üßπ", "var(--error)");
};

document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelector('.tab-btn.active').classList.remove('active');
        btn.classList.add('active');
        ACTIVE_VIEW = btn.dataset.view;
        renderOutput();
    };
});
</script>
</body>
</html>
