<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>WA Order Pro V9 ‚Äî Professional Edition</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #030712;
      --card: rgba(17, 24, 39, 0.8);
      --card-border: rgba(255, 255, 255, 0.08);
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.35);
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --radius-lg: 18px;
      --radius-md: 12px;
      --font-sans: 'Inter', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, monospace;
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    body {
      margin: 0;
      font-family: var(--font-sans);
      background-color: var(--bg);
      background-image: radial-gradient(circle at top right, #1e1b4b, transparent),
                        radial-gradient(circle at bottom left, #0f172a, transparent);
      background-attachment: fixed;
      color: var(--text-main);
      line-height: 1.5;
    }

    .app-container { max-width: 1100px; margin: 0 auto; padding: 10px 15px 110px; }

    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 0; margin-bottom: 10px;
      position: sticky; top: 0; z-index: 100;
      background: rgba(3,7,18,0.7); backdrop-filter: blur(12px);
    }

    .brand h1 {
      font-size: 1.3rem; font-weight: 800; margin: 0;
      background: linear-gradient(to right, #fff, var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 900px) { .dashboard-grid { grid-template-columns: 1.1fr 0.9fr; } }

    .glass-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      display: flex; flex-direction: column;
    }
    .card-header {
      padding: 15px 20px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--card-border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .card-content { padding: 15px; }

    textarea {
      width: 100%; min-height: 250px;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-md);
      color: var(--text-main);
      padding: 15px; font-family: var(--font-sans);
      font-size: 0.95rem; resize: vertical; transition: 0.2s;
    }
    textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

    .output-area {
      font-family: var(--font-mono); font-size: 0.85rem; line-height: 1.4;
      background: #000; padding: 15px; border-radius: var(--radius-md);
      min-height: 300px; white-space: pre-wrap; color: #adbac7;
      border: 1px solid var(--card-border);
    }

    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
    .btn {
      padding: 10px 16px; border-radius: var(--radius-md); font-weight: 600;
      font-size: 0.85rem; cursor: pointer; transition: 0.2s;
      border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-whatsapp { background: #25d366; color: white; }
    .btn-outline { background: transparent; border-color: var(--card-border); color: var(--text-main); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--error); border-color: rgba(239, 68, 68, 0.2); }

    .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
    .badge-ok { background: rgba(16, 185, 129, 0.2); color: var(--success); }

    /* Items Editor */
    .item {
      border: 1px solid var(--card-border); border-radius: 12px;
      padding: 12px; background: rgba(255,255,255,0.02); margin-bottom: 10px;
    }
    .item.price-missing { border-left: 4px solid var(--warning); background: rgba(245, 158, 11, 0.05); }
    .extra-tag { color: var(--success); font-weight: 600; }
    .rem-tag { color: var(--error); text-decoration: line-through; opacity: 0.7; }

    /* Stats bar */
    .stats-bar {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 1100px;
      background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(15px);
      border: 1px solid var(--card-border); padding: 10px 20px;
      border-radius: 50px; display: flex; justify-content: space-between; align-items: center;
      z-index: 200; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }

    /* Modal Sheet */
    .sheet-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      display: none; z-index: 300; align-items: flex-end; justify-content: center;
    }
    .sheet-backdrop.open { display: flex; }
    .sheet {
      width: 100%; max-width: 800px; background: #111827;
      border-radius: 20px 20px 0 0; max-height: 90vh; overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    #toast {
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      padding: 10px 20px; border-radius: 50px; color: white;
      font-weight: 600; opacity: 0; transition: 0.3s; z-index: 1000;
    }
    #toast.show { opacity: 1; top: 100px; }

    .tabs-nav { display: flex; gap: 5px; background: #000; padding: 4px; border-radius: 10px; }
    .tab-btn {
      background: transparent; border: none; color: var(--text-muted);
      padding: 5px 12px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-radius: 7px;
    }
    .tab-btn.active { background: var(--accent); color: white; }

    @media print {
        .btn-group, header, .stats-bar, .tabs-nav, .small-note { display: none !important; }
        body { background: white; }
        .output-area { border: none; color: black; background: white; }
    }
  </style>
</head>
<body>

  <div id="toast"></div>

  <div class="app-container">
    <header>
      <div class="brand">
        <h1>WA Order Pro <span style="font-size: 0.8rem; opacity: 0.6;">V9</span></h1>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="btnConfirm" class="btn btn-outline">‚úÖ Conferma</button>
        <button id="openSettings" class="btn btn-outline">‚öôÔ∏è</button>
      </div>
    </header>

    <div class="dashboard-grid">
      <section class="glass-card">
        <div class="card-header">
          <span class="badge badge-ok">Input Messaggio</span>
          <span id="statusIndicator" style="font-size: 0.75rem;">Pronto</span>
        </div>
        <div class="card-content">
          <textarea id="mainInput" placeholder="Incolla qui la chat di WhatsApp..."></textarea>
          <div class="btn-group">
            <button id="btnAnalyze" class="btn btn-primary">üß† Analizza</button>
            <button id="btnGen" class="btn btn-primary">‚ú® Genera</button>
            <button id="btnCopy" class="btn btn-outline">üìã Copia</button>
            <button id="btnPrint" class="btn btn-outline">üñ®Ô∏è Stampa</button>
            <button id="btnCloseDay" class="btn btn-danger">üåô Fine Turno</button>
          </div>
        </div>
      </section>

      <section class="glass-card">
        <div class="card-header">
          <div class="tabs-nav">
            <button class="tab-btn active" data-view="kitchen">CUCINA</button>
            <button class="tab-btn" data-view="receipt">RICEVUTA</button>
          </div>
          <button id="btnWA" class="btn btn-whatsapp" style="padding: 4px 10px; font-size: 0.7rem;">üì≤ Invia WA</button>
        </div>
        <div class="card-content">
          <div id="outputContainer" class="output-area">In attesa di dati...</div>
        </div>
      </section>
    </div>
  </div>

  <div class="stats-bar">
    <div>
      <div style="font-size: 0.65rem; color: var(--text-muted);">PIZZE</div>
      <div id="countPizze" style="font-weight: 800; color: var(--accent);">0</div>
    </div>
    <div style="text-align: right;">
      <div style="font-size: 0.65rem; color: var(--text-muted);">TOTALE STIMATO</div>
      <div id="totalValue" style="font-weight: 800; color: var(--success);">‚Ç¨ 0.00</div>
    </div>
  </div>

  <div id="confirmBackdrop" class="sheet-backdrop">
    <div class="sheet">
      <div style="padding: 20px; border-bottom: 1px solid var(--card-border); display: flex; justify-content: space-between;">
        <strong id="confirmTitle">Revisione Ordine</strong>
        <button id="closeConfirm" style="background:none; border:none; color:white; cursor:pointer;">‚úï</button>
      </div>
      <div style="padding: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <input id="fName" placeholder="Nome Cliente" style="padding:10px; background:#000; border:1px solid #333; color:white; border-radius:8px;">
            <input id="fTime" placeholder="Orario (es. 20:30)" style="padding:10px; background:#000; border:1px solid #333; color:white; border-radius:8px;">
            <input id="fAddress" placeholder="Indirizzo" style="padding:10px; background:#000; border:1px solid #333; color:white; border-radius:8px; grid-column: span 2;">
        </div>
        
        <div id="itemsEditor"></div>
        
        <div class="btn-group">
            <button id="btnApplyConfirm" class="btn btn-primary" style="width:100%; justify-content:center;">‚úÖ Salva e Chiudi</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/* --- CONFIG & CATALOGO (Esempio) --- */
let CATALOG = {
    pizzas: {"margherita": 6, "diavola": 7.5, "capricciosa": 8.5},
    extras: {"crudo": 2, "doppia mozzarella": 1, "bufala": 2},
    deliveryFee: 1.5,
    currency: "‚Ç¨"
};

let DRAFT = { name: "", time: "", address: "", items: [], mode: "RITIRO" };
let ACTIVE_VIEW = "kitchen";

/* --- UTILITIES --- */
function showToast(msg, color = "#3b82f6") {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.background = color;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
}

function money(n) { return n.toFixed(2) + CATALOG.currency; }

/* --- PARSER --- */
function analyzeText() {
    const txt = document.getElementById('mainInput').value;
    if(!txt) return showToast("Testo vuoto!", "#ef4444");

    // Reset DRAFT
    DRAFT.items = [];
    
    // Logica semplificata di estrazione (V8 base + miglioramenti)
    const lines = txt.split('\n');
    lines.forEach(line => {
        const qtyMatch = line.match(/^(\d+)\s+(.+)/);
        if(qtyMatch) {
            const qty = parseInt(qtyMatch[1]);
            const name = qtyMatch[2].toLowerCase().trim();
            DRAFT.items.push({ qty, name, extras: [], removals: [], price: CATALOG.pizzas[name] || 0 });
        }
        
        const timeMatch = line.match(/(\d{2}[:.]\d{2})/);
        if(timeMatch) DRAFT.time = timeMatch[1];
    });

    showToast("Analisi completata!");
    updateStats();
}

/* --- LOGICA WHATSAPP --- */
function sendToWhatsApp() {
    if(DRAFT.items.length === 0) return showToast("Nulla da inviare", "#f59e0b");
    
    let msg = `*Conferma Ordine*\n`;
    msg += `üë§ Cliente: ${DRAFT.name || 'N/D'}\n`;
    msg += `‚è∞ Orario: ${DRAFT.time || 'N/D'}\n`;
    msg += `üìç Indirizzo: ${DRAFT.address || 'Ritiro'}\n\n`;
    
    let total = 0;
    DRAFT.items.forEach(it => {
        msg += `‚Ä¢ ${it.qty}x ${it.name} (${money(it.price)})\n`;
        total += it.price * it.qty;
    });
    
    msg += `\n*TOTALE: ${money(total)}*`;
    
    const encoded = encodeURIComponent(msg);
    window.open(`https://wa.me/?text=${encoded}`, '_blank');
}

/* --- UI RENDERING --- */
function generateOutput() {
    const container = document.getElementById('outputContainer');
    if(ACTIVE_VIEW === 'kitchen') {
        let out = `=== CUCINA ===\nORDINE PER: ${DRAFT.time || '--:--'}\n`;
        DRAFT.items.forEach(it => out += `${it.qty}x ${it.name.toUpperCase()}\n`);
        container.textContent = out;
    } else {
        let out = `=== RICEVUTA ===\nTOTAL: ${money(DRAFT.items.reduce((a,b)=>a+(b.price*b.qty),0))}\n`;
        container.textContent = out;
    }
}

function updateStats() {
    const total = DRAFT.items.reduce((sum, it) => sum + (it.price * it.qty), 0);
    const count = DRAFT.items.reduce((sum, it) => sum + it.qty, 0);
    document.getElementById('totalValue').textContent = money(total);
    document.getElementById('countPizze').textContent = count;
}

/* --- EVENTI --- */
document.getElementById('btnAnalyze').onclick = analyzeText;
document.getElementById('btnWA').onclick = sendToWhatsApp;
document.getElementById('btnGen').onclick = generateOutput;

document.getElementById('btnConfirm').onclick = () => {
    document.getElementById('confirmBackdrop').classList.add('open');
    renderEditor();
};

document.getElementById('closeConfirm').onclick = () => {
    document.getElementById('confirmBackdrop').classList.remove('open');
};

document.getElementById('btnApplyConfirm').onclick = () => {
    DRAFT.name = document.getElementById('fName').value;
    DRAFT.time = document.getElementById('fTime').value;
    DRAFT.address = document.getElementById('fAddress').value;
    document.getElementById('confirmBackdrop').classList.remove('open');
    updateStats();
    generateOutput();
};

function renderEditor() {
    const area = document.getElementById('itemsEditor');
    area.innerHTML = '';
    DRAFT.items.forEach((it, idx) => {
        const div = document.createElement('div');
        div.className = `item ${it.price === 0 ? 'price-missing' : ''}`;
        div.innerHTML = `
            <strong>${it.qty}x</strong> ${it.name} - ${money(it.price)}
            <button onclick="removeItem(${idx})" style="float:right; background:none; border:none; color:red;">üóëÔ∏è</button>
        `;
        area.appendChild(div);
    });
}

function removeItem(idx) {
    DRAFT.items.splice(idx, 1);
    renderEditor();
    updateStats();
}

// Tab Switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelector('.tab-btn.active').classList.remove('active');
        btn.classList.add('active');
        ACTIVE_VIEW = btn.dataset.view;
        generateOutput();
    }
});
</script>

</body>
</html>
