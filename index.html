<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Gestionale WhatsApp ‚Üí Comande (V7)</title>
  <style>
    :root{
      --bg:#0b1220; --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.10);
      --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --danger:#fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:linear-gradient(180deg,#070b14,var(--bg));color:var(--text)}
    .app{max-width:980px;margin:0 auto;padding:14px 14px 96px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;position:sticky;top:0;z-index:5;
      background:rgba(7,11,20,.78);backdrop-filter: blur(10px);padding:12px 10px;border-bottom:1px solid var(--border);
      border-radius:0 0 18px 18px;}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{font-size:16px;margin:0;font-weight:800}
    .title .sub{font-size:12px;color:var(--muted)}
    .iconbtn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:16px;line-height:1;cursor:pointer;-webkit-tap-highlight-color:transparent}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:4px 10px;border-radius:999px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:860px){.grid{grid-template-columns:1.05fr .95fr}}
    .card{border:1px solid var(--border);border-radius:var(--radius);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      box-shadow:0 8px 30px rgba(0,0,0,.25);overflow:hidden}
    .cardhead{padding:12px 12px 10px;background:rgba(255,255,255,.04);border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardhead h2{margin:0;font-size:14px}
    .cardbody{padding:12px}
    textarea{width:100%;min-height:220px;background:rgba(0,0,0,.25);color:var(--text);border:1px solid var(--border);
      border-radius:14px;padding:12px;font-size:15px;outline:none}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);border-radius:14px;padding:12px 14px;
      font-size:15px;cursor:pointer;-webkit-tap-highlight-color:transparent}
    .btn.primary{border-color:rgba(96,165,250,.6);background:rgba(96,165,250,.15)}
    .btn.danger{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.12)}
    .btn:active,.iconbtn:active{transform:scale(.99)}
    .hint{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.35}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);border-radius:999px;padding:8px 12px;
      font-size:13px;cursor:pointer}
    .tab.active{border-color:rgba(96,165,250,.65);background:rgba(96,165,250,.16)}
    .out{font-family:var(--mono);white-space:pre-wrap;line-height:1.25;font-size:13px;background:rgba(0,0,0,.22);
      border:1px solid var(--border);border-radius:14px;padding:12px;min-height:220px}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--danger)}
    .bottombar{position:fixed;left:0;right:0;bottom:0;z-index:6;background:rgba(7,11,20,.85);backdrop-filter: blur(12px);
      border-top:1px solid var(--border);padding:10px 14px}
    .bottomwrap{max-width:980px;margin:0 auto;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .bottomwrap .mini{font-size:12px;color:var(--muted)}
    .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.55);z-index:10}
    .modal.open{display:flex}
    .sheet{width:min(980px,100%);background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.06));
      border:1px solid var(--border);border-radius:20px 20px 0 0;padding:14px;max-height:86vh;overflow:auto}
    .sheethead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .sheethead h3{margin:0;font-size:15px}
    .section{border:1px solid var(--border);border-radius:16px;background:rgba(0,0,0,.18);padding:12px;margin:10px 0}
    .section h4{margin:0 0 10px;font-size:13px;color:var(--muted);font-weight:700}
    .formgrid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.formgrid{grid-template-columns:1fr 1fr}}
    label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
    input, select{width:100%;background:rgba(0,0,0,.22);color:var(--text);border:1px solid var(--border);border-radius:12px;
      padding:10px 12px;font-size:14px;outline:none}
    .jsonarea{min-height:300px;font-family:var(--mono);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{border:1px solid var(--border);background:rgba(255,255,255,.06);padding:8px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .chip.on{border-color:rgba(52,211,153,.6);background:rgba(52,211,153,.10)}
    .chip.warn{border-color:rgba(251,191,36,.55);background:rgba(251,191,36,.10)}
    .chip.danger{border-color:rgba(251,113,133,.55);background:rgba(251,113,133,.10)}
    .editor{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--border);background:rgba(0,0,0,.18);border-radius:16px;padding:10px}
    .itemhead{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px}
    .itemtitle{font-weight:800;font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    .miniinput{padding:9px 10px;border-radius:12px}
    .two{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.two{grid-template-columns:1fr 1fr}}
    @media print{
      .topbar,.bottombar,.no-print,.modal{display:none !important}
      body{background:#fff;color:#000}
      .app{padding:0;max-width:none}
      .card{border:none;box-shadow:none;background:none}
      .out{border:none;background:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <h1>Gestionale WhatsApp ‚Üí Comande (V7)</h1>
        <div class="sub">Modalit√† Conferma: prima correggi la comanda (tap veloci), poi stampa.</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="dayBadge" class="pill">‚Äî</span>
        <button id="openSettings" class="iconbtn" aria-label="Impostazioni">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardhead">
          <h2>Input WhatsApp</h2>
          <span class="pill" id="extractBadge">Estrazione: auto</span>
        </div>
        <div class="cardbody">
          <textarea id="input" placeholder="Incolla qui l‚Äôordine (anche tutta la chat)."></textarea>

          <div class="btnrow no-print">
            <button id="parse" class="btn primary">Analizza</button>
            <button id="confirm" class="btn">Conferma & Genera</button>
            <button id="copy" class="btn">Copia</button>
            <button id="print" class="btn">Stampa</button>
            <button id="closeDay" class="btn danger">Chiusura serale</button>
          </div>

          <div class="hint">
            üî• Flusso consigliato: <b>Analizza</b> ‚Üí correggi nella sezione ‚ÄúConferma‚Äù ‚Üí <b>Conferma & Genera</b> ‚Üí Stampa.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardhead">
          <div class="tabs no-print">
            <div class="tab active" data-view="confirm">Conferma</div>
            <div class="tab" data-view="kitchen">Comanda cucina</div>
            <div class="tab" data-view="receipt">Ricevuta cliente</div>
            <div class="tab" data-view="debug">Debug</div>
          </div>
        </div>
        <div class="cardbody">
          <div id="viewConfirm">
            <div class="section">
              <h4>Dati ordine</h4>
              <div class="two">
                <label>Tipo (tap)
                  <div class="row" style="margin-top:6px">
                    <span id="chipDelivery" class="chip">CONSEGNA</span>
                    <span id="chipPickup" class="chip">RITIRO</span>
                  </div>
                </label>
                <label>Orario
                  <input id="fTime" class="miniinput" placeholder="20:15" />
                </label>
                <label>Cliente
                  <input id="fName" class="miniinput" placeholder="Nome Cognome" />
                </label>
                <label>Telefono
                  <input id="fPhone" class="miniinput" inputmode="tel" placeholder="320..." />
                </label>
                <label>Indirizzo
                  <input id="fAddress" class="miniinput" placeholder="Via ..." />
                </label>
                <label>Note
                  <input id="fNotes" class="miniinput" placeholder="tagliate / scala B int.3 ..." />
                </label>
              </div>
            </div>

            <div class="section">
              <h4>Articoli (modificabili)</h4>
              <div class="row" style="margin-bottom:10px">
                <span class="chip" id="addPizza">+ Pizza</span>
                <span class="chip" id="addDrink">+ Bibita</span>
              </div>
              <div id="editor" class="editor"></div>
              <div class="hint">Tip: se una riga √® sbagliata, tocca ‚ÄúüóëÔ∏è‚Äù e aggiungila corretta.</div>
            </div>
          </div>

          <div id="outKitchen" class="out" style="display:none">‚Äî</div>
          <div id="outReceipt" class="out" style="display:none">‚Äî</div>
          <div id="outDebug" class="out" style="display:none">‚Äî</div>

          <div id="status" class="status no-print"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottombar no-print">
    <div class="bottomwrap">
      <div class="mini" id="printModeMini">Stampa: entrambe</div>
      <div class="mini" id="totalMini">Totale: ‚Äî</div>
    </div>
  </div>

  <div id="modal" class="modal no-print" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheethead">
        <h3>Impostazioni</h3>
        <button id="closeSettings" class="iconbtn" aria-label="Chiudi">‚úï</button>
      </div>

      <div class="section">
        <h4>Stampa</h4>
        <div class="formgrid">
          <label>
            Modalit√† stampa
            <select id="printMode">
              <option value="both">Entrambe (cucina + ricevuta)</option>
              <option value="kitchen">Solo comanda cucina</option>
              <option value="receipt">Solo ricevuta cliente</option>
            </select>
          </label>
          <label>
            Costo consegna (se CONSEGNA)
            <input id="deliveryFee" inputmode="decimal" placeholder="0.00" />
          </label>
        </div>
      </div>

      <div class="section">
        <h4>Default</h4>
        <div class="formgrid">
          <label>
            Pizza base ‚Äúcustom‚Äù
            <select id="fallbackBasePizza"></select>
          </label>
          <label>
            Default size
            <select id="fallbackSize"></select>
          </label>
        </div>
      </div>

      <div class="section">
        <h4>Catalogo (JSON)</h4>
        <div class="hint">Puoi mettere prezzi su: <b>pizzas</b>, <b>extras</b>, <b>doughs</b>, <b>sizes</b> (grande/mezzo metro), <b>formats</b> (schiacciata/verace).</div>
        <textarea id="catalog" class="jsonarea" spellcheck="false"></textarea>
        <div class="btnrow">
          <button id="saveCatalog" class="btn primary">Salva catalogo</button>
          <button id="resetCatalog" class="btn">Ripristina esempio</button>
          <button id="exportCatalog" class="btn">Export</button>
          <button id="importCatalog" class="btn">Import</button>
        </div>
        <div id="catStatus" class="status"></div>
      </div>
    </div>
  </div>

<script>
/* ===================== STORAGE ===================== */
const LS = { catalog:"wa_gestionale_catalog_v7", settings:"wa_gestionale_settings_v7", lastDay:"wa_gestionale_lastday_v7" };

const SAMPLE_CATALOG = {
  currency:"‚Ç¨",
  pizzas:{
    "margherita":6.00,
    "margherita bianca":6.50,
    "capricciosa":8.50,
    "salame piccante":7.50
  },
  drinks:{ "coca cola 33":2.50, "acqua 0.5":1.50, "birra 33":3.50 },
  extras:{
    "speck":1.50, "brie":1.50, "porcini":2.00, "grana":1.00,
    "prosciutto cotto":1.80, "gorgonzola":1.80, "crudo di parma":2.50,
    "panna":1.20, "cipolle":0.80, "verdure grigliate":1.50, "mozzarella senza lattosio":1.50,
    "mozzarella":1.00
  },
  doughs:{ "classico":0.00, "integrale":1.00, "senza glutine":3.00 },
  sizes:{ "normale":0.00, "grande":0.00, "mezzo metro":0.00 },
  formats:{ "tonda":0.00, "schiacciata":0.00, "verace":0.00 },
  aliases:{
    "marg":"margherita",
    "sg":"senza glutine","s.g.":"senza glutine","senza glutine":"senza glutine",
    "mezzo-metro":"mezzo metro","mezzometro":"mezzo metro",
    "coca":"coca cola 33","acqua":"acqua 0.5"
  }
};

const DEFAULT_SETTINGS = {
  printMode:"both",
  deliveryFee:0.00,
  fallbackBasePizza:"margherita",
  fallbackSize:"normale"
};

function loadCatalog(){const s=localStorage.getItem(LS.catalog); if(s){try{return JSON.parse(s);}catch{}} return structuredClone(SAMPLE_CATALOG);}
function saveCatalog(obj){localStorage.setItem(LS.catalog, JSON.stringify(obj,null,2));}
function loadSettings(){const s=localStorage.getItem(LS.settings); if(s){try{return {...DEFAULT_SETTINGS, ...JSON.parse(s)};}catch{}} return structuredClone(DEFAULT_SETTINGS);}
function saveSettings(obj){localStorage.setItem(LS.settings, JSON.stringify(obj,null,2));}

/* ===================== HELPERS ===================== */
let CATALOG = loadCatalog();
let SETTINGS = loadSettings();
let DRAFT = null; // editable order (confirmed UI)
let LAST_PARSED = null;

function todayKey(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;}
function nowStr(){const d=new Date();const p=n=>String(n).padStart(2,'0');return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;}
function normalizeTime(t){const m=t.match(/(\d{1,2})[.:](\d{2})/); if(!m) return ""; return `${String(Number(m[1])).padStart(2,'0')}:${m[2]}`;}
function stripChatNoise(line){return line.replace(/\s+\d{1,2}:\d{2}\s*$/,'').trim();}
function safeLower(s){return (s||"").toLowerCase();}
function normSpaces(s){return (s||"").replace(/\s+/g,' ').trim();}
function money(n){return (Math.round((n+Number.EPSILON)*100)/100).toFixed(2);}

function setStatus(msg,type=""){const el=document.getElementById("status"); el.className="status no-print "+(type==="ok"?"ok":type==="warn"?"warn":type==="err"?"err":""); el.textContent=msg||"";}
function setCatStatus(msg,type=""){const el=document.getElementById("catStatus"); el.className="status "+(type==="ok"?"ok":type==="warn"?"warn":type==="err"?"err":""); el.textContent=msg||"";}
function ensureDaily(){const t=todayKey();document.getElementById("dayBadge").textContent=`Giorno: ${t}`;const last=localStorage.getItem(LS.lastDay);if(last!==t){localStorage.setItem(LS.lastDay,t);setStatus("Nuovo giorno: pronto.","ok");}}

function resolveAlias(cat,raw){
  const k=normSpaces(safeLower(raw));
  if(cat.aliases && cat.aliases[k]) return cat.aliases[k];
  return k;
}

/* ===================== PARSER (legend baseline) ===================== */
function isStandaloneTime(line){ return /^\d{1,2}[:.]\d{2}$/.test(line.trim()); }
function looksLikeAddressLine(line){
  const l=safeLower(line).trim();
  if(/^indirizzo\s*:/.test(l)) return true;
  if(/^in\s+(via|viale|piazza|corso|strada)\b/.test(l)) return true;
  return /^(via|viale|piazza|corso|strada|v\.|p\.|c\.so)\b/.test(l);
}
function cleanAddress(line){ return normSpaces(line.replace(/^indirizzo\s*:\s*/i,"").replace(/^in\s+/i,"")); }
function looksLikeDetailsLine(line){
  const l=safeLower(line);
  return /\b(scala|interno|int\.|int\b|citofono|piano|appartamento|palazzina)\b/.test(l);
}
function looksLikeNoteLine(line){
  const l=safeLower(line);
  return /\b(tagliate|tagliata|spicchi|ben\s+cotta|poco\s+cotta)\b/.test(l);
}
function looksLikeGreetingOrMeta(line){
  const l=safeLower(line);
  if(/^(ciao|buonasera|buongiorno|salve)\b/.test(l)) return true;
  if(/\bvolevo ordinare\b/.test(l)) return true;
  if(/\bstasera\b/.test(l)) return true;
  return false;
}
function extractQtyAndText(line){
  let m=line.match(/^(\d+)\s+(.+)$/);
  if(m) return {qty:Number(m[1]), text:m[2].trim()};
  m=line.match(/^(.+?)\s*[x√ó]\s*(\d+)$/i);
  if(m) return {qty:Number(m[2]), text:m[1].trim()};
  return {qty:1, text:line.trim()};
}
function detectPickupDelivery(text){
  const t=safeLower(text);
  const hasPickup = /\b(ritiro|asporto|take away|takeaway|passo a prender|vengo a prender|passo a ritir|vengo a ritir)\b/.test(t);
  const hasDelivery = /\b(consegna|domicilio|a casa|delivery)\b/.test(t);
  if(hasPickup && !hasDelivery) return "RITIRO";
  if(hasDelivery && !hasPickup) return "CONSEGNA";
  if(hasDelivery && hasPickup) return "CONSEGNA/RITIRO";
  return "";
}
function detectPhone(line){
  const pm=line.match(/(\+?\d[\d\s\-]{6,}\d)/);
  if(!pm) return "";
  return pm[1].replace(/[^\d+]/g,'');
}
function looksLikePersonName(line){
  const s=normSpaces(line);
  if(!s || s.length<3) return false;
  if(/\d/.test(s)) return false;
  if(looksLikeAddressLine(s)) return false;
  const words=s.split(" ");
  if(words.length<2 || words.length>4) return false;
  const cap = words.filter(w=>/^[A-Z√Ä√à√â√å√í√ô][a-z√†√®√©√¨√≤√π'‚Äô-]+$/.test(w)).length;
  return cap>=2;
}
function detectDough(cat, text){
  if(/\b(senza\s+glutine|sg|s\.g\.)\b/i.test(text)) return "senza glutine";
  const lower=safeLower(text);
  for(const d of Object.keys(cat.doughs||{})){
    if(d==="senza glutine") continue;
    if(lower.includes(safeLower(d))) return d;
  }
  return "classico";
}
function detectSize(cat, text, fallback){
  let lower=safeLower(text).replace(/mezzo[\s-]?metro/g,"mezzo metro");
  for(const s of Object.keys(cat.sizes||{})){
    if(s==="normale") continue;
    if(lower.includes(safeLower(s))) return s;
  }
  return fallback || "normale";
}
function detectFormat(cat, text){
  const lower=safeLower(text);
  for(const f of Object.keys(cat.formats||{})){
    if(f==="tonda") continue;
    if(lower.includes(safeLower(f))) return f;
  }
  return "tonda";
}
function findPizzaName(cat, text){
  let t=normSpaces(safeLower(text))
    .replace(/\b(senza\s+glutine|sg|s\.g\.)\b/g,'')
    .replace(/\b(impasto|formato|pizza|pizze)\b/g,'')
    .replace(/\b(mezzo\s*metro|grande|schiacciata|verace)\b/g,'')
    .replace(/\+.*$/g,'')
    .trim();

  const keys=Object.keys(cat.pizzas||{}).sort((a,b)=>b.length-a.length);
  for(const k of keys){ if(t.includes(safeLower(k))) return k; }

  const alias=resolveAlias(cat, t);
  if(cat.pizzas && cat.pizzas[alias] != null) return alias;

  return t || text.trim();
}
function parseExtras(cat, text){
  let t=text.replace(/\bsenza\s+glutine\b/ig," ").replace(/\bsg\b/ig," ").replace(/\bs\.g\.\b/ig," ");
  const lower=safeLower(t);

  const removals=[];
  const senza=[...t.matchAll(/\bsenza\s+([a-z√†√®√©√¨√≤√π0-9'\- ]{2,})/gi)].map(m=>normSpaces(m[1]));
  for(const s of senza){ removals.push(resolveAlias(cat,s)); }

  const extras=[];
  const plus=[...t.matchAll(/(?:^|\s)(?:\+|pi[√πu])\s*([a-z√†√®√©√¨√≤√π0-9'\- ]{2,})/gi)].map(m=>normSpaces(m[1]));
  for(const p of plus){ extras.push(resolveAlias(cat,p)); }

  for(const ex of Object.keys(cat.extras||{})){
    const exL=safeLower(ex);
    if(new RegExp(`\\b${exL.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\b`).test(lower)){
      if(removals.some(r=>safeLower(r)===exL)) continue;
      if(!extras.some(e=>safeLower(e)===exL)) extras.push(ex);
    }
  }
  return {extrasFull:[...new Set(extras)], removals:[...new Set(removals)]};
}
function parseGustiLine(line){
  const l=safeLower(line).replace(/mezzo[\s-]?metro/g,"mezzo metro");
  const m=l.match(/\b(\d+)\s*(?:gust[oi]|gusto|gusti)\b/);
  if(m) return Number(m[1]);
  if(/\bdue\s+gust/i.test(l)) return 2;
  if(/\btre\s+gust/i.test(l)) return 3;
  if(/\bun\s+gust/i.test(l)) return 1;
  return 0;
}
function splitTwoGusti(text){
  const parts = text.split(/\bmet[√†a]\b/ig).map(s=>normSpaces(s)).filter(Boolean);
  if(parts.length>=3){
    const a = parts[1].replace(/\be\b$/i,"").trim();
    const b = parts[2].trim();
    return [a,b];
  }
  return null;
}

function parseOrder(rawText){
  const text=(rawText||"").replace(/\r/g,"").trim();
  const lines = text.split("\n").map(x=>stripChatNoise(x).trim()).filter(Boolean);

  let name="", address="", phone="", desiredTime="", notes="";
  let mode = detectPickupDelivery(text);

  for(const ln of lines){
    const tm=ln.match(/\b(?:alle|per\s*le|ore)\s*(\d{1,2}[.:]\d{2})\b/i) || ln.match(/\b(\d{1,2}[.:]\d{2})\b/);
    if(tm){ desiredTime=normalizeTime(tm[1]); break; }
  }
  for(const ln of lines){
    if(looksLikeAddressLine(ln)){ address = cleanAddress(ln); break; }
  }
  for(const ln of lines){
    const ph=detectPhone(ln);
    if(ph) phone=ph;
  }
  for(let i=lines.length-1;i>=0;i--){
    const ln=lines[i];
    if(looksLikePersonName(ln) && !/^\d+\s+/.test(ln)){ name = normSpaces(ln); break; }
  }
  for(const ln of lines){
    if(looksLikeDetailsLine(ln)) notes = notes ? `${notes} | ${normSpaces(ln)}` : normSpaces(ln);
    if(looksLikeNoteLine(ln)) notes = notes ? `${notes} | ${normSpaces(ln)}` : normSpaces(ln);
  }

  let defaultSize = SETTINGS.fallbackSize || "normale";
  if(/\bmezzo[\s-]?metro\b/i.test(text)) defaultSize = "mezzo metro";

  const items=[];
  for(const ln0 of lines){
    const ln=ln0.trim();
    if(!ln) continue;
    if(isStandaloneTime(ln)) continue;
    if(looksLikeGreetingOrMeta(ln)) continue;

    if(phone && ln.replace(/\D/g,'') === phone.replace(/\D/g,'')) continue;
    if(name && safeLower(ln)===safeLower(name)) continue;
    if(address && looksLikeAddressLine(ln) && safeLower(cleanAddress(ln))===safeLower(address)) continue;
    if(looksLikeNoteLine(ln) && !/^\d+\s+/.test(ln)) continue;
    if(looksLikeDetailsLine(ln) && !/^\d+\s+/.test(ln)) continue;

    const {qty, text:itemTextRaw} = extractQtyAndText(ln);
    if(!itemTextRaw) continue;

    // drink quick detect
    const drinkKey = (() => {
      const t=resolveAlias(CATALOG, itemTextRaw);
      if(CATALOG.drinks && CATALOG.drinks[t]!=null) return t;
      // contains match
      const low=safeLower(t);
      for(const k of Object.keys(CATALOG.drinks||{})){
        if(low.includes(safeLower(k))) return k;
      }
      return "";
    })();
    if(drinkKey){
      items.push({ kind:"drink", qty, label:drinkKey });
      continue;
    }

    const gustiN = parseGustiLine(itemTextRaw);
    const hasMezzoMetro = /\bmezzo[\s-]?metro\b/i.test(itemTextRaw);
    const sizeKey = detectSize(CATALOG, itemTextRaw, hasMezzoMetro ? "mezzo metro" : defaultSize);
    const formatKey = detectFormat(CATALOG, itemTextRaw);
    const doughKey = detectDough(CATALOG, itemTextRaw);

    if(gustiN>0){
      let note = normSpaces(itemTextRaw
        .replace(/\b\d+\s*gust[oi]\b/ig,"")
        .replace(/\bdue\s+gusti\b/ig,"")
        .replace(/\btre\s+gusti\b/ig,"")
        .replace(/\bun\s+gusto\b/ig,"")
      );

      let gustiNotes=[];
      if(gustiN===2){
        const sp=splitTwoGusti(note);
        if(sp) gustiNotes=sp;
      }

      const {extrasFull, removals} = parseExtras(CATALOG, note);
      items.push({
        kind:"pizza", qty,
        pizzaKey: SETTINGS.fallbackBasePizza,
        doughKey, sizeKey, formatKey,
        extrasFull, removals,
        gusti: gustiN,
        gustiNotes,
        freeText: note
      });
      continue;
    }

    if(/^\d+\s+/.test(ln)){
      const cand = findPizzaName(CATALOG, itemTextRaw);
      const known = (CATALOG.pizzas && CATALOG.pizzas[cand]!=null);
      const pizzaKey = known ? cand : (SETTINGS.fallbackBasePizza || cand);
      const {extrasFull, removals} = parseExtras(CATALOG, itemTextRaw);
      items.push({ kind:"pizza", qty, pizzaKey, doughKey, sizeKey, formatKey, extrasFull, removals, gusti:0, gustiNotes:[], freeText: known?"":itemTextRaw });
    }
  }

  return { name, phone, address, desiredTime, mode, notes, items, defaultSize, raw:text };
}

/* ===================== PRICING (from draft) ===================== */
function extrasSum(extras){
  return (extras||[]).reduce((acc, ex)=>{
    const k=resolveAlias(CATALOG, ex);
    const p=(CATALOG.extras && CATALOG.extras[k]!=null)?Number(CATALOG.extras[k]):0;
    return acc+p;
  },0);
}
function pricePizza(it){
  const baseKnown=(CATALOG.pizzas && CATALOG.pizzas[it.pizzaKey]!=null);
  const base=baseKnown?Number(CATALOG.pizzas[it.pizzaKey]):0;
  const dough=(CATALOG.doughs && CATALOG.doughs[it.doughKey]!=null)?Number(CATALOG.doughs[it.doughKey]):0;
  const size=(CATALOG.sizes && CATALOG.sizes[it.sizeKey]!=null)?Number(CATALOG.sizes[it.sizeKey]):0;
  const fmt=(CATALOG.formats && CATALOG.formats[it.formatKey]!=null)?Number(CATALOG.formats[it.formatKey]):0;
  const ex=extrasSum(it.extrasFull);
  return { unit: base + dough + size + fmt + ex, known: baseKnown };
}
function priceDrink(it){
  const key=resolveAlias(CATALOG, it.label);
  const known=(CATALOG.drinks && CATALOG.drinks[key]!=null);
  const unit=known?Number(CATALOG.drinks[key]):0;
  return { unit, known, label:key };
}
function computeTotals(order){
  let total=0, missing=0;
  const pricedItems = order.items.map(it=>{
    if(it.kind==="drink"){
      const pr=priceDrink(it);
      const lineTotal=pr.unit*it.qty;
      if(!pr.known) missing++;
      total+=lineTotal;
      return {...it, label:pr.label, unitPrice:pr.unit, lineTotal, priceKnown:pr.known};
    } else {
      const pr=pricePizza(it);
      const lineTotal=pr.unit*it.qty;
      if(!pr.known) missing++;
      total+=lineTotal;
      return {...it, unitPrice:pr.unit, lineTotal, priceKnown:pr.known, glutenFree: it.doughKey==="senza glutine"};
    }
  });

  if(order.mode==="CONSEGNA"){
    const fee=Number(SETTINGS.deliveryFee||0);
    if(fee>0) total+=fee;
    order.deliveryFee=fee;
  } else {
    order.deliveryFee=0;
  }
  order.total=total;
  order.missing=missing;
  order.items=pricedItems;
  return order;
}

/* ===================== OUTPUT ===================== */
function fmtKitchen(o){
  const sep="--------------------------------";
  const head=[
    "================================",
    "          COMANDA CUCINA        ",
    "================================",
    `Ora: ${nowStr()}`,
    o.desiredTime ? `Orario: ${o.desiredTime}` : "Orario: ‚Äî",
    `Tipo: ${o.mode || "‚Äî"}`,
    o.name ? `Cliente: ${o.name}` : "Cliente: ‚Äî",
    o.phone ? `Tel: ${o.phone}` : "",
    o.address ? `Indirizzo: ${o.address}` : "Indirizzo: ‚Äî",
    o.notes ? `Note: ${o.notes}` : "",
    sep,
    "ARTICOLI:"
  ].filter(Boolean);

  const body=(o.items.length?o.items:[]).map(it=>{
    if(it.kind==="drink") return `${String(it.qty).padStart(2,' ')}  BIBITA  ${it.label}`;
    const gf = it.doughKey==="senza glutine" ? "  !!! SENZA GLUTINE !!!" : "";
    const size = (it.sizeKey && it.sizeKey!=="normale") ? ` (${it.sizeKey})` : "";
    const fmt  = (it.formatKey && it.formatKey!=="tonda") ? ` <${it.formatKey}>` : "";
    const dough= (it.doughKey && it.doughKey!=="classico") ? ` {${it.doughKey}}` : "";
    const exF = (it.extrasFull?.length) ? ` +${it.extrasFull.join(", ")}` : "";
    const rem = (it.removals?.length) ? ` -${it.removals.join(", ")}` : "";
    const gusti = it.gusti ? ` [${it.gusti} gusti]` : "";
    const gustiNote = (it.gustiNotes?.length) ? `\n     ‚Üí ${it.gustiNotes.join(" | ")}` : (it.gusti && it.freeText ? `\n     ‚Üí ${it.freeText}` : "");
    return `${String(it.qty).padStart(2,' ')}  ${it.pizzaKey}${gusti}${size}${fmt}${dough}${exF}${rem}${gf}${gustiNote}`;
  }).join("\n");

  const totP = o.items.filter(x=>x.kind==="pizza").reduce((a,x)=>a+x.qty,0);
  const foot=[sep, `Totale pizze: ${totP}`, "================================"];
  return [...head, body||"‚Äî", ...foot].join("\n");
}
function fmtReceipt(o){
  const cur=CATALOG.currency||"‚Ç¨";
  const sep="--------------------------------";
  const lines=[];
  lines.push("================================");
  lines.push("         RICEVUTA CLIENTE       ");
  lines.push("================================");
  lines.push(`Ora: ${nowStr()}`);
  if(o.desiredTime) lines.push(`Orario: ${o.desiredTime}`);
  lines.push(`Tipo: ${o.mode || "‚Äî"}`);
  if(o.name) lines.push(`Cliente: ${o.name}`);
  if(o.phone) lines.push(`Tel: ${o.phone}`);
  if(o.address) lines.push(`Indirizzo: ${o.address}`);
  if(o.notes) lines.push(`Note: ${o.notes}`);
  lines.push(sep);

  for(const it of o.items){
    if(it.kind==="drink"){
      lines.push(`${it.qty} x ${it.label}`);
      if(!it.priceKnown) lines.push(`   ‚ö†Ô∏è PREZZO NON TROVATO`);
      else lines.push(`   ${money(it.unitPrice)}${cur} -> ${money(it.lineTotal)}${cur}`);
      lines.push(sep);
      continue;
    }
    const size = (it.sizeKey && it.sizeKey!=="normale") ? ` (${it.sizeKey})` : "";
    const fmt  = (it.formatKey && it.formatKey!=="tonda") ? ` <${it.formatKey}>` : "";
    const dough= (it.doughKey && it.doughKey!=="classico") ? ` {${it.doughKey}}` : "";
    const exF = (it.extrasFull?.length) ? ` +${it.extrasFull.join(", ")}` : "";
    const rem = (it.removals?.length) ? ` -${it.removals.join(", ")}` : "";
    const gusti = it.gusti ? ` [${it.gusti} gusti]` : "";
    lines.push(`${it.qty} x ${it.pizzaKey}${gusti}${size}${fmt}${dough}${exF}${rem}`);
    if(!it.priceKnown) lines.push(`   ‚ö†Ô∏è PREZZO NON TROVATO`);
    else lines.push(`   ${money(it.unitPrice)}${cur} -> ${money(it.lineTotal)}${cur}`);
    if(it.gustiNotes?.length) lines.push(`   ‚Üí ${it.gustiNotes.join(" | ")}`);
    else if(it.gusti && it.freeText) lines.push(`   ‚Üí ${it.freeText}`);
    lines.push(sep);
  }

  if(o.deliveryFee && o.deliveryFee>0){
    lines.push(`CONSEGNA`);
    lines.push(`   ${money(o.deliveryFee)}${cur}`);
    lines.push(sep);
  }

  lines.push(`TOTALE: ${money(o.total)}${cur}`);
  if(o.missing>0) lines.push(`‚ö†Ô∏è ${o.missing} riga/e senza prezzo: aggiorna il catalogo.`);
  lines.push("================================");
  return lines.join("\n");
}

/* ===================== CONFIRM EDITOR UI ===================== */
function setChipMode(mode){
  const d=document.getElementById("chipDelivery");
  const p=document.getElementById("chipPickup");
  d.classList.toggle("on", mode==="CONSEGNA");
  p.classList.toggle("on", mode==="RITIRO");
}
function getAllKeys(obj){ return Object.keys(obj||{}).sort((a,b)=>a.localeCompare(b)); }

function buildSelect(options, value){
  const sel=document.createElement("select");
  for(const k of options){
    const o=document.createElement("option");
    o.value=k; o.textContent=k;
    sel.appendChild(o);
  }
  sel.value=value;
  return sel;
}

function renderEditor(){
  const ed=document.getElementById("editor");
  ed.innerHTML="";

  if(!DRAFT){ ed.innerHTML = `<div class="small">Premi <b>Analizza</b> per creare la bozza modificabile.</div>`; return; }

  DRAFT.items.forEach((it, idx)=>{
    const box=document.createElement("div");
    box.className="item";

    const head=document.createElement("div");
    head.className="itemhead";

    const left=document.createElement("div");
    const title=document.createElement("div");
    title.className="itemtitle";
    title.textContent = it.kind==="drink" ? `Bibita #${idx+1}` : `Pizza #${idx+1}`;
    const sub=document.createElement("div");
    sub.className="small";
    sub.textContent = it.kind==="drink" ? "Modifica nome/qty" : "Modifica qty/pizza/impasto/size/formato/extra";
    left.appendChild(title); left.appendChild(sub);

    const del=document.createElement("span");
    del.className="chip danger";
    del.textContent="üóëÔ∏è";
    del.onclick=()=>{ DRAFT.items.splice(idx,1); renderEditor(); previewTotals(); };

    head.appendChild(left); head.appendChild(del);
    box.appendChild(head);

    const row1=document.createElement("div");
    row1.className="two";

    const qty=document.createElement("input");
    qty.className="miniinput";
    qty.inputMode="numeric";
    qty.value=String(it.qty||1);
    qty.onchange=()=>{ it.qty=Math.max(1, Number(qty.value||1)); previewTotals(); };

    const name=document.createElement("input");
    name.className="miniinput";
    name.placeholder = it.kind==="drink" ? "coca cola 33" : "margherita";
    name.value = it.kind==="drink" ? it.label : it.pizzaKey;
    name.onchange=()=>{
      if(it.kind==="drink") it.label=normSpaces(name.value);
      else it.pizzaKey=normSpaces(name.value);
      previewTotals();
    };

    const lq=document.createElement("label"); lq.textContent="Quantit√†"; lq.appendChild(qty);
    const ln=document.createElement("label"); ln.textContent=it.kind==="drink"?"Bibita":"Pizza"; ln.appendChild(name);

    row1.appendChild(lq); row1.appendChild(ln);
    box.appendChild(row1);

    if(it.kind==="pizza"){
      const row2=document.createElement("div");
      row2.className="two";

      const dough = buildSelect(getAllKeys(CATALOG.doughs), it.doughKey||"classico");
      dough.onchange=()=>{ it.doughKey=dough.value; previewTotals(); };

      const size = buildSelect(getAllKeys(CATALOG.sizes), it.sizeKey||SETTINGS.fallbackSize||"normale");
      size.onchange=()=>{ it.sizeKey=size.value; previewTotals(); };

      const fmt = buildSelect(getAllKeys(CATALOG.formats), it.formatKey||"tonda");
      fmt.onchange=()=>{ it.formatKey=fmt.value; previewTotals(); };

      const ld=document.createElement("label"); ld.textContent="Impasto"; ld.appendChild(dough);
      const ls=document.createElement("label"); ls.textContent="Size"; ls.appendChild(size);
      const lf=document.createElement("label"); lf.textContent="Formato"; lf.appendChild(fmt);

      row2.appendChild(ld); row2.appendChild(ls);
      box.appendChild(row2);

      const row3=document.createElement("div");
      row3.className="row";
      row3.style.marginTop="10px";

      const addExtra=document.createElement("span");
      addExtra.className="chip";
      addExtra.textContent="+ Extra";
      addExtra.onclick=()=>{
        const x=prompt("Extra da aggiungere (es. porcini):");
        if(!x) return;
        it.extrasFull = [...new Set([...(it.extrasFull||[]), normSpaces(x)])];
        renderEditor(); previewTotals();
      };

      const addRemoval=document.createElement("span");
      addRemoval.className="chip";
      addRemoval.textContent="- Ingrediente";
      addRemoval.onclick=()=>{
        const x=prompt("Ingrediente da togliere (es. mozzarella):");
        if(!x) return;
        it.removals = [...new Set([...(it.removals||[]), normSpaces(x)])];
        renderEditor(); previewTotals();
      };

      const gf=document.createElement("span");
      gf.className="chip";
      gf.textContent="Senza glutine";
      gf.classList.toggle("on", it.doughKey==="senza glutine");
      gf.onclick=()=>{
        it.doughKey = (it.doughKey==="senza glutine") ? "classico" : "senza glutine";
        renderEditor(); previewTotals();
      };

      const sh=document.createElement("span");
      sh.className="chip";
      sh.textContent="Schiacciata";
      sh.classList.toggle("on", it.formatKey==="schiacciata");
      sh.onclick=()=>{
        it.formatKey = (it.formatKey==="schiacciata") ? "tonda" : "schiacciata";
        renderEditor(); previewTotals();
      };

      const ve=document.createElement("span");
      ve.className="chip";
      ve.textContent="Verace";
      ve.classList.toggle("on", it.formatKey==="verace");
      ve.onclick=()=>{
        it.formatKey = (it.formatKey==="verace") ? "tonda" : "verace";
        renderEditor(); previewTotals();
      };

      const g=document.createElement("span");
      g.className="chip warn";
      g.textContent= it.gusti ? `${it.gusti} gusti` : "gusti";
      g.onclick=()=>{
        const n=prompt("Numero gusti (vuoto = nessuno):", it.gusti?String(it.gusti):"");
        if(n===null) return;
        const v=Number(n||0);
        it.gusti = v>0 ? v : 0;
        if(!it.gusti) it.gustiNotes=[];
        renderEditor(); previewTotals();
      };

      row3.appendChild(addExtra);
      row3.appendChild(addRemoval);
      row3.appendChild(gf);
      row3.appendChild(sh);
      row3.appendChild(ve);
      row3.appendChild(g);
      box.appendChild(row3);

      if((it.extrasFull||[]).length || (it.removals||[]).length || (it.gustiNotes||[]).length){
        const meta=document.createElement("div");
        meta.className="small";
        meta.style.marginTop="8px";
        const ex = (it.extrasFull||[]).length ? `+${it.extrasFull.join(", ")}` : "";
        const rm = (it.removals||[]).length ? ` -${it.removals.join(", ")}` : "";
        const gn = (it.gustiNotes||[]).length ? ` | gusti: ${it.gustiNotes.join(" | ")}` : "";
        meta.textContent = [ex,rm,gn].filter(Boolean).join(" ");
        box.appendChild(meta);
      }
    }

    ed.appendChild(box);
  });
}

function previewTotals(){
  if(!DRAFT){
    document.getElementById("totalMini").textContent="Totale: ‚Äî";
    return;
  }
  const computed=computeTotals(structuredClone(DRAFT));
  document.getElementById("totalMini").textContent=`Totale: ${money(computed.total)}${CATALOG.currency||"‚Ç¨"}`;
}

/* ===================== DRAFT <-> FORM ===================== */
function draftFromParsed(p){
  return {
    mode: p.mode || "",
    desiredTime: p.desiredTime || "",
    name: p.name || "",
    phone: p.phone || "",
    address: p.address || "",
    notes: p.notes || "",
    items: (p.items||[]).map(it=>{
      if(it.kind==="drink"){
        return { kind:"drink", qty:it.qty||1, label: it.label || "coca cola 33" };
      }
      return {
        kind:"pizza",
        qty: it.qty||1,
        pizzaKey: it.pizzaKey || SETTINGS.fallbackBasePizza,
        doughKey: it.doughKey || "classico",
        sizeKey: it.sizeKey || SETTINGS.fallbackSize || "normale",
        formatKey: it.formatKey || "tonda",
        extrasFull: it.extrasFull || [],
        removals: it.removals || [],
        gusti: it.gusti || 0,
        gustiNotes: it.gustiNotes || [],
        freeText: it.freeText || ""
      };
    })
  };
}
function pushDraftToForm(){
  document.getElementById("fTime").value = DRAFT?.desiredTime || "";
  document.getElementById("fName").value = DRAFT?.name || "";
  document.getElementById("fPhone").value = DRAFT?.phone || "";
  document.getElementById("fAddress").value = DRAFT?.address || "";
  document.getElementById("fNotes").value = DRAFT?.notes || "";
  setChipMode(DRAFT?.mode || "");
}
function pullFormToDraft(){
  if(!DRAFT) return;
  DRAFT.desiredTime = normSpaces(document.getElementById("fTime").value);
  DRAFT.name = normSpaces(document.getElementById("fName").value);
  DRAFT.phone = normSpaces(document.getElementById("fPhone").value);
  DRAFT.address = normSpaces(document.getElementById("fAddress").value);
  DRAFT.notes = normSpaces(document.getElementById("fNotes").value);
}

/* ===================== MAIN FLOW ===================== */
function analyze(){
  ensureDaily();
  const raw=document.getElementById("input").value||"";
  if(!raw.trim()){ setStatus("Incolla un messaggio WhatsApp.","warn"); return; }
  LAST_PARSED = parseOrder(raw);
  DRAFT = draftFromParsed(LAST_PARSED);
  pushDraftToForm();
  renderEditor();
  previewTotals();
  document.getElementById("extractBadge").textContent="Estrazione: pronta";
  setStatus("Analisi OK. Ora correggi nella tab Conferma.","ok");
}

function confirmAndGenerate(){
  if(!DRAFT){ setStatus("Prima fai Analizza.","warn"); return; }
  pullFormToDraft();
  const final = computeTotals(structuredClone(DRAFT));
  // outputs
  document.getElementById("outKitchen").textContent = fmtKitchen(final);
  document.getElementById("outReceipt").textContent = fmtReceipt(final);

  const dbg=[];
  dbg.push("=== DEBUG ===");
  dbg.push(`Tipo: ${final.mode||"‚Äî"}`);
  dbg.push(`Orario: ${final.desiredTime||"‚Äî"}`);
  dbg.push(`Cliente: ${final.name||"‚Äî"}`);
  dbg.push(`Tel: ${final.phone||"‚Äî"}`);
  dbg.push(`Indirizzo: ${final.address||"‚Äî"}`);
  dbg.push(`Note: ${final.notes||"‚Äî"}`);
  dbg.push(`Righe: ${final.items.length}`);
  dbg.push(`Totale: ${money(final.total)}${CATALOG.currency||"‚Ç¨"}`);
  if(final.missing>0) dbg.push(`Prezzi mancanti: ${final.missing}`);
  document.getElementById("outDebug").textContent = dbg.join("\n");

  // switch to kitchen tab automatically
  activateTab("kitchen");
  setStatus("Generato. Se vuoi, stampa ora.","ok");
}

async function copyOutput(){
  const k=document.getElementById("outKitchen").textContent||"";
  const r=document.getElementById("outReceipt").textContent||"";
  let out="";
  if(SETTINGS.printMode==="both") out=k+"\n\n"+r;
  else if(SETTINGS.printMode==="kitchen") out=k;
  else out=r;
  if(!out.trim()||out.trim()==="‚Äî"){ setStatus("Genera prima la comanda.","warn"); return; }
  try{ await navigator.clipboard.writeText(out); setStatus("Copiato.","ok"); }catch{ setStatus("Copia non disponibile.","warn"); }
}
function printNow(){
  const kitchen=document.getElementById("outKitchen");
  const receipt=document.getElementById("outReceipt");
  const prevK=kitchen.style.display, prevR=receipt.style.display;

  if(SETTINGS.printMode==="kitchen"){ kitchen.style.display="block"; receipt.style.display="none"; }
  else if(SETTINGS.printMode==="receipt"){ kitchen.style.display="none"; receipt.style.display="block"; }
  else { kitchen.style.display="block"; receipt.style.display="block"; }

  window.print();
  kitchen.style.display=prevK; receipt.style.display=prevR;
}
function closeDay(){
  document.getElementById("input").value="";
  DRAFT=null; LAST_PARSED=null;
  document.getElementById("editor").innerHTML="";
  document.getElementById("outKitchen").textContent="‚Äî";
  document.getElementById("outReceipt").textContent="‚Äî";
  document.getElementById("outDebug").textContent="‚Äî";
  document.getElementById("totalMini").textContent="Totale: ‚Äî";
  localStorage.setItem(LS.lastDay, todayKey());
  setStatus("Chiusura serale: pulito.","ok");
}

/* ===================== TABS ===================== */
function activateTab(view){
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(t=>{
    if(t.getAttribute("data-view")===view) t.classList.add("active");
  });

  document.getElementById("viewConfirm").style.display = (view==="confirm")?"block":"none";
  document.getElementById("outKitchen").style.display = (view==="kitchen")?"block":"none";
  document.getElementById("outReceipt").style.display = (view==="receipt")?"block":"none";
  document.getElementById("outDebug").style.display = (view==="debug")?"block":"none";
}

/* ===================== SETTINGS UI ===================== */
function setCatalogTextarea(){ document.getElementById("catalog").value = JSON.stringify(CATALOG,null,2); }
function refreshOptions(){
  const psel=document.getElementById("fallbackBasePizza");
  psel.innerHTML="";
  for(const k of Object.keys(CATALOG.pizzas||{}).sort()){
    const o=document.createElement("option"); o.value=k; o.textContent=k; psel.appendChild(o);
  }
  if(!SETTINGS.fallbackBasePizza || !(SETTINGS.fallbackBasePizza in (CATALOG.pizzas||{}))){
    SETTINGS.fallbackBasePizza = ("margherita" in (CATALOG.pizzas||{})) ? "margherita" : (Object.keys(CATALOG.pizzas||{})[0]||"margherita");
  }
  psel.value=SETTINGS.fallbackBasePizza;

  const ssel=document.getElementById("fallbackSize");
  ssel.innerHTML="";
  for(const k of Object.keys(CATALOG.sizes||{}).sort()){
    const o=document.createElement("option"); o.value=k; o.textContent=k; ssel.appendChild(o);
  }
  if(!SETTINGS.fallbackSize || !(SETTINGS.fallbackSize in (CATALOG.sizes||{}))){
    SETTINGS.fallbackSize = ("normale" in (CATALOG.sizes||{})) ? "normale" : (Object.keys(CATALOG.sizes||{})[0]||"normale");
  }
  ssel.value=SETTINGS.fallbackSize;

  document.getElementById("printMode").value=SETTINGS.printMode;
  document.getElementById("deliveryFee").value=money(Number(SETTINGS.deliveryFee||0));
  document.getElementById("printModeMini").textContent = `Stampa: ${SETTINGS.printMode==="both"?"entrambe":SETTINGS.printMode==="kitchen"?"solo cucina":"solo ricevuta"}`;
}
function applySettingsFromUI(){
  SETTINGS.printMode=document.getElementById("printMode").value;
  SETTINGS.deliveryFee=Number(String(document.getElementById("deliveryFee").value).replace(",",".")||0);
  SETTINGS.fallbackBasePizza=document.getElementById("fallbackBasePizza").value || SETTINGS.fallbackBasePizza;
  SETTINGS.fallbackSize=document.getElementById("fallbackSize").value || SETTINGS.fallbackSize;
  saveSettings(SETTINGS);
  refreshOptions();
  // if there is a draft, refresh totals (delivery fee may change)
  previewTotals();
}

/* ===================== BUTTONS / EVENTS ===================== */
document.getElementById("parse").addEventListener("click", analyze);
document.getElementById("confirm").addEventListener("click", confirmAndGenerate);
document.getElementById("copy").addEventListener("click", copyOutput);
document.getElementById("print").addEventListener("click", printNow);
document.getElementById("closeDay").addEventListener("click", closeDay);

document.getElementById("fTime").addEventListener("change", ()=>{ if(DRAFT){ pullFormToDraft(); previewTotals(); }});
document.getElementById("fName").addEventListener("change", ()=>{ if(DRAFT){ pullFormToDraft(); }});
document.getElementById("fPhone").addEventListener("change", ()=>{ if(DRAFT){ pullFormToDraft(); }});
document.getElementById("fAddress").addEventListener("change", ()=>{ if(DRAFT){ pullFormToDraft(); }});
document.getElementById("fNotes").addEventListener("change", ()=>{ if(DRAFT){ pullFormToDraft(); }});

document.getElementById("chipDelivery").addEventListener("click", ()=>{
  if(!DRAFT) return;
  DRAFT.mode = "CONSEGNA";
  setChipMode(DRAFT.mode);
  previewTotals();
});
document.getElementById("chipPickup").addEventListener("click", ()=>{
  if(!DRAFT) return;
  DRAFT.mode = "RITIRO";
  setChipMode(DRAFT.mode);
  previewTotals();
});

document.getElementById("addPizza").addEventListener("click", ()=>{
  if(!DRAFT) DRAFT={mode:"",desiredTime:"",name:"",phone:"",address:"",notes:"",items:[]};
  DRAFT.items.push({
    kind:"pizza", qty:1, pizzaKey:SETTINGS.fallbackBasePizza, doughKey:"classico",
    sizeKey:SETTINGS.fallbackSize||"normale", formatKey:"tonda",
    extrasFull:[], removals:[], gusti:0, gustiNotes:[], freeText:""
  });
  renderEditor(); previewTotals();
});
document.getElementById("addDrink").addEventListener("click", ()=>{
  if(!DRAFT) DRAFT={mode:"",desiredTime:"",name:"",phone:"",address:"",notes:"",items:[]};
  DRAFT.items.push({ kind:"drink", qty:1, label:"coca cola 33" });
  renderEditor(); previewTotals();
});

for(const t of document.querySelectorAll(".tab")){
  t.addEventListener("click",()=>activateTab(t.getAttribute("data-view")));
}

/* modal */
const modal=document.getElementById("modal");
document.getElementById("openSettings").addEventListener("click",()=>modal.classList.add("open"));
document.getElementById("closeSettings").addEventListener("click",()=>modal.classList.remove("open"));
modal.addEventListener("click",(e)=>{ if(e.target===modal) modal.classList.remove("open"); });

/* catalog */
document.getElementById("saveCatalog").addEventListener("click",()=>{
  try{
    const obj=JSON.parse(document.getElementById("catalog").value);
    obj.pizzas ||= {}; obj.drinks ||= {}; obj.extras ||= {}; obj.doughs ||= {}; obj.sizes ||= {}; obj.formats ||= {}; obj.aliases ||= {};
    CATALOG=obj; saveCatalog(CATALOG);
    setCatStatus("Catalogo salvato.","ok");
    refreshOptions();
    // refresh editor selects
    renderEditor(); previewTotals();
  }catch{ setCatStatus("Errore JSON.","warn"); }
});
document.getElementById("resetCatalog").addEventListener("click",()=>{
  CATALOG=structuredClone(SAMPLE_CATALOG); saveCatalog(CATALOG);
  setCatalogTextarea();
  setCatStatus("Ripristinato esempio.","ok");
  refreshOptions();
  renderEditor(); previewTotals();
});
document.getElementById("exportCatalog").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(JSON.stringify(CATALOG,null,2)); setCatStatus("Export copiato.","ok"); }
  catch{ setCatStatus("Export non riuscito.","warn"); }
});
document.getElementById("importCatalog").addEventListener("click",()=>{
  const pasted=prompt("Incolla JSON catalogo:");
  if(!pasted) return;
  try{
    CATALOG=JSON.parse(pasted); saveCatalog(CATALOG);
    setCatalogTextarea();
    setCatStatus("Import OK.","ok");
    refreshOptions();
    renderEditor(); previewTotals();
  }catch{ setCatStatus("Import fallito.","warn"); }
});

/* settings */
document.getElementById("printMode").addEventListener("change",applySettingsFromUI);
document.getElementById("deliveryFee").addEventListener("change",applySettingsFromUI);
document.getElementById("fallbackBasePizza").addEventListener("change",applySettingsFromUI);
document.getElementById("fallbackSize").addEventListener("change",applySettingsFromUI);

/* init */
setCatalogTextarea();
refreshOptions();
ensureDaily();
activateTab("confirm");
</script>
</body>
</html>
